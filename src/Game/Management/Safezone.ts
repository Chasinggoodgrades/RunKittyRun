import { Constants } from 'src/AutoGenerated/Constants'
import { Logger } from 'src/Events/Logger/Logger'
import { FinalSafezone } from 'src/Events/VictoryZone/FinalSafezone'
import { CurrentGameMode } from 'src/Gamemodes/CurrentGameMode'
import { GameMode } from 'src/Gamemodes/GameModeEnum'
import { Globals } from 'src/Global/Globals'
import { RegionList } from 'src/Global/RegionList'
import { Resources } from 'src/Init/Resources'
import { ChainedTogether } from 'src/Rewards/Challenges/ChainedTogether'
import { DeathlessChallenges } from 'src/Rewards/Challenges/DeathlessChallenges'
import { TeamDeathless } from 'src/Rewards/Challenges/TeamDeathless'
import { CameraUtil } from 'src/Utility/CameraUtil'
import { FilterList } from 'src/Utility/FilterList'
import { Utility } from 'src/Utility/Utility'
import { getTriggerUnit } from 'src/Utility/w3tsUtils'
import { MapPlayer, Rectangle, Trigger, Unit } from 'w3ts'
import { Kitty } from '../Entities/Kitty/Kitty'
import { Wolf } from '../Entities/Wolf'
import { FangOfShadows } from '../Items/Relics/RelicTypes/FangOfShadows'
import { WolfLaneHider } from '../WolfLaneHider/WolfLaneHider'

export class Safezone {
    public Region: region
    private triggerHandle: Trigger
    public ID = 0
    public Rectangle!: Rectangle
    public AwardedPlayers: MapPlayer[] = []

    public constructor(id: number, region: region) {
        this.ID = id
        this.Region = region
        this.triggerHandle = Trigger.create()!
    }

    public static Initialize = () => {
        let count = 0
        for (const safeZone of RegionList.SafeZones) {
            const safezone = new Safezone(count, safeZone.region())
            Globals.SAFE_ZONES.push(safezone)
            safezone.EnterSafezoneEvents()
            safezone.Rectangle = safeZone
            count++
        }
        FinalSafezone.Initialize()
    }

    private EnterSafezoneEvents = () => {
        this.triggerHandle.registerEnterRegion(this.Region, FilterList.KittyFilterOrShadow)
        this.triggerHandle.addAction(() => this.EnterSafezoneActions())
    }

    private EnterSafezoneActions = () => {
        try {
            const unit = getTriggerUnit()
            if (!unit) return
            if (Safezone.WolfEntersSafezoneActions(unit)) return
            if (unit.typeId === Constants.UNIT_SHADOWKITTY_RELIC_SUMMON) {
                WolfLaneHider.ShadowKittyLaneAdd(this.ID)
                return
            }
            const player = unit.owner
            const kitty = Globals.ALL_KITTIES.get(player)!
            this.SafezoneAdditions(kitty)
            kitty.CurrentSafeZone = this.ID
            if (Globals.GAME_ACTIVE) WolfLaneHider.LanesHider()
            TeamDeathless.ReachedSafezone(unit, this)
            if (this.AwardedPlayers.includes(player) || this.ID === 0) return
            ChainedTogether.ReachedSafezone(kitty)
            Utility.GiveGoldFloatingText(Resources.SafezoneGold, unit)
            unit.experience += Resources.SafezoneExperience
            this.AwardedPlayers.push(player)
            DeathlessChallenges.DeathlessCheck(kitty)
        } catch (e) {
            Logger.Warning(`Error in EnterSafezoneActions: ${e}`)
        }
    }

    /// <summary>
    /// Runs if the players current safezone isn't the same as their previously touched safezone.
    /// </summary>
    private SafezoneAdditions = (kitty: Kitty) => {
        const player = kitty.Player

        if (kitty.CurrentSafeZone === this.ID) return

        CameraUtil.UpdateKomotoCam(player, this.ID)

        if (CurrentGameMode.active !== GameMode.Standard) return

        for (let i = 0; i < kitty.Relics.length; i++) {
            const relic = kitty.Relics[i]
            if (relic instanceof FangOfShadows) {
                const fangOfShadows: FangOfShadows = relic
                fangOfShadows.ReduceCooldownAtSafezone(kitty.Unit)
                break
            }
        }
    }

    /// <summary>
    /// Resets progress zones and reached safezones to initial state.
    /// </summary>
    public static ResetPlayerSafezones = () => {
        for (const [_, kitty] of Globals.ALL_KITTIES) {
            kitty.CurrentSafeZone = 0
            kitty.ProgressZone = 0
        }
        for (const safezone of Globals.SAFE_ZONES) {
            safezone.AwardedPlayers = []
        }
    }

    /// <summary>
    /// If the unit type is a wolf, it'll tell the wolf to MOVE back to its wolf area.
    /// Primary purpose is to make it so "wander" wolves dont get into the safezones.
    /// </summary>
    /// <param name="unit"></param>
    /// <returns>bool [true/false] if unit type is infact a wolf</returns>
    public static WolfEntersSafezoneActions = (unit: Unit) => {
        if (unit.typeId !== Wolf.WOLF_MODEL) return false
        const wolf = Globals.ALL_WOLVES.get(unit)
        if (!wolf) return false
        wolf.WolfMove(true) // forced move
        return true
    }
}

import { Constants } from 'src/AutoGenerated/Constants'
import { Logger } from 'src/Events/Logger/Logger'
import { CurrentGameMode } from 'src/Gamemodes/CurrentGameMode'
import { GameMode } from 'src/Gamemodes/GameModeEnum'
import { Globals } from 'src/Global/Globals'
import { getFilterUnit } from 'src/Utility/w3tsUtils'
import { Group, Item, Trigger, Unit } from 'w3ts'

export class Shops {
    private static KittyVendors: Group
    private static KittyVendorsList: Unit[]
    private static KittyVendorItemList: number[]
    private static VendorsItemList: Map<Unit, VendorItem[]>
    private static trigger: Trigger

    public static Initialize = () => {
        Shops.KittyVendors = Group.create()!
        Shops.trigger = Trigger.create()!
        Shops.KittyVendorsList = []
        Shops.KittyVendorItemList = []
        Shops.VendorsItemList = new Map()
        Shops.CollectAllVendors()
        Shops.SetupAllItems()
        Shops.ApplyItemListToVendor()
    }

    private static SetupAllItems = () => {
        Shops.ConstantItems()

        if (CurrentGameMode.active !== GameMode.Standard) return

        Shops.StandardModeItems()
    }

    private static ApplyItemListToVendor = () => {
        for (const vendor of Shops.KittyVendorsList) Shops.AddRegularItemsToVendor(vendor, Shops.KittyVendorItemList)
    }

    private static RefreshItemsOnVendor = (vendor: Unit) => {
        const vendorItems = Shops.VendorsItemList.get(vendor)!
        for (const item of vendorItems) {
            vendor.addItemToStock(item.Item, item.Stock, item.Stock)
        }
    }

    private static AddRegularItemsToVendor = (vendor: Unit, items: number[]) => {
        const vendorList: VendorItem[] = []
        for (const item of items) {
            vendorList.push(new VendorItem(vendor, item, 2, 60))
        }
        Shops.VendorsItemList.set(vendor, vendorList)
        Shops.RefreshItemsOnVendor(vendor)
    }

    /// <summary>
    /// No longer has use. Constant items will just remain in the editor.
    /// </summary>
    private static ConstantItems = () => {
        // Items for all modes
        /*        KittyVendorItemList.push(Constants.ITEM_ADRENALINE_POTION);
                KittyVendorItemList.push(Constants.ITEM_HEALING_WATER);
                KittyVendorItemList.push(Constants.ITEM_PEGASUS_BOOTS);
                KittyVendorItemList.push(Constants.ITEM_ENERGY_STONE);
                KittyVendorItemList.push(Constants.ITEM_MEDITATION_CLOAK);
                KittyVendorItemList.push(Constants.ITEM_RITUAL_MASK);
                KittyVendorItemList.push(Constants.ITEM_ELIXIR);
                KittyVendorItemList.push(Constants.ITEM_ANCIENT_TOME);*/
    }

    /// <summary>
    /// These items can go to the misc shop if we want space for constant items.
    /// </summary>
    private static StandardModeItems = () => {
        // Kitty Vendor
        Shops.KittyVendorItemList.push(Constants.ITEM_EASTER_EGG_EMPTY_VIAL)
        Shops.KittyVendorItemList.push(Constants.ITEM_EASTER_EGG_URN_OF_A_BROKEN_SOUL)
        Shops.KittyVendorItemList.push(Constants.ITEM_EASTER_EGG_CAT_FIGURINE)
    }

    private static CollectAllVendors = () => {
        Shops.KittyVendors.enumUnitsInRect(
            Globals.WORLD_BOUNDS,
            Condition(() => getFilterUnit().typeId === Constants.UNIT_KITTY_VENDOR)
        )

        // Shops.KittyVendors.getUnits() doesn't return any results for some fkin reason, so just doin it manually.
        while (Shops.KittyVendors.size > 0) {
            const vendor = Shops.KittyVendors.first!
            Shops.KittyVendors.removeUnit(vendor)
            Shops.KittyVendorsList.push(vendor)
        }
        Shops.RegisterVendorSellingEvent()
    }

    private static RegisterVendorSellingEvent = () => {
        // Registers all Kitty Vendors and Panda Vendor for on sell event.
        for (const vendor of Shops.KittyVendorsList) Shops.trigger.registerUnitEvent(vendor, EVENT_UNIT_SELL_ITEM)
        Shops.trigger.addAction(Shops.OnVendorSell)
    }

    private static OnVendorSell = () => {
        try {
            const item = Item.fromHandle(GetSoldItem())!
            const vendor = Unit.fromHandle(GetSellingUnit())!
            const u = GetBuyingUnit()
            if (!u) return
            const player = GetOwningPlayer(u)
            const itemID = item.typeId

            const vendorItems = Shops.VendorsItemList.get(vendor)!
            const vendorItem = vendorItems.find(vi => vi.Item === itemID)
            if (!vendorItem) return

            Shops.RefreshItemsOnVendor(vendor)
        } catch (e) {
            Logger.Warning(`Error in OnVendorSell: ${e}`)
        }
    }
}

export class VendorItem {
    public Vendor: Unit
    public Item = 0
    public Stock = 0
    public RestockTime = 0

    public constructor(vendor: Unit, item: number, stock: number, restockTime: number) {
        this.Vendor = vendor
        this.Item = item
        this.Stock = stock
        this.RestockTime = restockTime // May implement later? unsure.
    }
}

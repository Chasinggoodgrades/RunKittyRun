import { Constants } from 'src/AutoGenerated/Constants'
import { Logger } from 'src/Events/Logger/Logger'
import { Utility } from 'src/Utility/Utility'
import { getManipulatedItem, getTriggerUnit } from 'src/Utility/w3tsUtils'
import { Trigger } from 'w3ts'

export class ItemStacker {
    private static PickupTrigger: Trigger
    private static StackableItemIDs: number[]

    public static Initialize() {
        ItemStacker.RegisterItemList()
        ItemStacker.RegisterEvents()
    }

    /// <summary>
    /// List of all the stackable items... Easy way to add more if needed.
    /// </summary>
    /// <returns></returns>
    private static RegisterItemList(): number[] {
        if (ItemStacker.StackableItemIDs !== null) return ItemStacker.StackableItemIDs
        ItemStacker.StackableItemIDs = [
            Constants.ITEM_ADRENALINE_POTION,
            Constants.ITEM_HEALING_WATER,
            Constants.ITEM_ELIXIR,
            Constants.ITEM_ANTI_BLOCK_WAND,
        ]
        return ItemStacker.StackableItemIDs
    }

    private static RegisterEvents(): Trigger {
        const PickupTrigger = Trigger.create()!
        PickupTrigger.registerAnyUnitEvent(EVENT_PLAYER_UNIT_PICKUP_ITEM)
        PickupTrigger.addAction(() => ItemStacker.StackActions())
        return PickupTrigger
    }

    private static StackActions() {
        try {
            const item = getManipulatedItem()
            const itemID = item.typeId
            if (!ItemStacker.StackableItem(itemID)) return
            const unit = getTriggerUnit()
            const heldItem = Utility.UnitGetItem(unit, itemID)
            item.setOwner(unit.owner, false)
            if (heldItem === item) return
            if (!heldItem) return
            const itemCharges = item.charges
            if (itemCharges > 1) heldItem.charges += itemCharges
            else heldItem.charges += 1
            item.destroy()
        } catch (e: any) {
            Logger.Critical(e)
            throw e
        }
    }

    private static StackableItem(itemID: number) {
        return ItemStacker.StackableItemIDs.includes(itemID)
    }
}

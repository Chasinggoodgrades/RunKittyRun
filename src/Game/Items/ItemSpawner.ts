import { Constants } from 'src/AutoGenerated/Constants'
import { Logger } from 'src/Events/Logger/Logger'
import { Gamemode } from 'src/Gamemodes/Gamemode'
import { GameMode } from 'src/Gamemodes/GameModeEnum'
import { RegionList } from 'src/Global/RegionList'
import { KibbleEvent } from 'src/Rewards/EasterEggs/KibbleEvent'
import { MemoryHandler } from 'src/Utility/MemoryHandler/MemoryHandler'
import { Item, Timer } from 'w3ts'
import { ItemSpatialGrid } from './ItemSpatialGrid'
import { Kibble } from './Kibble'

export class ItemSpawner {
    public static TrackKibbles: Kibble[]
    public static TrackItems: Item[]

    private static SpawnableItems: number[]
    private static SpawnTimer = Timer.create()
    private static ITEM_SPAWN_INTERVAL: number = 45.0
    public static NUMBER_OF_ITEMS: number = 15

    public static Initialize() {
        if (Gamemode.CurrentGameMode !== GameMode.Standard) return
        this.SpawnableItems = this.StandardItems()
        this.TrackItems = []
        this.TrackKibbles = []
        this.RegisterEvent()
        this.SpawnItems()
    }

    private static RegisterEvent() {
        this.SpawnTimer.start(this.ITEM_SPAWN_INTERVAL, true, this.SpawnItems)
    }

    private static SpawnItems() {
        try {
            this.RemoveSpawnedItems()
            for (let i = 0; i < this.NUMBER_OF_ITEMS; i++) {
                this.SpawnRegularItems()
            }
            this.SpawnKibble(this.NUMBER_OF_ITEMS)
        } catch (e: any) {
            Logger.Critical('ItemSpawner: SpawnItems: {e.Message}')
        }
    }

    private static RemoveSpawnedItems() {
        for (let i: number = 0; i < this.TrackItems.length; i++) {
            let item = this.TrackItems[i]
            ItemSpatialGrid.UnregisterItem(item)
            if (item.isOwned()) continue
            item.destroy()
        }

        this.TrackItems = []

        if (KibbleEvent.IsEventActive()) return

        for (let i: number = 0; i < this.TrackKibbles.length; i++) {
            let kibble = this.TrackKibbles[i]
            ItemSpatialGrid.UnregisterKibble(kibble)
            if (kibble.Item === null) continue // Already been __destroyed.
            kibble.dispose()
        }

        this.TrackKibbles = []
    }

    public static SpawnKibble(numberOfItems: number) {
        if (Gamemode.CurrentGameMode !== GameMode.Standard) return
        if (!Kibble.SpawningKibble) return
        if (KibbleEvent.IsEventActive()) return

        for (let i: number = 0; i < numberOfItems; i++) {
            let kibble = MemoryHandler.getEmptyObject<Kibble>()
            kibble.SpawnKibble()
            this.TrackKibbles.push(kibble)
        }
    }

    private static SpawnRegularItems() {
        let random = GetRandomInt(0, this.SpawnableItems.length - 1)
        let item = this.SpawnableItems[random]
        let regionNumber = GetRandomInt(0, RegionList.WolfRegions.length - 1)
        let region = RegionList.WolfRegions[regionNumber]
        let x = GetRandomReal(region.minX, region.maxX)
        let y = GetRandomReal(region.minY, region.maxY)
        let i = Item.create(item, x, y)!
        this.TrackItems.push(i)
        ItemSpatialGrid.RegisterItem(i)
    }

    private static StandardItems() {
        return [Constants.ITEM_ADRENALINE_POTION, Constants.ITEM_HEALING_WATER, Constants.ITEM_ELIXIR]
    }
}

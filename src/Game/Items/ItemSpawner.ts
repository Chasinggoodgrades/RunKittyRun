import { Constants } from 'src/AutoGenerated/Constants'
import { Logger } from 'src/Events/Logger/Logger'
import { CurrentGameMode } from 'src/Gamemodes/CurrentGameMode'
import { GameMode } from 'src/Gamemodes/GameModeEnum'
import { RegionList } from 'src/Global/RegionList'
import { KibbleEvent } from 'src/Rewards/EasterEggs/KibbleEvent'
import { MemoryHandler } from 'src/Utility/MemoryHandler/MemoryHandler'
import { Item, Timer } from 'w3ts'
import { ItemSpatialGrid } from './ItemSpatialGrid'
import { ItemSpawnerTrackKibbles } from './ItemSpawnerTrackKibbles'
import { Kibble } from './Kibble'

export class ItemSpawner {
    public static TrackItems: Item[]

    private static SpawnableItems: number[]
    private static SpawnTimer = Timer.create()
    private static ITEM_SPAWN_INTERVAL = 45.0
    public static NUMBER_OF_ITEMS = 15

    public static Initialize = () => {
        if (CurrentGameMode.active !== GameMode.Standard) return
        ItemSpawner.SpawnableItems = ItemSpawner.StandardItems()
        ItemSpawner.TrackItems = []
        ItemSpawnerTrackKibbles.active = []
        ItemSpawner.RegisterEvent()
        ItemSpawner.SpawnItems()
    }

    private static RegisterEvent = () => {
        ItemSpawner.SpawnTimer.start(ItemSpawner.ITEM_SPAWN_INTERVAL, true, () => ItemSpawner.SpawnItems())
    }

    private static SpawnItems = () => {
        try {
            ItemSpawner.RemoveSpawnedItems()
            for (let i = 0; i < ItemSpawner.NUMBER_OF_ITEMS; i++) {
                ItemSpawner.SpawnRegularItems()
            }
            ItemSpawner.SpawnKibble(ItemSpawner.NUMBER_OF_ITEMS)
        } catch (e) {
            Logger.Critical(`ItemSpawner SpawnItems: ${e}`)
        }
    }

    private static RemoveSpawnedItems = () => {
        for (let i = 0; i < ItemSpawner.TrackItems.length; i++) {
            const item = ItemSpawner.TrackItems[i]
            ItemSpatialGrid.UnregisterItem(item)
            if (item.isOwned()) continue
            item.destroy()
        }

        ItemSpawner.TrackItems = []

        if (KibbleEvent.IsEventActive()) return

        for (let i = 0; i < ItemSpawnerTrackKibbles.active.length; i++) {
            const kibble = ItemSpawnerTrackKibbles.active[i]
            ItemSpatialGrid.UnregisterKibble(kibble)
            if (kibble.Item === null) continue // Already been __destroyed.
            kibble.dispose()
        }

        ItemSpawnerTrackKibbles.active = []
    }

    public static SpawnKibble(numberOfItems: number) {
        if (CurrentGameMode.active !== GameMode.Standard) return
        if (!Kibble.SpawningKibble) return
        if (KibbleEvent.IsEventActive()) return

        for (let i = 0; i < numberOfItems; i++) {
            const kibble = MemoryHandler.getEmptyClass<Kibble>(new Kibble())
            kibble.SpawnKibble()
            ItemSpawnerTrackKibbles.active.push(kibble)
        }
    }

    private static SpawnRegularItems = () => {
        const random = GetRandomInt(0, ItemSpawner.SpawnableItems.length - 1)
        const item = ItemSpawner.SpawnableItems[random]
        const regionNumber = GetRandomInt(0, RegionList.WolfRegions.length - 1)
        const region = RegionList.WolfRegions[regionNumber]
        const x = GetRandomReal(region.minX, region.maxX)
        const y = GetRandomReal(region.minY, region.maxY)
        const i = Item.create(item, x, y)!
        ItemSpawner.TrackItems.push(i)
        ItemSpatialGrid.RegisterItem(i)
    }

    private static StandardItems = () => {
        return [Constants.ITEM_ADRENALINE_POTION, Constants.ITEM_HEALING_WATER, Constants.ITEM_ELIXIR]
    }
}

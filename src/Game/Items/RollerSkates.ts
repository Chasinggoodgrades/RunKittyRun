import { Constants } from 'src/AutoGenerated/Constants'
import { CurrentGameMode } from 'src/Gamemodes/CurrentGameMode'
import { GameMode } from 'src/Gamemodes/GameModeEnum'
import { Globals } from 'src/Global/Globals'
import { Colors } from 'src/Utility/Colors/Colors'
import { getManipulatedItem, getTriggerUnit } from 'src/Utility/w3tsUtils'
import { Item, MapPlayer, Trigger } from 'w3ts'

export class RollerSkates {
    private static OnUseTrigger: Trigger
    private static RollerSkaters: MapPlayer[]

    public static Initialize = () => {
        RollerSkates.RollerSkaters = []
        RollerSkates.OnUseTrigger = Trigger.create()!
        RollerSkates.OnUseTrigger.registerAnyUnitEvent(EVENT_PLAYER_UNIT_USE_ITEM)
        RollerSkates.OnUseTrigger.addCondition(() => getManipulatedItem().typeId === Constants.ITEM_PEGASUS_BOOTS)
        RollerSkates.OnUseTrigger.addAction(RollerSkates.SwitchingBoots)
    }

    private static SwitchingBoots = () => {
        const unit = getTriggerUnit()
        const item = getManipulatedItem()
        const slider = Globals.ALL_KITTIES.get(unit.owner)!.Slider

        if (CurrentGameMode.active !== GameMode.Standard) {
            unit.owner.DisplayTimedTextTo(
                3.0,
                `${Colors.COLOR_RED}Roller Skates are only available in Standard Mode${Colors.COLOR_RESET}`
            )
            return
        }

        if (RollerSkates.RollerSkaters.includes(unit.owner)) {
            RollerSkates.SetPegasusBoots(item)
            slider.StopSlider()
            RollerSkates.RollerSkaters.splice(RollerSkates.RollerSkaters.indexOf(unit.owner), 1)
            unit.owner.DisplayTimedTextTo(3.0, `${Colors.COLOR_YELLOW}Roller Skates Deactivated${Colors.COLOR_RESET}`)
        } else {
            RollerSkates.SetRollerSkates(item)
            if (slider.IsEnabled()) slider.ResumeSlider(false)
            else slider.StartSlider()
            RollerSkates.RollerSkaters.push(unit.owner)
            unit.owner.DisplayTimedTextTo(3.0, `${Colors.COLOR_YELLOW}Roller Skates Activated${Colors.COLOR_RESET}`)
        }
    }

    private static SetPegasusBoots(item: Item) {
        item.name = 'Pegasus Boots'
    }

    private static SetRollerSkates(item: Item) {
        item.name = `${Colors.COLOR_ORANGE}[Roller Skates]${Colors.COLOR_RESET} Pegasus Boots`
    }
}

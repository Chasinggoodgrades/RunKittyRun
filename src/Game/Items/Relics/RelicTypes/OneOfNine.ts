import { Constants } from 'src/AutoGenerated/Constants'
import { Kitty } from 'src/Game/Entities/Kitty/Kitty'
import { ProtectionOfAncients } from 'src/Game/ProtectionOfAncients'
import { Globals } from 'src/Global/Globals'
import { Utility } from 'src/Utility/Utility'
import { MapPlayer, Unit } from 'w3ts'
import { Upgrades } from 'war3-objectdata-th'
import { PlayerUpgrades } from '../PlayerUpgrades'
import { Relic } from '../Relic'
import { RelicUpgrade } from '../RelicUpgrade'

export class OneOfNine extends Relic {
    public RelicItemID: number = Constants.ITEM_ONE_OF_NINE
    public RelicAbilityID: number = Constants.ABILITY_PROTECTION_OF_THE_ANCIENTS_WITH_RELIC

    private PreviousAbilityID: number = Constants.ABILITY_PROTECTION_OF_THE_ANCIENTS
    private RelicCost: number = 650
    private static IconPath: string = 'war3mapImported\\BTNSpell_Holy_BlessingOfProtection.blp'

    public constructor() {
        super()
        this.name = '|cffff4500One of Nine|r'
        this.Description =
            'Autocasts Protection of the Ancients if it is available. {Colors.COLOR_LIGHTBLUE}(Passive)|r'
        this.RelicAbilityID = Constants.ABILITY_PROTECTION_OF_THE_ANCIENTS_WITH_RELIC
        this.RelicItemID = Constants.ITEM_ONE_OF_NINE
        this.RelicCost = 650

        this.Upgrades.push(
            new RelicUpgrade(
                0,
                'Cooldown of your ultimate is reduced by an additional 3 seconds per upgrade level.',
                15,
                800
            )
        )
        this.Upgrades.push(new RelicUpgrade(1, 'Your ultimate no longer costs mana.', 20, 1000))
    }
    public override ApplyEffect(Unit: Unit) {
        let player: MapPlayer = Unit.owner
        let cooldown: number = GetOneOfNineCooldown(player)
        Unit.removeAbility(PreviousAbilityID)
        Unit.addAbility(RelicAbilityID)
        let abilityLevel: number = ProtectionOfAncients.SetProtectionOfAncientsLevel(Unit)
        Unit(RelicAbilityID, cooldown)
        this.RemoveManaCost(Unit, abilityLevel)
    }

    public override RemoveEffect(Unit: Unit) {
        let player: MapPlayer = Unit.owner
        let cooldown: number = GetOneOfNineCooldown(player)
        Unit.removeAbility(RelicAbilityID)
        Unit.addAbility(PreviousAbilityID)
        ProtectionOfAncients.SetProtectionOfAncientsLevel(Unit)
        BlzStartUnitAbilityCooldown(Unit.handle, this.PreviousAbilityID, cooldown)
    }

    public static GetOneOfNineCooldown(Player: MapPlayer) {
        let kitty: Unit = Globals.ALL_KITTIES.get(Player)!.Unit
        let noRelic = Constants.ABILITY_PROTECTION_OF_THE_ANCIENTS
        let relic = Constants.ABILITY_PROTECTION_OF_THE_ANCIENTS_WITH_RELIC
        let reduction = GetOneOfNineReduction(Player)

        // remaining cooldown depending on relic or no relic
        let cooldown: number =
            kitty.getAbilityCooldownRemaining(noRelic) > 0.0
                ? kitty.getAbilityCooldownRemaining(noRelic)
                : kitty.getAbilityCooldownRemaining(relic)

        cooldown -= reduction

        return Math.max(0.0, cooldown) // gotta make sure its not negative
    }

    public static GetOneOfNineReduction(Player: MapPlayer) {
        return PlayerUpgrades.GetPlayerUpgrades(Player).GetUpgradeLevel(typeof OneOfNine) * 3.0
    }

    /// <summary>
    /// Upgrade Level 2: Removes mana cost from the ability.
    /// </summary>
    /// <param name="Unit"></param>
    /// <param name="abilityLevel"></param>
    private RemoveManaCost(Unit: Unit, abilityLevel: number) {
        let upgradeLevel = PlayerUpgrades.GetPlayerUpgrades(Unit.owner).GetUpgradeLevel(GetType())
        if (upgradeLevel < 2) return
        Unit.getAbility(RelicAbilityID)
        Unit.setAbilityManaCost(RelicAbilityID, abilityLevel - 1, 0)
    }

    public static OneOfNineEffect(kitty: Kitty) {
        if (!Utility.UnitHasItem(kitty.Unit, Constants.ITEM_ONE_OF_NINE)) return false
        if (kitty.Unit.getAbilityCooldownRemaining(Constants.ABILITY_PROTECTION_OF_THE_ANCIENTS_WITH_RELIC) <= 0.0) {
            IssueImmediateOrder(kitty.Unit, 'divineshield')
            return true
        }
        return false
    }
}

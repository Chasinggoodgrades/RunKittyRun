import { Constants } from 'src/AutoGenerated/Constants'
import { Logger } from 'src/Events/Logger/Logger'
import { NamedWolves } from 'src/Game/Entities/NamedWolves'
import { Globals } from 'src/Global/Globals'
import { Challenges } from 'src/Rewards/Challenges/Challenges'
import { Colors } from 'src/Utility/Colors/Colors'
import { FilterList } from 'src/Utility/FilterList'
import { GC } from 'src/Utility/GC'
import { AchesTimers, createAchesTimer } from 'src/Utility/MemoryHandler/AchesTimers'
import { MemoryHandler } from 'src/Utility/MemoryHandler/MemoryHandler'
import { Utility } from 'src/Utility/Utility'
import { Effect, Group, MapPlayer, Trigger, Unit } from 'w3ts'
import { PlayerUpgrades } from '../PlayerUpgrades'
import { Relic } from '../Relic'
import { RelicUpgrade } from '../RelicUpgrade'
import { RelicUtil } from '../RelicUtil'

export class FrostbiteRing extends Relic {
    public static RelicItemID = Constants.ITEM_FROSTBITE_RING
    public static SLOW_DURATION = 5.0
    public static FROSTBITE_FREEZE_RING_EFFECT = 'war3mapImported\\FreezingBreathTargetArt.mdl'
    public static FROSTBITE_SLOW_TARGET_EFFECT = 'Abilities\\Spells\\Undead\\FrostArmor\\FrostArmorTarget.mdl'
    public static RelicAbilityID = Constants.ABILITY_RING_OF_FROSTBITE_RING_ULTIMATE
    public static FrozenWolves: Map<Unit, FrozenWolf> = new Map()

    private static RelicCost = 650
    private static FROSTBITE_RING_RADIUS = 450.0
    private static DEFAULT_FREEZE_DURATION = 5.0
    private static UPGRADE_COOLDOWN_REDUCTION = 15.0
    private FREEZE_DURATION = 5.0
    private static IconPath = 'ReplaceableTextures\\CommandButtons\\BTNFrostRing.blp'
    private Owner: MapPlayer | undefined
    private Trigger: Trigger | undefined
    private FreezeGroup: Group | undefined

    public constructor() {
        super(
            `${Colors.COLOR_BLUE}Frostbite Ring`,
            `Freezes wolves in place for ${Colors.COLOR_CYAN}${FrostbiteRing.DEFAULT_FREEZE_DURATION} seconds|r ${Colors.COLOR_ORANGE}(Active)|r ${Colors.COLOR_LIGHTBLUE}(1 min)|r`,
            FrostbiteRing.RelicAbilityID,
            FrostbiteRing.RelicItemID,
            FrostbiteRing.RelicCost,
            FrostbiteRing.IconPath
        )

        this.Upgrades.push(new RelicUpgrade(0, 'Freeze duration is increased by 1 second per upgrade level.', 15, 800))
        this.Upgrades.push(
            new RelicUpgrade(
                1,
                `Wolves that've been frozen will have 50% reduced movespeed for ${FrostbiteRing.SLOW_DURATION} seconds after being unfrozen.`,
                20,
                1000
            )
        )
        this.Upgrades.push(
            new RelicUpgrade(2, `Cooldown is reduced by ${FrostbiteRing.UPGRADE_COOLDOWN_REDUCTION} seconds.`, 20, 1200)
        )
    }

    public override ApplyEffect(Unit: Unit) {
        this.RegisterTriggers(Unit)
        Unit.disableAbility(FrostbiteRing.RelicAbilityID, false, false)
        this.Owner = Unit.getOwner()!
        this.SetAbilityCooldown(Unit)
    }

    public override RemoveEffect(Unit: Unit) {
        this.Trigger?.destroy()
        this.FreezeGroup?.destroy()
        this.FreezeGroup = undefined
        Unit.disableAbility(FrostbiteRing.RelicAbilityID, false, true)
    }

    private FrostbiteCast = (freezeLocation: location) => {
        if (!this.Owner) return

        try {
            this.FreezeGroup ??= Group.create()!
            this.FreezeGroup.enumUnitsInRange(
                GetLocationX(freezeLocation),
                GetLocationY(freezeLocation),
                FrostbiteRing.FROSTBITE_RING_RADIUS,
                FilterList.DogFilter
            )

            while (true) {
                const unit = this.FreezeGroup.first
                if (!unit) break
                this.FreezeGroup.removeUnit(unit)
                if (Globals.ALL_WOLVES.has(unit) && Globals.ALL_WOLVES.get(unit)!.IsReviving) continue // reviving bomber wolves will not be allowed to be frozen.)
                if (Globals.ALL_WOLVES.get(unit)!.HasAffix('Frostbite')) continue
                this.FrostbiteEffect(unit)
            }

            RelicUtil.CloseRelicBookPlayer(this.Owner)

            Utility.SimpleTimer(1.0, () => {
                if (!this.Owner) return
                this.Owner.DisplayTimedTextTo(
                    4.0,
                    `${Colors.COLOR_LAVENDER}${Globals.ALL_KITTIES.get(this.Owner)!.CurrentStats.WolfFreezeCount}/${Challenges.FREEZE_AURA_WOLF_REQUIREMENT}|r`
                )
            })
            Utility.SimpleTimer(0.1, () => {
                if (!this.Owner) return
                RelicUtil.SetRelicCooldowns(
                    Globals.ALL_KITTIES.get(this.Owner)!.Unit,
                    FrostbiteRing.RelicItemID,
                    FrostbiteRing.RelicAbilityID
                )
            })

            RemoveLocation(freezeLocation)
            this.FreezeGroup.clear()
        } catch (e) {
            Logger.Warning(`Error in FrostbiteRing.FrostbiteCast: ${e}`)
        }
    }

    private FrostbiteEffect = (Unit: Unit) => {
        if (!this.Owner) return
        const duration = this.GetFreezeDuration()
        Globals.ALL_KITTIES.get(this.Owner)!.CurrentStats.WolfFreezeCount += 1 // increment freeze count for freeze_aura reward

        if (FrostbiteRing.FrozenWolves.has(Unit)) {
            FrostbiteRing.FrozenWolves.get(Unit)!.BeginFreezeActions(this.Owner, Unit, duration)
            return
        } else {
            const frozenWolf = MemoryHandler.getEmptyClass(FrozenWolf)
            frozenWolf.BeginFreezeActions(this.Owner, Unit, duration)
            FrostbiteRing.FrozenWolves.set(Unit, frozenWolf)
        }
    }

    private SetAbilityCooldown = (Unit: Unit) => {
        const upgradeLevel = PlayerUpgrades.GetPlayerUpgrades(Unit.owner).GetUpgradeLevel(FrostbiteRing.name)
        const currentCooldown = BlzGetAbilityCooldown(FrostbiteRing.RelicAbilityID, 0)
        let newCooldown =
            upgradeLevel >= 3 ? currentCooldown - FrostbiteRing.UPGRADE_COOLDOWN_REDUCTION : currentCooldown

        RelicUtil.SetAbilityCooldown(Unit, FrostbiteRing.RelicItemID, FrostbiteRing.RelicAbilityID, newCooldown)
    }

    private GetFreezeDuration(): number {
        if (!this.Owner) return 0
        const upgradeLevel = PlayerUpgrades.GetPlayerUpgrades(this.Owner).GetUpgradeLevel(FrostbiteRing.name)
        return FrostbiteRing.DEFAULT_FREEZE_DURATION + upgradeLevel
    }

    private RegisterTriggers = (Unit: Unit) => {
        this.Trigger = Trigger.create()!
        this.Trigger.registerUnitEvent(Unit, EVENT_UNIT_SPELL_EFFECT)
        this.Trigger.addCondition(() => GetSpellAbilityId() === FrostbiteRing.RelicAbilityID)
        this.Trigger.addAction(() => this.FrostbiteCast(GetSpellTargetLoc()!))
    }
}

export class FrozenWolf {
    public Unit!: Unit
    public Timer!: AchesTimers
    private FreezeEffect!: Effect
    private Caster!: MapPlayer
    private Active = false

    public constructor() {}

    public BeginFreezeActions = (castingPlayer: MapPlayer, wolfToFreeze: Unit, duration: number) => {
        try {
            if (!this.Active) this.Timer = createAchesTimer()
            this.Unit = wolfToFreeze
            this.FreezeEffect ??= Effect.fromHandle(
                AddSpecialEffectTarget(FrostbiteRing.FROSTBITE_FREEZE_RING_EFFECT, this.Unit.handle, 'origin')
            )!
            this.Caster = castingPlayer

            this.PausingWolf(this.Unit)

            this.Timer.Timer.start(duration, false, this.EndingFreezeActions)
            this.Active = true
        } catch (e) {
            Logger.Warning(`Error in FrozenWolf.BeginFreezeActions: ${e}`)
            this.dispose()
        }
    }

    private EndingFreezeActions = () => {
        try {
            this.FreezeEffect.destroy()
            this.FreezeEffect = null as never
            this.PausingWolf(this.Unit, false)
            this.SlowWolves(this.Unit)
            this.dispose()
        } catch (e) {
            Logger.Warning(`Error in FrozenWolf.EndingFreezeActions: ${e}`)
            this.dispose()
        }
    }

    public dispose = () => {
        try {
            let frozenWolf: FrozenWolf | undefined
            if (this.Unit && (frozenWolf = FrostbiteRing.FrozenWolves.get(this.Unit))) {
                FrostbiteRing.FrozenWolves.delete(this.Unit)
            }
            this.Timer.dispose()
            this.Active = false
            MemoryHandler.destroyObject(this)
        } catch (e) {
            Logger.Warning(`Error in FrozenWolf.Dispose: ${e}`)
        }
    }

    private PausingWolf = (unit: Unit, pause = true) => {
        try {
            if (!unit) return
            if (NamedWolves.StanWolf && unit === NamedWolves.StanWolf.Unit) return
            if (Globals.ALL_WOLVES.has(unit)) Globals.ALL_WOLVES.get(unit)!.PauseSelf(pause)
        } catch (e) {
            Logger.Warning(`Error in FrozenWolf.PausingWolf: ${e}`)
        }
    }

    /// <summary>
    /// Upgrade Level 2, Reducing Wolves Movement Speed
    /// </summary>=
    /// <param name="Unit"></param>
    private SlowWolves = (Unit: Unit) => {
        try {
            if (!Unit) return
            const playerUpgradeLvl = PlayerUpgrades.GetPlayerUpgrades(this.Caster).GetUpgradeLevel(FrostbiteRing.name)
            if (playerUpgradeLvl < 2) return
            // if (PlayerUpgrades.GetPlayerUpgrades(this.Caster).GetUpgradeLevel(typeof FrostbiteRing) < 2) return
            Unit.moveSpeed = 365.0 / 2.0
            const effect = Effect.fromHandle(
                AddSpecialEffectTarget(FrostbiteRing.FROSTBITE_SLOW_TARGET_EFFECT, Unit.handle, 'origin')
            )!
            Utility.SimpleTimer(FrostbiteRing.SLOW_DURATION, () => {
                Unit.moveSpeed = Unit.defaultMoveSpeed
                GC.RemoveEffect(effect)
            })
        } catch (e) {
            Logger.Warning(`Error in FrozenWolf.SlowWolves: ${e}`)
        }
    }
}

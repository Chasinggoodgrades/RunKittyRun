import { Constants } from 'src/AutoGenerated/Constants'
import { Logger } from 'src/Events/Logger/Logger'
import { NamedWolves } from 'src/Game/Entities/NamedWolves'
import { Globals } from 'src/Global/Globals'
import { ErrorHandler } from 'src/Utility/ErrorHandler'
import { FilterList } from 'src/Utility/FilterList'
import { GC } from 'src/Utility/GC'
import { AchesTimers } from 'src/Utility/MemoryHandler/AchesTimers'
import { MemoryHandler } from 'src/Utility/MemoryHandler/MemoryHandler'
import { Utility } from 'src/Utility/Utility'
import { Effect, Group, MapPlayer, Trigger, Unit } from 'w3ts'
import { PlayerUpgrades } from '../PlayerUpgrades'
import { RelicUpgrade } from '../RelicUpgrade'
import { RelicUtil } from '../RelicUtil'
import { Relic } from '../Relic'

export class FrostbiteRing extends Relic {
    public RelicItemID: number = Constants.ITEM_FROSTBITE_RING
    public static SLOW_DURATION: number = 5.0
    public FROSTBITE_FREEZE_RING_EFFECT: string = 'war3mapImported\\FreezingBreathTargetArt.mdl'
    public FROSTBITE_SLOW_TARGET_EFFECT: string = 'Abilities\\Spells\\Undead\\FrostArmor\\FrostArmorTarget.mdl'
    public static RelicAbilityID: number = Constants.ABILITY_RING_OF_FROSTBITE_RING_ULTIMATE
    public static FrozenWolves: Map<unit, FrozenWolf> = new Map()

    private RelicCost: number = 650
    private static FROSTBITE_RING_RADIUS: number = 450.0
    private static DEFAULT_FREEZE_DURATION: number = 5.0
    private static UPGRADE_COOLDOWN_REDUCTION: number = 15.0
    private FREEZE_DURATION: number = 5.0
    private static IconPath: string = 'ReplaceableTextures\\CommandButtons\\BTNFrostRing.blp'
    private Owner: MapPlayer
    private Trigger: Trigger
    private FreezeGroup: Group

    public constructor() {
        super();
        this.name = '{Colors.COLOR_BLUE}Frostbite Ring';
        this.Description = 'Freezes wolves in place for {Colors.COLOR_CYAN}{(int)DEFAULT_FREEZE_DURATION} seconds|r {Colors.COLOR_ORANGE}(Active)|r {Colors.COLOR_LIGHTBLUE}(1 min)|r';
        this.RelicAbilityID = FrostbiteRing.RelicAbilityID;
        this.RelicItemID = this.RelicItemID;
        this.RelicCost = this.RelicCost;
        this.IconPath = FrostbiteRing.IconPath;

        this.Upgrades.push(new RelicUpgrade(0, 'Freeze duration is increased by 1 second per upgrade level.', 15, 800))
        this.Upgrades.push(
            new RelicUpgrade(
                1,
                "Wolves that've been frozen will have 50% reduced movespeed for {SLOW_DURATION} seconds after being unfrozen.",
                20,
                1000
            )
        )
        this.Upgrades.push(
            new RelicUpgrade(2, 'Cooldown is reduced by {(int)UPGRADE_COOLDOWN_REDUCTION} seconds.', 20, 1200)
        )
    }

    public override ApplyEffect(Unit: Unit) {
        this.RegisterTriggers(Unit)
        Unit.disableAbility(FrostbiteRing.RelicAbilityID, false, false)
        this.Owner = Unit.owner
        this.SetAbilityCooldown(Unit)
    }

    public override RemoveEffect(Unit: Unit) {
        GC.RemoveTrigger(this.Trigger) // TODO; Cleanup:         GC.RemoveTrigger(ref Trigger);
        Unit.disableAbility(FrostbiteRing.RelicAbilityID, false, true)
    }

    private FrostbiteCast(freezeLocation: location) {
        try {
            this.FreezeGroup ??= Group.create()!
            this.FreezeGroup.enumUnitsInRange(
                GetLocationX(freezeLocation),
                GetLocationY(freezeLocation),
                FrostbiteRing.FROSTBITE_RING_RADIUS,
                FilterList.DogFilter
            )

            while (true) {
                let unit = this.FreezeGroup.First
                if (unit == null) break
                this.FreezeGroup.removeUnit(unit)
                if (Globals.ALL_WOLVES.has(unit) && Globals.ALL_WOLVES.get(unit).IsReviving) continue // reviving bomber wolves will not be allowed to be frozen.)
                if (Globals.ALL_WOLVES.get(unit).HasAffix('Frostbite')) continue
                this.FrostbiteEffect(unit)
            }

            RelicUtil.CloseRelicBookPlayer(this.Owner)

            Utility.SimpleTimer(1.0, () =>
                this.Owner.DisplayTimedTextTo(
                    4.0,
                    '{Colors.COLOR_LAVENDER}{Globals.ALL_KITTIES.get(Owner)!.CurrentStats.WolfFreezeCount}/{Challenges.FREEZE_AURA_WOLF_REQUIREMENT}|r'
                )
            )
            Utility.SimpleTimer(0.1, () =>
                RelicUtil.SetRelicCooldowns(
                    Globals.ALL_KITTIES.get(this.Owner)!.Unit,
                    this.RelicItemID,
                    FrostbiteRing.RelicAbilityID
                )
            )

            freezeLocation.dispose()
            this.FreezeGroup.clear()
        } catch (e: any) {
            Logger.Warning('Error in FrostbiteRing.FrostbiteCast: {e.Message}')
        }
    }

    private FrostbiteEffect(Unit: Unit) {
        let duration = this.GetFreezeDuration()
        Globals.ALL_KITTIES.get(this.Owner)!.CurrentStats.WolfFreezeCount += 1 // increment freeze count for freeze_aura reward

        if (FrostbiteRing.FrozenWolves.has(Unit)) {
            FrostbiteRing.FrozenWolves[Unit].BeginFreezeActions(this.Owner, Unit, duration)
            return
        } else {
            let frozenWolf = MemoryHandler.getEmptyObject<FrozenWolf>()
            frozenWolf.BeginFreezeActions(this.Owner, Unit, duration)
            FrostbiteRing.FrozenWolves[Unit] = frozenWolf
        }
    }

    private SetAbilityCooldown(Unit: Unit) {
        let upgradeLevel = PlayerUpgrades.GetPlayerUpgrades(Unit.owner).GetUpgradeLevel(GetType())
        let currentCooldown = BlzGetAbilityCooldown(FrostbiteRing.RelicAbilityID, 0)
        let newCooldown =
            upgradeLevel >= 3 ? currentCooldown - FrostbiteRing.UPGRADE_COOLDOWN_REDUCTION : currentCooldown

        RelicUtil.SetAbilityCooldown(Unit, this.RelicItemID, FrostbiteRing.RelicAbilityID, newCooldown)
    }

    private GetFreezeDuration(): number {
        let upgradeLevel = PlayerUpgrades.GetPlayerUpgrades(this.Owner).GetUpgradeLevel(GetType())
        return FrostbiteRing.DEFAULT_FREEZE_DURATION + upgradeLevel
    }

    private RegisterTriggers(Unit: Unit) {
        let trg = Trigger.create()!
        trg.registerUnitEvent(Unit, EVENT_UNIT_SPELL_EFFECT)
        trg.addCondition(Condition(() => GetSpellAbilityId() == FrostbiteRing.RelicAbilityID))
        trg.addAction(ErrorHandler.Wrap(() => this.FrostbiteCast(GetSpellTargetLoc()!)))
    }
}

export class FrozenWolf {
    public Unit: Unit
    public Timer: AchesTimers
    private FreezeEffect: Effect
    private Caster: MapPlayer
    private Active: boolean = false

    public FrozenWolf() {}

    public BeginFreezeActions(castingPlayer: MapPlayer, wolfToFreeze: Unit, duration: number) {
        try {
            if (!this.Active) this.Timer = MemoryHandler.getEmptyObject<AchesTimers>()
            this.Unit = wolfToFreeze
            this.FreezeEffect ??= AddSpecialEffectTarget(
                FrostbiteRing.FROSTBITE_FREEZE_RING_EFFECT,
                this.Unit,
                'origin'
            )
            this.Caster = castingPlayer

            this.PausingWolf(this.Unit)

            this.Timer.Timer.start(duration, false, this.EndingFreezeActions)
            this.Active = true
        } catch (e: any) {
            Logger.Warning('Error in FrozenWolf.BeginFreezeActions: {e.Message}')
            Dispose()
        }
    }

    private EndingFreezeActions() {
        try {
            this.FreezeEffect?.dispose()
            this.FreezeEffect = null
            this.PausingWolf(this.Unit, false)
            this.SlowWolves(this.Unit)
            Dispose()
        } catch (e: any) {
            Logger.Warning('Error in FrozenWolf.EndingFreezeActions: {e.Message}')
            Dispose()
        }
    }

    public dispose() {
        try {
            if (
                this.Unit != null &&
                (frozenWolf = FrostbiteRing.FrozenWolves.TryGetValue(this.Unit)) /* TODO; Prepend: let */
            ) {
                FrostbiteRing.FrozenWolves.Remove(this.Unit)
            }
            this.Timer.dispose()
            this.Active = false
            MemoryHandler.destroyObject(this)
        } catch (e: any) {
            Logger.Warning('Error in FrozenWolf.Dispose: {e.Message}')
        }
    }

    private PausingWolf(unit: Unit, pause: boolean = true) {
        try {
            if (unit == null) return
            if (NamedWolves.StanWolf != null && unit == NamedWolves.StanWolf.Unit) return
            if (Globals.ALL_WOLVES.has(unit)) Globals.ALL_WOLVES.get(unit).PauseSelf(pause)
        } catch (e: any) {
            Logger.Warning('Error in FrozenWolf.PausingWolf: {e.Message}')
        }
    }

    /// <summary>
    /// Upgrade Level 2, Reducing Wolves Movement Speed
    /// </summary>
    /// <param name="Unit"></param>
    private SlowWolves(Unit: Unit) {
        try {
            if (Unit == null) return
            if (PlayerUpgrades.GetPlayerUpgrades(this.Caster).GetUpgradeLevel(typeof FrostbiteRing) < 2) return
            Unit.MovementSpeed = 365.0 / 2.0
            let effect = AddSpecialEffectTarget(FrostbiteRing.FROSTBITE_SLOW_TARGET_EFFECT, Unit, 'origin')
            Utility.SimpleTimer(FrostbiteRing.SLOW_DURATION, () => {
                Unit.MovementSpeed = Unit.DefaultMovementSpeed
                GC.RemoveEffect(effect) // TODO; Cleanup:                 GC.RemoveEffect(ref effect);
            })
        } catch (e: any) {
            Logger.Warning('Error in FrozenWolf.SlowWolves: {e.Message}')
        }
    }
}

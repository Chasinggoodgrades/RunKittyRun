import { Constants } from 'src/AutoGenerated/Constants'
import { Logger } from 'src/Events/Logger/Logger'
import { ShadowKitty } from 'src/Game/Entities/ShadowKitty'
import { Globals } from 'src/Global/Globals'
import { TeamDeathless } from 'src/Rewards/Challenges/TeamDeathless'
import { Colors } from 'src/Utility/Colors/Colors'
import { ErrorHandler } from 'src/Utility/ErrorHandler'
import { GC } from 'src/Utility/GC'
import { Utility } from 'src/Utility/Utility'
import { getTriggerUnit } from 'src/Utility/w3tsUtils'
import { Timer, Trigger, Unit } from 'w3ts'
import { PlayerUpgrades } from '../PlayerUpgrades'
import { Relic } from '../Relic'
import { RelicUpgrade } from '../RelicUpgrade'
import { RelicUtil } from '../RelicUtil'

export class FangOfShadows extends Relic {
    public RelicItemID: number = Constants.ITEM_FANG_OF_SHADOWS
    public RelicAbilityID: number = Constants.ABILITY_SUMMON_SHADOW_KITTY
    private TeleportAbilityID: number = Constants.ABILITY_APPEAR_AT_SHADOWKITTY
    private static IconPath: string = 'ReplaceableTextures\\CommandButtons\\BTNRingVioletSpider.blp'
    private SummonTrigger: Trigger
    private TeleTrigger: Trigger
    private KillTimer: Timer
    private Owner: Unit
    private Active: boolean = false

    private RelicCost: number = 650
    private SAFEZONE_REDUCTION: number = 0.25 // 25%
    private UPGRADE_SAFEZONE_REDUCTION: number = 0.5 // 50%
    private UPGRADE_COOLDOWN_REDUCTION: number = 30.0
    private static SHADOW_KITTY_SUMMON_DURATION: number = 75.0

    public constructor() {
        super(
            `${Colors.COLOR_PURPLE}Fang of Shadows`,
            `Ability to summon a shadowy image for ${Colors.COLOR_CYAN}${FangOfShadows.SHADOW_KITTY_SUMMON_DURATION} seconds|r or until death. Teleport to the illusion at will.|r ` +
                `${Colors.COLOR_ORANGE}(Active)|r ${Colors.COLOR_LIGHTBLUE}(3min) (Remaining cooldown reduced by 25% at safezones.)|r`,
            Constants.ITEM_FANG_OF_SHADOWS,
            Constants.ABILITY_SUMMON_SHADOW_KITTY,
            650,
            'ReplaceableTextures\\CommandButtons\\BTNRingVioletSpider.blp'
        )

        this.Upgrades.push(
            new RelicUpgrade(0, `Overall cooldown is reduced by ${this.UPGRADE_COOLDOWN_REDUCTION} seconds.`, 15, 800)
        )
        this.Upgrades.push(
            new RelicUpgrade(1, 'Remaining cooldown reduced at new safezones is now 50% instead of 25%.', 20, 1000)
        )
    }

    public override ApplyEffect(Unit: Unit) {
        this.Owner = Unit
        this.RegisterTriggers(Unit)
        Unit.disableAbility(this.RelicAbilityID, false, false)
        this.SetAbilityCooldown(Unit)
    }

    public override RemoveEffect(Unit: Unit) {
        this.DeregisterTriggers()
        Unit.disableAbility(this.RelicAbilityID, false, true)
    }

    private RegisterTriggers(Unit: Unit) {
        this.SummonTrigger = Trigger.create()!
        TriggerRegisterUnitEvent(this.SummonTrigger.handle, Unit.handle, EVENT_UNIT_SPELL_CAST)
        this.SummonTrigger.addCondition(Condition(() => GetSpellAbilityId() === this.RelicAbilityID))
        this.SummonTrigger.addAction(ErrorHandler.Wrap(this.SummonShadowKitty))

        this.TeleTrigger = Trigger.create()!
        this.KillTimer = Timer.create()
    }

    private DeregisterTriggers() {
        GC.RemoveTrigger(this.SummonTrigger) // TODO; Cleanup:         GC.RemoveTrigger(ref SummonTrigger);
        GC.RemoveTrigger(this.TeleTrigger) // TODO; Cleanup:         GC.RemoveTrigger(ref TeleTrigger);
        GC.RemoveTimer(this.KillTimer) // TODO; Cleanup:         GC.RemoveTimer(ref KillTimer);
    }

    private SummonShadowKitty() {
        try {
            let summoner = Globals.ALL_KITTIES.get(getTriggerUnit()!.owner)

            if (!summoner) return

            // Prevent summoning if holding the orb
            if (TeamDeathless.CurrentHolder === summoner) {
                summoner.Player.DisplayTimedTextTo(
                    3.0,
                    `${Colors.COLOR_RED}Cannot summon shadow kitty while holding the orb!${Colors.COLOR_RESET}`
                )
                return
            }

            let shadowKitty = ShadowKitty.ALL_SHADOWKITTIES.get(getTriggerUnit().owner)

            if (!shadowKitty) return

            // Summon and configure Shadow Kitty
            shadowKitty.SummonShadowKitty()
            this.RegisterTeleportAbility(shadowKitty.Unit)
            shadowKitty.Unit.applyTimedLife(FourCC('BTLF'), FangOfShadows.SHADOW_KITTY_SUMMON_DURATION)

            // Set kill timer
            this.KillTimer.start(
                FangOfShadows.SHADOW_KITTY_SUMMON_DURATION,
                false,
                ErrorHandler.Wrap(shadowKitty.KillShadowKitty)
            )

            // Apply relic cooldowns with a slight delay
            Utility.SimpleTimer(0.1, () =>
                RelicUtil.SetRelicCooldowns(this.Owner, this.RelicItemID, this.RelicAbilityID)
            )
        } catch (e: any) {
            Logger.Warning(`Error in SummonShadowKitty: ${e}`)
        }
    }

    private TeleportToShadowKitty() {
        try {
            let sk = ShadowKitty.ALL_SHADOWKITTIES.get(getTriggerUnit().owner)
            if (!sk) return
            sk.TeleportToShadowKitty()
            Utility.DropAllItems(getTriggerUnit())
            Utility.SimpleTimer(0.09, sk.KillShadowKitty)
            this.KillTimer.pause()
        } catch (e: any) {
            Logger.Warning(`Error in FangOfShadows.TeleportToShadowKitty: ${e}`)
            return
        }
    }

    private RegisterTeleportAbility(Unit: Unit) {
        TriggerRegisterUnitEvent(this.TeleTrigger.handle, Unit.handle, EVENT_UNIT_SPELL_CAST)
        this.TeleTrigger.addCondition(Condition(() => GetSpellAbilityId() === this.TeleportAbilityID))
        this.TeleTrigger.addAction(this.TeleportToShadowKitty)
    }

    /// <summary>
    /// Upgrade Level 1 Cooldown Reduction
    /// </summary>
    /// <param name="Unit"></param>
    private SetAbilityCooldown(Unit: Unit) {
        let upgradeLevel = PlayerUpgrades.GetPlayerUpgrades(Unit.owner).GetUpgradeLevel(typeof FangOfShadows)
        let currentCooldown = BlzGetAbilityCooldown(this.RelicAbilityID, 0)
        let newCooldown = upgradeLevel >= 1 ? currentCooldown - this.UPGRADE_COOLDOWN_REDUCTION : currentCooldown

        //let ability = Unit.getAbility(RelicAbilityID);
        RelicUtil.SetAbilityCooldown(Unit, this.RelicItemID, this.RelicAbilityID, newCooldown)
    }

    public ReduceCooldownAtSafezone(Unit: Unit) {
        // Have relic
        if (!Utility.UnitHasItem(Unit, this.RelicItemID)) return
        let upgradeLevel: number = PlayerUpgrades.GetPlayerUpgrades(Unit.owner).GetUpgradeLevel(typeof FangOfShadows)
        Unit.getAbility(this.RelicAbilityID)
        let reduction: number = upgradeLevel >= 2 ? this.UPGRADE_SAFEZONE_REDUCTION : this.SAFEZONE_REDUCTION
        let remainingCooldown: number = Unit.getAbilityCooldownRemaining(this.RelicAbilityID)
        if (remainingCooldown <= 0) return
        let newCooldown: number = remainingCooldown * (1.0 - reduction)
        //BlzStartUnitAbilityCooldown(Unit.handle,RelicAbilityID, newCooldown);
        RelicUtil.SetRelicCooldowns(Unit, this.RelicItemID, this.RelicAbilityID, newCooldown)
    }
}

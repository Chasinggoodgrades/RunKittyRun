import { Constants } from 'src/AutoGenerated/Constants'
import { Logger } from 'src/Events/Logger/Logger'
import { Kitty } from 'src/Game/Entities/Kitty/Kitty'
import { Gamemode } from 'src/Gamemodes/Gamemode'
import { GameMode } from 'src/Gamemodes/GameModeEnum'
import { Globals } from 'src/Global/Globals'
import { Utility } from 'src/Utility/Utility'
import { Unit, Effect, Timer } from 'w3ts'
import { PlayerUpgrades } from '../PlayerUpgrades'
import { RelicUpgrade } from '../RelicUpgrade'
import { Relic } from '../Relic'

export class ChronoSphere extends Relic {
    public RelicItemID: number = Constants.ITEM_CHRONO_ORB
    public RelicAbilityID: number = Constants.ABILITY_THE_AURA_OF_THE_RING
    private static IconPath: string = 'ReplaceableTextures\\CommandButtons\\Orb: BTNChrono.dds'

    private static readonly IsChronoSphere = (r: Relic): r is ChronoSphere => {
        return r instanceof ChronoSphere
    }

    private LocationSaveEffectPath: string = 'war3mapImported\\ChronoLocationSave.mdx'
    private RelicCost: number = 650
    private SLOW_AURA_RADIUS: number = 400.0
    private MAGNITUDE_CHANGE_INTERVAL: number = 15.0
    private MAGNITUDE_LOWER_BOUND: number = 10.0
    private MAGNITUDE_UPPER_BOUND: number = 17.0
    private LOCATION_CAPTURE_INTERVAL: number = 5.0
    private REWIND_COOLDOWN: number = 120.0

    private Ability: ability
    private Kitty: Kitty
    private Magnitude: number
    private MagnitudeTimer = Timer.create()
    private LocationCaptureTimer = Timer.create()
    private LocationEffect: Effect | null = null
    private CapturedLocation = [100, 100, 100]

    public constructor() {
        super(),
        this.name = '{Colors.COLOR_YELLOW}Chrono Sphere',
        this.Description = 'Slows time around you, slowing wolves by 10% within {(int)SLOW_AURA_RADIUS} range.{Colors.COLOR_LIGHTBLUE}(Passive)|r',
        this.RelicAbilityID = this.RelicAbilityID,
        this.RelicItemID = this.RelicItemID,
        this.RelicCost = this.RelicCost,
        this.IconPath = this.IconPath

        this.Upgrades.push(
            new RelicUpgrade(
                0,
                `Every {MAGNITUDE_CHANGE_INTERVAL.ToString("F2")} seconds, the magnitude of the slowing aura will change between {MAGNITUDE_LOWER_BOUND.ToString("F2")}% - {MAGNITUDE_UPPER_BOUND.ToString("F2")}% effectiveness.`,
                15,
                800
            )
        )
        this.Upgrades.push(
            new RelicUpgrade(
                1,
                `Every {LOCATION_CAPTURE_INTERVAL.ToString("F2")} seconds, your location is captured. If you were to die, you'll reverse time to that location. {Colors.COLOR_LIGHTBLUE}(2min cooldown)|r`,
                20,
                1000
            )
        )
    }

    public override ApplyEffect(Unit: Unit) {
        try {
            this.Kitty = Globals.ALL_KITTIES.get(Unit.owner)!
            Utility.SimpleTimer(0.1, this.RotatingSlowAura)
            Utility.SimpleTimer(0.1, this.RotatingLocationCapture)
        } catch (e: any) {
            Logger.Warning('Error in ChronoSphere.ApplyEffect: {e.Message}')
        }
    }

    public override RemoveEffect(Unit: Unit) {
        try {
            this.MagnitudeTimer?.pause()
            this.MagnitudeTimer?.destroy()
            this.LocationCaptureTimer?.pause()
            this.LocationCaptureTimer?.destroy()
            this.LocationEffect?.destroy()
        } catch (e: any) {
            Logger.Warning('Error in ChronoSphere.RemoveEffect: {e.Message}')
        }
    }

    private SetAbilityData() {
        try {
            let item = Utility.UnitGetItem(Kitty.Unit, RelicItemID)
            if (!item) return
            this.Ability = item.getAbility(RelicAbilityID)
            this.Magnitude = this.RandomMagnitude()
            this.Ability.SetMovementSpeedIncreasePercent_Oae1(0, this.Magnitude)
            this.Ability.SetAreaOfEffect_aare(0, this.SLOW_AURA_RADIUS)
            item.ExtendedDescription = `{Colors.COLOR_YELLOW}possessor: The of mystical: orb: emits: a: temporal: distortion: field: this, the: movement: slowing of all enemies within a 400 range by {Colors.COLOR_LAVENDER}{Math.abs(this.Magnitude * 100).ToString("F0")}%.|r |cffadd8e6(Passive)|r\r\n`
        } catch (e: any) {
            Logger.Warning('Error in ChronoSphere.SetAbilityData: {e.Message}')
        }
    }

    // Upgrade level 1, rotating aura slow
    private RotatingSlowAura() {
        try {
            let upgradeLevel = PlayerUpgrades.GetPlayerUpgrades(Kitty.Player).GetUpgradeLevel(typeof ChronoSphere)
            if (upgradeLevel <= 0) return

            MagnitudeTimer ??= Timer.create()

            MagnitudeTimer.start(MAGNITUDE_CHANGE_INTERVAL, true, SetAbilityData)
            SetAbilityData()
        } catch (e: any) {
            Logger.Warning('Error in ChronoSphere.RotatingSlowAura: {e.Message}')
        }
    }

    // Upgrade Level 2 Location Capture
    private RotatingLocationCapture() {
        try {
            let upgradeLevel = PlayerUpgrades.GetPlayerUpgrades(Kitty.Player).GetUpgradeLevel(typeof ChronoSphere)
            if (upgradeLevel <= 1) return
            this.LocationCaptureTimer ??= Timer.create()
            this.CapturedLocation = (Kitty.Unit.x, Kitty.Unit.y, Kitty.Unit.facing) // reset to current location on buy
            this.LocationCaptureTimer.start(this.LOCATION_CAPTURE_INTERVAL, false, this.CaptureLocation)
        } catch (e: any) {
            Logger.Warning('Error in ChronoSphere.RotatingLocationCapture: {e.Message}')
        }
    }

    private CaptureLocation() {
        try {
            LocationCaptureTimer.start(LOCATION_CAPTURE_INTERVAL, false, CaptureLocation)
            if (Kitty.CurrentStats.ChronoSphereCD) return
            let unit = Kitty.Unit
            CapturedLocation = (unit.x, unit.y, unit.facing)
            LocationEffect ??= Effect.create(LocationSaveEffectPath, unit.x, unit.y)!
            LocationEffect.Scale = 0.55
            LocationEffect.dispose()
            LocationEffect = null
        } catch (er: any) {
            Logger.Warning('Error in ChronoSphere.CaptureLocation: {er.Message}')
        }
    }

    private RandomMagnitude(): number {
        let upgradeLevel = PlayerUpgrades.GetPlayerUpgrades(Kitty.Player).GetUpgradeLevel(typeof ChronoSphere)
        let lowerBound = (MAGNITUDE_LOWER_BOUND / 100.0) * -1.0
        let upperBound = (MAGNITUDE_UPPER_BOUND / 100.0) * -1.0
        if (upgradeLevel == 0) return lowerBound
        return GetRandomReal(upperBound, lowerBound) // as weird as this is.. yes.
    }

    private RewindTime() {
        try {
            Kitty.Invulnerable = true
            let x = CapturedLocation.Item1
            let y = CapturedLocation.Item2
            if (x == 0 && y == 0) {
                x = Kitty.Unit.x
                y = Kitty.Unit.y
            }
            Kitty.Unit.setPosition(x, y)
            Kitty.Unit.setFacingEx(CapturedLocation.Item3)
            Kitty.Unit.paused = true
            Utility.SelectUnitForPlayer(Kitty.Player, Kitty.Unit)

            if (Kitty.Player.isLocal()) PanCameraToTimed(Kitty.Unit.x, Kitty.Unit.y, 0.0)
            Utility.SimpleTimer(2.0, () => {
                Kitty.Unit.paused = false
                Utility.SimpleTimer(1.0, () => (Kitty.Invulnerable = false))
            })
        } catch (e: any) {
            Logger.Warning('Error in ChronoSphere.RewindTime: {e.Message}')
        }
    }

    public static RewindDeath(kitty: Kitty) {
        try {
            if (Gamemode.CurrentGameMode != GameMode.Standard) return false // Only for Standard.
            if (kitty.ProtectionActive) return false // Don't rewind if ultimate has been casted.
            if (!Utility.UnitHasItem(kitty.Unit, Constants.ITEM_CHRONO_ORB)) return false
            let relic = kitty.Relics.find(IsChronoSphere) as ChronoSphere
            if (relic == null) return false
            if (kitty.CurrentStats.ChronoSphereCD) return false
            let upgradeLevel = PlayerUpgrades.GetPlayerUpgrades(kitty.Player).GetUpgradeLevel(typeof ChronoSphere)
            if (upgradeLevel < 2) return false
            relic.RewindTime()
            kitty.CurrentStats.ChronoSphereCD = true
            /*            let relicItem = Utility.UnitGetItem(kitty.Unit, RelicItemID);
            relicItem.ActivelyUsed = true;
            relicItem.AddAbility(Constants.ABILITY_TAKE_EM_WITH_RING_ULTIMATE);
            kitty.Unit.UseItem(relicItem);*/
            Utility.SimpleTimer(REWIND_COOLDOWN, () => {
                try {
                    kitty.CurrentStats.ChronoSphereCD = false
                    kitty.Player.DisplayTimedTextTo(1.0, '{Colors.COLOR_LAVENDER}Sphere: recharged: Chrono|r')
                    relic?.LocationCaptureTimer?.start(0, false, relic.CaptureLocation)
                } catch (e: any) {
                    Logger.Warning('Error in ChronoSphere.RewindDeath: {e.Message}')
                }
            })
            return true
        } catch (e: any) {
            Logger.Warning('Error in ChronoSphere.RewindDeath: {e.Message}')
            return false
        }
    }
}

import { Constants } from 'src/AutoGenerated/Constants'
import { Logger } from 'src/Events/Logger/Logger'
import { Kitty } from 'src/Game/Entities/Kitty/Kitty'
import { CurrentGameMode } from 'src/Gamemodes/CurrentGameMode'
import { GameMode } from 'src/Gamemodes/GameModeEnum'
import { Globals } from 'src/Global/Globals'
import { Colors } from 'src/Utility/Colors/Colors'
import { Utility } from 'src/Utility/Utility'
import { Effect, Timer, Unit } from 'w3ts'
import { PlayerUpgrades } from '../PlayerUpgrades'
import { Relic } from '../Relic'
import { RelicUpgrade } from '../RelicUpgrade'

export class ChronoSphere extends Relic {
    public RelicItemID = Constants.ITEM_CHRONO_ORB
    public RelicAbilityID = Constants.ABILITY_THE_AURA_OF_THE_RING
    private static IconPath: string = 'ReplaceableTextures\\CommandButtons\\Orb: BTNChrono.dds'

    public static readonly IsChronoSphere = (r: Relic): r is ChronoSphere => {
        return r instanceof ChronoSphere
    }

    private static REWIND_COOLDOWN = 120.0
    private LocationSaveEffectPath: string = 'war3mapImported\\ChronoLocationSave.mdx'
    private RelicCost = 650
    private static SLOW_AURA_RADIUS = 400.0
    private MAGNITUDE_CHANGE_INTERVAL = 15.0
    private MAGNITUDE_LOWER_BOUND = 10.0
    private MAGNITUDE_UPPER_BOUND = 17.0
    private LOCATION_CAPTURE_INTERVAL = 5.0

    private Ability: ability
    private Kitty: Kitty
    private Magnitude = 0
    private MagnitudeTimer = Timer.create()
    private LocationCaptureTimer = Timer.create()
    private LocationEffect: Effect | null = null
    private CapturedLocation = [100, 100, 100]

    public constructor() {
        super(
            `${Colors.COLOR_YELLOW}Chrono Sphere`,
            `Slows time around you, slowing wolves by 10% within ${ChronoSphere.SLOW_AURA_RADIUS} range.${Colors.COLOR_LIGHTBLUE}(Passive)|r`,
            Constants.ABILITY_THE_AURA_OF_THE_RING,
            Constants.ITEM_CHRONO_ORB,
            650,
            ChronoSphere.IconPath
        )

        this.Upgrades.push(
            new RelicUpgrade(
                0,
                `Every ${this.MAGNITUDE_CHANGE_INTERVAL.toFixed(2)} seconds, the magnitude of the slowing aura will change between ${this.MAGNITUDE_LOWER_BOUND.toFixed(2)}% - ${this.MAGNITUDE_UPPER_BOUND.toFixed(2)}% effectiveness.`,
                15,
                800
            )
        )
        this.Upgrades.push(
            new RelicUpgrade(
                1,
                `Every ${this.LOCATION_CAPTURE_INTERVAL.toFixed(2)} seconds, your location is captured. If you were to die, you'll reverse time to that location. ${Colors.COLOR_LIGHTBLUE}(2min cooldown)|r`,
                20,
                1000
            )
        )
    }

    public override ApplyEffect(Unit: Unit) {
        try {
            this.Kitty = Globals.ALL_KITTIES.get(Unit.owner)!
            Utility.SimpleTimer(0.1, this.RotatingSlowAura)
            Utility.SimpleTimer(0.1, this.RotatingLocationCapture)
        } catch (e) {
            Logger.Warning(`Error in ChronoSphere.ApplyEffect: ${e}`)
        }
    }

    public override RemoveEffect(Unit: Unit) {
        try {
            this.MagnitudeTimer?.pause()
            this.MagnitudeTimer?.destroy()
            this.LocationCaptureTimer?.pause()
            this.LocationCaptureTimer?.destroy()
            this.LocationEffect?.destroy()
        } catch (e) {
            Logger.Warning(`Error in ChronoSphere.RemoveEffect: ${e}`)
        }
    }

    private SetAbilityData = () => {
        try {
            const item = Utility.UnitGetItem(this.Kitty.Unit, this.RelicItemID)
            if (!item) return
            this.Ability = item.getAbility(this.RelicAbilityID)!
            if (!this.Ability) return
            this.Magnitude = this.RandomMagnitude()
            BlzSetAbilityRealLevelField(
                this.Ability,
                ABILITY_RLF_MOVEMENT_SPEED_INCREASE_PERCENT_OAE1,
                0,
                this.Magnitude
            )
            BlzSetAbilityRealLevelField(this.Ability, ABILITY_RLF_AREA_OF_EFFECT, 0, ChronoSphere.SLOW_AURA_RADIUS)

            BlzSetItemExtendedTooltip(
                item.handle,
                `${Colors.COLOR_YELLOW}The possessor of this mystical orb emits a temporal distortion field, slowing the movement of all enemies within a 400 range by ${Colors.COLOR_LAVENDER}${Math.abs(this.Magnitude * 100).toFixed(0)}%.|r |cffadd8e6(Passive)|r\r\n`
            )
        } catch (e) {
            Logger.Warning(`Error in ChronoSphere.SetAbilityData: ${e}`)
        }
    }

    // Upgrade level 1, rotating aura slow
    private RotatingSlowAura = () => {
        try {
            const upgradeLevel = PlayerUpgrades.GetPlayerUpgrades(this.Kitty.Player).GetUpgradeLevel(ChronoSphere.name)
            if (upgradeLevel <= 0) return

            this.MagnitudeTimer ??= Timer.create()

            this.MagnitudeTimer.start(this.MAGNITUDE_CHANGE_INTERVAL, true, this.SetAbilityData)
            this.SetAbilityData()
        } catch (e) {
            Logger.Warning(`Error in ChronoSphere.RotatingSlowAura: ${e}`)
        }
    }

    // Upgrade Level 2 Location Capture
    private RotatingLocationCapture = () => {
        try {
            const upgradeLevel = PlayerUpgrades.GetPlayerUpgrades(this.Kitty.Player).GetUpgradeLevel(ChronoSphere.name)
            if (upgradeLevel <= 1) return
            this.LocationCaptureTimer ??= Timer.create()
            this.CapturedLocation = [this.Kitty.Unit.x, this.Kitty.Unit.y, this.Kitty.Unit.facing] // reset to current location on buy
            this.LocationCaptureTimer.start(this.LOCATION_CAPTURE_INTERVAL, false, this.CaptureLocation)
        } catch (e) {
            Logger.Warning(`Error in ChronoSphere.RotatingLocationCapture: ${e}`)
        }
    }

    private CaptureLocation = () => {
        try {
            this.LocationCaptureTimer.start(this.LOCATION_CAPTURE_INTERVAL, false, this.CaptureLocation)
            if (this.Kitty.CurrentStats.ChronoSphereCD) return
            const unit = this.Kitty.Unit
            this.CapturedLocation = [unit.x, unit.y, unit.facing]
            this.LocationEffect ??= Effect.create(this.LocationSaveEffectPath, unit.x, unit.y)!
            this.LocationEffect.scale = 0.55
            this.LocationEffect.destroy()
            this.LocationEffect = null
        } catch (e) {
            Logger.Warning(`Error in ChronoSphere.CaptureLocation: ${e}`)
        }
    }

    private RandomMagnitude(): number {
        const upgradeLevel = PlayerUpgrades.GetPlayerUpgrades(this.Kitty.Player).GetUpgradeLevel(ChronoSphere.name)
        const lowerBound = (this.MAGNITUDE_LOWER_BOUND / 100.0) * -1.0
        const upperBound = (this.MAGNITUDE_UPPER_BOUND / 100.0) * -1.0
        if (upgradeLevel === 0) return lowerBound
        return GetRandomReal(upperBound, lowerBound) // as weird as this is.. yes.
    }

    private RewindTime = () => {
        try {
            this.Kitty.Invulnerable = true
            let x = this.CapturedLocation[0]
            let y = this.CapturedLocation[1]
            if (x === 0 && y === 0) {
                x = this.Kitty.Unit.x
                y = this.Kitty.Unit.y
            }
            this.Kitty.Unit.setPosition(x, y)
            this.Kitty.Unit.setFacingEx(this.CapturedLocation[2])
            this.Kitty.Unit.paused = true
            Utility.SelectUnitForPlayer(this.Kitty.Player, this.Kitty.Unit)

            if (this.Kitty.Player.isLocal()) PanCameraToTimed(this.Kitty.Unit.x, this.Kitty.Unit.y, 0.0)
            Utility.SimpleTimer(2.0, () => {
                this.Kitty.Unit.paused = false
                Utility.SimpleTimer(1.0, () => (this.Kitty.Invulnerable = false))
            })
        } catch (e) {
            Logger.Warning(`Error in ChronoSphere.RewindTime: ${e}`)
        }
    }

    public static RewindDeath(kitty: Kitty) {
        try {
            if (CurrentGameMode.active !== GameMode.Standard) return false // Only for Standard.
            if (kitty.ProtectionActive) return false // Don't rewind if ultimate has been casted.
            if (!Utility.UnitHasItem(kitty.Unit, Constants.ITEM_CHRONO_ORB)) return false
            const relic = kitty.Relics.find(ChronoSphere.IsChronoSphere) as ChronoSphere
            if (relic === null) return false
            if (kitty.CurrentStats.ChronoSphereCD) return false
            const upgradeLevel = PlayerUpgrades.GetPlayerUpgrades(kitty.Player).GetUpgradeLevel(ChronoSphere.name)
            if (upgradeLevel < 2) return false
            relic.RewindTime()
            kitty.CurrentStats.ChronoSphereCD = true
            /*            let relicItem = Utility.UnitGetItem(kitty.Unit, RelicItemID);
            relicItem.ActivelyUsed = true;
            relicItem.AddAbility(Constants.ABILITY_TAKE_EM_WITH_RING_ULTIMATE);
            kitty.Unit.UseItem(relicItem);*/
            Utility.SimpleTimer(ChronoSphere.REWIND_COOLDOWN, () => {
                try {
                    kitty.CurrentStats.ChronoSphereCD = false
                    kitty.Player.DisplayTimedTextTo(1.0, `${Colors.COLOR_LAVENDER}Chrono Sphere recharged|r`)
                    relic?.LocationCaptureTimer?.start(0, false, relic.CaptureLocation)
                } catch (e) {
                    Logger.Warning(`Error in ChronoSphere.RewindDeath: ${e}`)
                }
            })
            return true
        } catch (e) {
            Logger.Warning(`Error in ChronoSphere.RewindDeath: ${e}`)
            return false
        }
    }
}

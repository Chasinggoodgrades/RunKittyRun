import { Constants } from 'src/AutoGenerated/Constants'
import { Globals } from 'src/Global/Globals'
import { Utility } from 'src/Utility/Utility'
import { MapPlayer, Unit } from 'w3ts'

export class RelicUtil {
    public static DisableRelicBook = (Unit: Unit) => {
        return Unit.disableAbility(Constants.ABILITY_BOOK_OF_RELICS, true, true)
    }

    public static EnableRelicBook = (Unit: Unit) => {
        return Unit.disableAbility(Constants.ABILITY_BOOK_OF_RELICS, false, false)
    }

    public static DisableRelicAbilities = (Unit: Unit) => {
        Unit.disableAbility(Constants.ABILITY_TAKE_EM_WITH_RING_ULTIMATE, false, true)
        Unit.disableAbility(Constants.ABILITY_RING_OF_FROSTBITE_RING_ULTIMATE, false, true)
        Unit.disableAbility(Constants.ABILITY_SUMMON_SHADOW_KITTY, false, true)
        Unit.disableAbility(Constants.ABILITY_TRANSLOCATE, false, true)
    }

    public static EnableRelicAbilities = (Unit: Unit) => {
        Unit.disableAbility(Constants.ABILITY_TAKE_EM_WITH_RING_ULTIMATE, false, false)
        Unit.disableAbility(Constants.ABILITY_RING_OF_FROSTBITE_RING_ULTIMATE, false, false)
        Unit.disableAbility(Constants.ABILITY_SUMMON_SHADOW_KITTY, false, false)
        Unit.disableAbility(Constants.ABILITY_TRANSLOCATE, false, false)
    }

    /// <summary>
    /// Technically does the job it's assigned to do, however it toggles the multiboard in the process. Should be fixed later. TODO:
    /// </summary>
    /// <param name="Unit"></param>
    public static CloseRelicBook = (Unit: Unit) => {
        const player = Unit.owner
        if (!player.isLocal()) return
        ForceUICancel()
    }

    public static CloseRelicBookPlayer = (Player: MapPlayer) => {
        if (!Player.isLocal()) return
        ForceUICancel()
    }

    /// <summary>
    ///
    /// </summary>
    /// <param name="unit"></param>
    /// <param name="itemID"></param>
    /// <param name="abilityID"></param>
    public static SetRelicCooldowns = (unit: Unit, itemID: number, abilityID: number, cooldown = 0) => {
        // Get item from unit.. Drop it.. Set Cooldown of it, and set cooldown of ability on the unit to cooldown
        const item = Utility.UnitGetItem(unit, itemID)
        if (!item) return
        const itemAbility = item.getAbility(abilityID)
        if (!itemAbility) return
        const unitAbility = unit.getAbility(abilityID)
        if (!unitAbility) return

        const itemSlot = Utility.GetSlotOfItem(unit, itemID)

        const unitCooldown: number = BlzGetAbilityRealLevelField(unitAbility, ABILITY_RLF_COOLDOWN, 0)
        const itemCooldown: number = BlzGetAbilityRealLevelField(itemAbility, ABILITY_RLF_COOLDOWN, 0)

        cooldown = cooldown === 0 ? Math.min(unitCooldown, itemCooldown) : cooldown
        if (Globals.ALL_KITTIES.get(unit.owner)!.isAlive()) unit.removeItem(item)
        BlzStartUnitAbilityCooldown(unit.handle, abilityID, cooldown)
        unit.addItem(item)
        unit.dropItemFromSlot(item, itemSlot)
        BlzStartUnitAbilityCooldown(unit.handle, abilityID, cooldown)
    }

    public static SetAbilityCooldown = (unit: Unit, itemID: number, abilityID: number, cooldown: number) => {
        const item = Utility.UnitGetItem(unit, itemID)
        if (!item) return
        const itemSlot = Utility.GetSlotOfItem(unit, itemID)
        const unitAbility = unit.getAbility(abilityID)!
        if (Globals.ALL_KITTIES.get(unit.owner)!.isAlive()) unit.removeItem(item)
        BlzSetAbilityRealLevelField(unitAbility, ABILITY_RLF_COOLDOWN, 0, cooldown)
        unit.addItem(item)
        unit.dropItemFromSlot(item, itemSlot)
        const itemAbility = item.getAbility(abilityID)
        if (!itemAbility) return
        BlzSetAbilityRealLevelField(itemAbility, ABILITY_RLF_COOLDOWN, 0, cooldown)
    }
}

import { Constants } from 'src/AutoGenerated/Constants'
import { Logger } from 'src/Events/Logger/Logger'
import { UnitWithinRange } from 'src/Events/WithinRange/UnitWithinRange'
import { Globals } from 'src/Global/Globals'
import { Utility } from 'src/Utility/Utility'
import { MapPlayer, Trigger, Unit } from 'w3ts'
import { CollisionDetection } from '../CollisionDetection'
import { RelicUtil } from '../Items/Relics/RelicUtil'
import { Kitty } from './Kitty/Kitty'

export class ShadowKitty {
    public static ALL_SHADOWKITTIES: Map<player, ShadowKitty>
    public Unit: Unit

    public Player: MapPlayer

    public Kitty: Kitty

    public Active: boolean

    public wCollision: Trigger

    public cCollision: Trigger

    public ID: number

    public ShadowKitty(kitty: Kitty) {
        this.Kitty = kitty
        this.Player = kitty.Player
        ID = kitty.Player.id
        ALL_SHADOWKITTIES[Player] = this
        this.RegisterTriggers()
    }

    public static Initialize() {
        ALL_SHADOWKITTIES = {}
    }

    /// <summary>
    /// Summons shadow kitty to the position of this player's kitty object.
    /// </summary>
    public SummonShadowKitty() {
        let kitty = Globals.ALL_KITTIES.get(Player)!.Unit
        this.Unit = Unit.create(Player, Constants.UNIT_SHADOWKITTY_RELIC_SUMMON, kitty.x, kitty.y)
        this.Unit.setVertexColor(0, 0, 0, 255)

        // Unit.AddAbility(Constants.ABILITY_APPEAR_AT_SHADOWKITTY);
        Unit.AddAbility(Constants.ABILITY_WIND_WALK)
        Unit.SetAbilityLevel(Constants.ABILITY_WIND_WALK, 3)
        Utility.MakeUnitLocust(this.Unit)
        CollisionDetection.ShadowKittyRegisterCollision(this)
        this.Unit.MovementSpeed = 522
        RelicUtil.CloseRelicBook(kitty)
        PauseKitty(this.Player, true)
        Utility.SelectUnitForPlayer(this.Player, this.Unit)
        this.Active = true
    }

    /// <summary>
    /// Teleports the player's kitty to the shadow kitty's position.
    /// </summary>
    public TeleportToShadowKitty() {
        let kitty = Globals.ALL_KITTIES.get(Player)!.Unit
        kitty.setPos(Unit.x, unit.y)
    }

    /// <summary>
    /// Kills this shadow kitty object, disposing and deregistering it from collision.
    /// </summary>
    public KillShadowKitty() {
        try {
            UnitWithinRange.DeRegisterUnitWithinRangeUnitShadow(this)
            this.Unit.Kill()
            this.Unit.dispose()
            this.Unit = null
            this.Active = false
            PauseKitty(this.Player, false)
        } catch (e: any) {
            Logger.Warning('ShadowKitty.KillShadowKitty: {e.Message}')
            throw e
        }
    }

    /// <summary>
    /// The game doesnt register the the abilities or movement, so a reselection is required.
    /// </summary>
    /// <param name="player"></param>
    public SelectReselectShadowKitty() {
        let kitty = Globals.ALL_KITTIES.get(this.Player)!.Unit
        Utility.SelectUnitForPlayer(this.Player, this.Unit)
    }

    private static PauseKitty(player: MapPlayer, paused: boolean) {
        let kitty = Globals.ALL_KITTIES.get(player)!.Unit
        kitty.paused = paused
    }

    private RegisterTriggers() {
        this.wCollision = Trigger.create()!
        this.cCollision = Trigger.create()!
    }
}

import { Constants } from 'src/AutoGenerated/Constants'
import { Logger } from 'src/Events/Logger/Logger'
import { Wolf } from 'src/Game/Entities/Wolf'
import { CurrentGameMode } from 'src/Gamemodes/CurrentGameMode'
import { GameMode } from 'src/Gamemodes/GameModeEnum'
import { DEFAULT_OVERHEAD_EFFECT, Globals } from 'src/Global/Globals'
import { RegionList } from 'src/Global/RegionList'
import { BurntMeat } from 'src/Rewards/EasterEggs/BurntMeat'
import { Colors } from 'src/Utility/Colors/Colors'
import { ColorUtils } from 'src/Utility/Colors/ColorUtils'
import { RemoveItemFromUnit } from 'src/Utility/UnitUtility'
import { Utility } from 'src/Utility/Utility'
import { getKillingUnit } from 'src/Utility/w3tsUtils'
import { MapPlayer, TextTag, Timer, Unit } from 'w3ts'
import { Kitty } from './Kitty/Kitty'

export class NamedWolves {
    public static ExplodingWolf: Wolf
    public static StanWolf: Wolf
    public static STAN_NAME: string = `${Colors.COLOR_PURPLE}Stan|r`
    private static ExplodingTexttagTimer = Timer.create()
    private static ExplodingWolfRevive = Timer.create()
    private static BLOOD_EFFECT_PATH: string = 'war3mapImported\\Bloodstrike.mdx'

    /// <summary>
    /// Creates the named Wolves Marco and Stan. Only works in Standard mode.
    /// </summary>
    public static CreateNamedWolves = () => {
        if (CurrentGameMode.active !== GameMode.Standard) return
        Globals.DNTNamedWolves = []
        NamedWolves.CreateStanWolf()
        NamedWolves.CreateExplodingWolf()
    }

    private static CreateExplodingWolf = () => {
        const index = GetRandomInt(0, RegionList.WolfRegions.length - 1)
        NamedWolves.ExplodingWolf = new Wolf(index)
        NamedWolves.ExplodingWolf.Texttag = TextTag.create()!
        NamedWolves.ExplodingWolf.Texttag.setPermanent(true)
        NamedWolves.ExplodingTexttagTimer.start(0.03, true, NamedWolves.UpdateTextTag)
        NamedWolves.ExplodingWolfDesc()
    }

    private static UpdateTextTag = () => {
        NamedWolves.ExplodingWolf?.Texttag?.setPos(
            NamedWolves.ExplodingWolf.Unit.x,
            NamedWolves.ExplodingWolf.Unit.y,
            0.015
        )
    }

    private static CreateStanWolf = () => {
        const index = GetRandomInt(0, RegionList.WolfRegions.length - 1)
        NamedWolves.StanWolf = new Wolf(index)
        NamedWolves.StanWolf.PauseSelf(true)
        NamedWolves.StanWolf.Unit.setVertexColor(235, 115, 255, 255)
        NamedWolves.StanWolf.Unit.name = NamedWolves.STAN_NAME
        NamedWolves.StanWolf.OVERHEAD_EFFECT_PATH = ''

        NamedWolves.StanWolf.Texttag ??= TextTag.create()!
        NamedWolves.StanWolf.Texttag.setText(NamedWolves.StanWolf.Unit.name, 0.015)
        NamedWolves.StanWolf.Texttag.setPermanent(true)
        NamedWolves.StanWolf.paused = true
        NamedWolves.StanWolf.Unit.invulnerable = false

        Utility.SimpleTimer(0.5, () => (NamedWolves.StanWolf.Unit.invulnerable = false))
        NamedWolves.RegisterDeathTrigger()

        Utility.SimpleTimer(0.5, () =>
            NamedWolves.StanWolf.Texttag?.setPos(NamedWolves.StanWolf.Unit.x, NamedWolves.StanWolf.Unit.y, 0.015)
        )
        Globals.DNTNamedWolves.push(NamedWolves.StanWolf)
    }

    public static RegisterDeathTrigger = () => {
        BurntMeat.StanDeath.registerUnitEvent(NamedWolves.StanWolf.Unit, EVENT_UNIT_DEATH)
        if (BurntMeat.StanDeathActions !== null) return
        BurntMeat.RegisterTurnInTrigger()
        BurntMeat.StanDeathActions = BurntMeat.StanDeath.addAction(() => {
            const killer = getKillingUnit()
            if (killer === null) return
            NamedWolves.StanWolf.Texttag?.destroy()
            RemoveItemFromUnit(killer, BurntMeat.ITEM_CLOAK_FLAMES)
            killer.addItemById(BurntMeat.ITEM_BURNT_MEAT)
            BurntMeat.Completed.push(killer)
        })
    }

    public static KillExplodingWolf = () => {
        try {
            if (NamedWolves.ExplodingWolf.IsReviving) return
            NamedWolves.ExplodingWolf.Unit.kill()
            NamedWolves.ExplodingWolf.IsReviving = true
            NamedWolves.ExplodingWolf.OVERHEAD_EFFECT_PATH = ''
            NamedWolves.ExplodingWolf.Texttag?.setText('', 0.015)
            Utility.CreateEffectAndDisposeAttach(
                NamedWolves.BLOOD_EFFECT_PATH,
                NamedWolves.ExplodingWolf.Unit,
                'origin'
            )
            NamedWolves.ExplodingWolfRevive.start(25.0, false, () => {
                if (NamedWolves.ExplodingWolf.Unit === null) return
                Globals.DNTNamedWolves.splice(Globals.DNTNamedWolves.indexOf(NamedWolves.ExplodingWolf), 1)
                NamedWolves.ExplodingWolf.IsReviving = false
                NamedWolves.ExplodingWolf.Unit?.destroy()
                Globals.ALL_WOLVES.delete(NamedWolves.ExplodingWolf.Unit)
                NamedWolves.ExplodingWolf.Unit = Unit.create(
                    NamedWolves.ExplodingWolf.Unit.owner,
                    Constants.UNIT_CUSTOM_DOG,
                    NamedWolves.ExplodingWolf.Unit.x,
                    NamedWolves.ExplodingWolf.Unit.y,
                    360
                )!
                Globals.ALL_WOLVES.set(NamedWolves.ExplodingWolf.Unit, NamedWolves.ExplodingWolf)
                NamedWolves.ExplodingWolfDesc()
            })
        } catch (e) {
            Logger.Warning(`Error in KillExplodingWolf ${e}`)
        }
    }

    private static ExplodingTexttag = () => {
        NamedWolves.ExplodingWolf.Texttag ??= TextTag.create()!
        NamedWolves.ExplodingWolf.Texttag.setText(NamedWolves.ExplodingWolf.Unit.name, 0.015)
    }

    private static ExplodingWolfDesc = () => {
        try {
            Utility.MakeUnitLocust(NamedWolves.ExplodingWolf.Unit)
            const randomPlayer = NamedWolves.GetRandomPlayerFromLobby()
            NamedWolves.SetRandomVertexColor(NamedWolves.ExplodingWolf.Unit, randomPlayer.id)
            NamedWolves.ExplodingWolf.Unit.name = Utility.FormattedColorPlayerName(randomPlayer)
            NamedWolves.ExplodingTexttag()
            NamedWolves.ExplodingWolf.OVERHEAD_EFFECT_PATH = DEFAULT_OVERHEAD_EFFECT
            Globals.DNTNamedWolves.push(NamedWolves.ExplodingWolf)
        } catch (e) {
            Logger.Warning(`Error in ExplodingWolfDesc ${e}`)
        }
    }

    public static ExplodingWolfCollision(unit: Unit, k: Kitty, shadowKitty: boolean = false) {
        if (CurrentGameMode.active !== GameMode.Standard) return false
        // Guard: ExplodingWolf may not be created yet or may be in a revive window
        if (!NamedWolves.ExplodingWolf || !NamedWolves.ExplodingWolf.Unit) return false
        if (unit !== NamedWolves.ExplodingWolf.Unit) return false
        if (!shadowKitty) Utility.GiveGoldFloatingText(25, k.Unit)
        else Utility.GiveGoldFloatingText(25, k.ShadowKitty.Unit)
        BurntMeat.FlamesDropChance(k)
        NamedWolves.KillExplodingWolf()
        return true
    }

    private static GetRandomPlayerFromLobby(): MapPlayer {
        return Globals.ALL_PLAYERS[GetRandomInt(0, Globals.ALL_PLAYERS.length - 1)]
    }

    private static SetRandomVertexColor(u: Unit, playerID: number) {
        ColorUtils.SetUnitToVertexColor(u, playerID)
    }
}

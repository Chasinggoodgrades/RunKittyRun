import { Constants } from 'src/AutoGenerated/Constants'
import { Logger } from 'src/Events/Logger/Logger'
import { CurrentGameMode } from 'src/Gamemodes/CurrentGameMode'
import { GameMode } from 'src/Gamemodes/GameModeEnum'
import { DEFAULT_OVERHEAD_EFFECT, Globals } from 'src/Global/Globals'
import { RegionList } from 'src/Global/RegionList'
import { BurntMeat } from 'src/Rewards/EasterEggs/BurntMeat'
import { Colors } from 'src/Utility/Colors/Colors'
import { ColorUtils } from 'src/Utility/Colors/ColorUtils'
import { ErrorHandler } from 'src/Utility/ErrorHandler'
import { RemoveItemFromUnit } from 'src/Utility/UnitUtility'
import { Utility } from 'src/Utility/Utility'
import { getKillingUnit } from 'src/Utility/w3tsUtils'
import { MapPlayer, TextTag, Timer, Unit } from 'w3ts'
import { Kitty } from './Kitty/Kitty'
import { Wolf } from './Wolf'

export class NamedWolves {
    public static ExplodingWolf: Wolf
    public static StanWolf: Wolf
    public static STAN_NAME: string = `${Colors.COLOR_PURPLE}Stan|r`
    private static ExplodingTexttagTimer = Timer.create()
    private static ExplodingWolfRevive = Timer.create()
    private static BLOOD_EFFECT_PATH: string = 'war3mapImported\\Bloodstrike.mdx'

    /// <summary>
    /// Creates the named Wolves Marco and Stan. Only works in Standard mode.
    /// </summary>
    public static CreateNamedWolves() {
        if (CurrentGameMode.active !== GameMode.Standard) return
        Globals.DNTNamedWolves = []
        this.CreateStanWolf()
        this.CreateExplodingWolf()
    }

    private static CreateExplodingWolf() {
        let index = GetRandomInt(0, RegionList.WolfRegions.length - 1)
        this.ExplodingWolf = new Wolf(index)
        this.ExplodingWolf.Texttag.setPermanent(true)
        this.ExplodingTexttagTimer.start(0.03, true, this.UpdateTextTag)
        this.ExplodingWolfDesc()
    }

    private static UpdateTextTag() {
        this.ExplodingWolf?.Texttag?.setPos(this.ExplodingWolf.Unit.x, this.ExplodingWolf.Unit.y, 0.015)
    }

    private static CreateStanWolf() {
        let index = GetRandomInt(0, RegionList.WolfRegions.length - 1)
        this.StanWolf = new Wolf(index)
        this.StanWolf.PauseSelf(true)
        this.StanWolf.Unit.setVertexColor(235, 115, 255, 255)
        this.StanWolf.Unit.name = this.STAN_NAME
        this.StanWolf.OVERHEAD_EFFECT_PATH = ''

        this.StanWolf.Texttag ??= TextTag.create()!
        this.StanWolf.Texttag.setText(this.StanWolf.Unit.name, 0.015)
        this.StanWolf.Texttag.setPermanent(true)
        this.StanWolf.paused = true
        this.StanWolf.Unit.invulnerable = false

        Utility.SimpleTimer(0.5, () => (this.StanWolf.Unit.invulnerable = false))
        this.RegisterDeathTrigger()

        Utility.SimpleTimer(0.5, () => this.StanWolf.Texttag.setPos(this.StanWolf.Unit.x, this.StanWolf.Unit.y, 0.015))
        Globals.DNTNamedWolves.push(this.StanWolf)
    }

    public static RegisterDeathTrigger() {
        BurntMeat.StanDeath.registerUnitEvent(this.StanWolf.Unit, EVENT_UNIT_DEATH)
        if (BurntMeat.StanDeathActions !== null) return
        BurntMeat.RegisterTurnInTrigger()
        BurntMeat.StanDeathActions = BurntMeat.StanDeath.addAction(
            ErrorHandler.Wrap(() => {
                let killer = getKillingUnit()
                if (killer === null) return
                NamedWolves.StanWolf.Texttag?.destroy()
                RemoveItemFromUnit(killer, BurntMeat.ITEM_CLOAK_FLAMES)
                killer.addItemById(BurntMeat.ITEM_BURNT_MEAT)
                BurntMeat.Completed.push(killer)
            })
        )
    }

    public static KillExplodingWolf() {
        try {
            if (this.ExplodingWolf.IsReviving) return
            this.ExplodingWolf.Unit.kill()
            this.ExplodingWolf.IsReviving = true
            this.ExplodingWolf.OVERHEAD_EFFECT_PATH = ''
            this.ExplodingWolf.Texttag.setText('', 0.015)
            Utility.CreateEffectAndDisposeAttach(this.BLOOD_EFFECT_PATH, this.ExplodingWolf.Unit, 'origin')
            NamedWolves.ExplodingWolfRevive.start(
                25.0,
                false,
                ErrorHandler.Wrap(() => {
                    if (this.ExplodingWolf.Unit === null) return
                    Globals.DNTNamedWolves.splice(Globals.DNTNamedWolves.indexOf(this.ExplodingWolf), 1)
                    this.ExplodingWolf.IsReviving = false
                    this.ExplodingWolf.Unit?.destroy()
                    Globals.ALL_WOLVES.delete(this.ExplodingWolf.Unit)
                    this.ExplodingWolf.Unit = Unit.create(
                        this.ExplodingWolf.Unit.owner,
                        Constants.UNIT_CUSTOM_DOG,
                        this.ExplodingWolf.Unit.x,
                        this.ExplodingWolf.Unit.y,
                        360
                    )!
                    Globals.ALL_WOLVES.set(this.ExplodingWolf.Unit, this.ExplodingWolf)
                    this.ExplodingWolfDesc()
                })
            )
        } catch (e: any) {
            Logger.Warning(`Error in KillExplodingWolf ${e}`)
        }
    }

    private static ExplodingTexttag() {
        this.ExplodingWolf.Texttag ??= TextTag.create()!
        this.ExplodingWolf.Texttag.setText(this.ExplodingWolf.Unit.name, 0.015)
    }

    private static ExplodingWolfDesc() {
        try {
            Utility.MakeUnitLocust(this.ExplodingWolf.Unit)
            let randomPlayer = this.GetRandomPlayerFromLobby()
            this.SetRandomVertexColor(this.ExplodingWolf.Unit, randomPlayer.id)
            this.ExplodingWolf.Unit.name = Utility.FormattedColorPlayerName(randomPlayer)
            this.ExplodingTexttag()
            this.ExplodingWolf.OVERHEAD_EFFECT_PATH = DEFAULT_OVERHEAD_EFFECT
            Globals.DNTNamedWolves.push(this.ExplodingWolf)
        } catch (e: any) {
            Logger.Warning(`Error in ExplodingWolfDesc ${e} ${e.StackTrace}`)
        }
    }

    public static ExplodingWolfCollision(unit: Unit, k: Kitty, shadowKitty: boolean = false) {
        if (CurrentGameMode.active !== GameMode.Standard) return false
        // Guard: ExplodingWolf may not be created yet or may be in a revive window
        if (!this.ExplodingWolf || !this.ExplodingWolf.Unit) return false
        if (unit !== this.ExplodingWolf.Unit) return false
        if (!shadowKitty) Utility.GiveGoldFloatingText(25, k.Unit)
        else Utility.GiveGoldFloatingText(25, k.ShadowKitty.Unit)
        BurntMeat.FlamesDropChance(k)
        this.KillExplodingWolf()
        return true
    }

    private static GetRandomPlayerFromLobby(): MapPlayer {
        return Globals.ALL_PLAYERS[GetRandomInt(0, Globals.ALL_PLAYERS.length - 1)]
    }

    private static SetRandomVertexColor(u: Unit, playerID: number) {
        ColorUtils.SetUnitToVertexColor(u, playerID)
    }
}

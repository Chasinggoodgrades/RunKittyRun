import { Constants } from 'src/AutoGenerated/Constants'
import { MemoryHandler } from 'src/Utility/MemoryHandler/MemoryHandler'
import { Timer, Unit } from 'w3ts'
import { IDisposable } from '../Utility/CSUtils'

export class Disco extends IDisposable {
    public DiscoTimer: Timer
    public Enabled: boolean = false
    public Unit: Unit

    public constructor(u: Unit) {
        super()
        this.Unit = u
        this.DiscoTimer = Timer.create()
    }

    public dispose = () => {
        this.DiscoTimer.pause()
        this.Enabled = false
        MemoryHandler.destroyObject(this)
    }

    public ToggleDisco(enable: boolean) {
        if (this.Unit === null) return

        if (enable) {
            if (this.Enabled) return
            this.Enabled = true
            this.DiscoTimer.start(0.4, true, () => this.DiscoActions())
        } else {
            this.DiscoTimer.pause()
            this.Enabled = false
            if (this.Unit.typeId === Constants.UNIT_KITTY) return
            this.dispose()
        }
    }

    private DiscoActions = () => {
        this.Unit.color = ConvertPlayerColor(GetRandomInt(0, 24))!
        this.Unit.setVertexColor(
            GetRandomPercentageBJ(),
            GetRandomPercentageBJ(),
            GetRandomPercentageBJ(),
            GetRandomReal(0, 25)
        )
    }
}

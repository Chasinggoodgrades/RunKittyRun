import { Timer } from 'w3ts'
import { Regions } from './AutoGenerated/Regions'
import { CommandHandler } from './Events/Commands/CommandHandler'
import { GamemodeManager } from './Events/Commands/GamemodeManager'
import { Globals } from './Global/Globals'
import { RegionList } from './Global/RegionList'
import { BarrierSetup } from './Init/BarrierSetup'
import { Setup } from './Init/Setup'
import { SaveManager } from './SaveSystem2.0/SaveManager'
import { DateTimeManager } from './Seasonal/DateTimeManager'
import { MusicManager } from './Sounds/MusicManager'
import { Quests } from './UI/Quests'
import { Colors } from './Utility/Colors/Colors'
import { ColorUtils } from './Utility/Colors/ColorUtils'
import { ErrorHandler } from './Utility/ErrorHandler'

export class Program {
    public constructor() {
        // Delay a little since some stuff can break otherwise
        let timer = Timer.create()
        timer.start(
            0.01,
            false,
            ErrorHandler.Wrap(() => {
                timer.destroy()
                Program.start()
            })
        )
    }

    private static start() {
        Regions.Initialize()
        RegionList.Initialize()
        Setup.GetActivePlayers()
        DateTimeManager.Initialize()
        MusicManager.Initialize()
        CommandHandler.Initialize()
        GamemodeManager.InitializeCommands()
        SaveManager.Initialize()
        BarrierSetup.Initialize()
        Quests.Initialize()

        let t = Timer.create()
        let count = 0
        print(`${Colors.COLOR_RED}Loading . . . Please wait while everyone synchronizes.${Colors.COLOR_RESET}`)
        t.start(1.0, true, () => {
            count++
            if (!Globals.DATE_TIME_LOADED) return
            if (count < 10) {
                for (let i = 0; i < Globals.ALL_PLAYERS.length; i++) {
                    if (!SaveManager.PlayersLoaded.includes(Globals.ALL_PLAYERS[i])) {
                        print(`Waiting on ${ColorUtils.PlayerNameColored(Globals.ALL_PLAYERS[i])} to synchronize.`)
                        return
                    }
                }
            }
            Setup.Initialize()
            t.pause()
            t.destroy()
        })
    }
}

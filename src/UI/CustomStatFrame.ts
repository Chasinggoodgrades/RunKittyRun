import { Constants } from 'src/AutoGenerated/Constants'
import { PROD } from 'src/env'
import { Logger } from 'src/Events/Logger/Logger'
import { SpawnChampions } from 'src/Game/Entities/Champions/SpawnChampions'
import { CurrentGameMode } from 'src/Gamemodes/CurrentGameMode'
import { GameMode } from 'src/Gamemodes/GameModeEnum'
import { Globals } from 'src/Global/Globals'
import { Colors } from 'src/Utility/Colors/Colors'
import { Utility } from 'src/Utility/Utility'
import { Frame, MapPlayer, Timer, Trigger, Unit } from 'w3ts'

export class CustomStat {
    public Frame: Frame
    public Icon: Frame
    public Text: Frame
    public Hover: Frame
    public ToolTipBox: Frame
    public ToolTipTitle: Frame
    public ToolTipText: Frame
}

export class CustomStatFrame {
    private static Count = 0
    private static CustomStatFrameBoxS: Frame
    private static CustomStatFrameBoxF: Frame

    public static SelectedUnit: Map<MapPlayer, Unit> = new Map()
    private static Stats: CustomStat[] = []
    private static MoveSpeed: string = `${Colors.COLOR_YELLOW_ORANGE}MS:|r`
    private static Time: string = `${Colors.COLOR_YELLOW_ORANGE}Time:|r`
    private static Saves: string = `${Colors.COLOR_YELLOW_ORANGE}Saves:|r`
    private static Deaths: string = `${Colors.COLOR_YELLOW_ORANGE}Deaths:|r`
    private static Streak: string = `${Colors.COLOR_YELLOW_ORANGE}Streak:|r`
    private static Gold: string = `${Colors.COLOR_YELLOW_ORANGE}Gold:|r`
    private static Ratio: string = `${Colors.COLOR_YELLOW_ORANGE}S/D:|r`
    private static Progress: string = `${Colors.COLOR_YELLOW_ORANGE}Prog.:|r`
    private static t: Timer

    public static Add(icon: string, text: string, titleTooltip: string) {
        this.Count++
        let fh = BlzCreateSimpleFrame('CustomStat', CustomStatFrame.CustomStatFrameBoxS.handle, this.Count)
        let tooltipBox = BlzCreateFrame('BoxedText', CustomStatFrame.CustomStatFrameBoxF.handle, 0, this.Count)
        let fhHover = BlzCreateFrameByType(
            'FRAME',
            'CustomStatHover',
            CustomStatFrame.CustomStatFrameBoxF.handle,
            '',
            this.Count
        )

        if (!fhHover || !fh || !tooltipBox) return

        BlzFrameSetPoint(fhHover, FRAMEPOINT_BOTTOMLEFT, fh, FRAMEPOINT_BOTTOMLEFT, 0, 0)
        BlzFrameSetPoint(
            fhHover,
            FRAMEPOINT_TOPRIGHT,
            BlzGetFrameByName('CustomStatText', this.Count)!,
            FRAMEPOINT_TOPRIGHT,
            0,
            0
        )
        BlzFrameSetTooltip(fhHover, tooltipBox)

        BlzFrameSetAbsPoint(tooltipBox, FRAMEPOINT_BOTTOM, 0.6, 0.2)
        BlzFrameSetSize(tooltipBox, 0.15, 0.08)

        BlzFrameSetText(BlzGetFrameByName('CustomStatText', this.Count)!, text)
        BlzFrameSetText(BlzGetFrameByName('BoxedTextTitle', this.Count)!, titleTooltip)
        BlzFrameSetText(BlzGetFrameByName('BoxedTextValue', this.Count)!, text)
        BlzFrameSetTexture(BlzGetFrameByName('CustomStatIcon', this.Count)!, icon, 0, true)

        if (this.Count === 1)
            BlzFrameSetPoint(fh, FRAMEPOINT_TOPLEFT, this.CustomStatFrameBoxS.handle, FRAMEPOINT_TOPLEFT, 0.015, -0.035)
        else if (this.Count === 4)
            BlzFrameSetPoint(
                fh,
                FRAMEPOINT_TOPRIGHT,
                this.CustomStatFrameBoxS.handle,
                FRAMEPOINT_TOPRIGHT,
                -0.06,
                -0.035
            )
        else
            BlzFrameSetPoint(
                fh,
                FRAMEPOINT_TOPLEFT,
                BlzGetFrameByName('CustomStat', this.Count - 1)!,
                FRAMEPOINT_BOTTOMLEFT,
                0,
                -0.005
            )

        let statFrame = new CustomStat()
        this.Stats.push(
            Object.assign(statFrame, {
                Frame: fh,
                Icon: Frame.fromHandle(BlzGetFrameByName('CustomStatIcon', this.Count)),
                Text: Frame.fromHandle(BlzGetFrameByName('CustomStatText', this.Count)),
                Hover: Frame.fromHandle(fhHover),
                ToolTipBox: Frame.fromHandle(tooltipBox),
                ToolTipTitle: Frame.fromHandle(BlzGetFrameByName('BoxedTextTitle', this.Count)),
                ToolTipText: Frame.fromHandle(BlzGetFrameByName('BoxedTextValue', this.Count)),
            })
        )
    }

    public static Update() {
        try {
            let selectedUnit: Unit
            if (!(selectedUnit = this.SelectedUnit.get(MapPlayer.fromLocal())!) /* TODO; Prepend: let */) return
            this.HandleFrameText(selectedUnit)

            this.CustomStatFrameBoxF.visible = this.CustomStatFrameBoxS.visible
        } catch (e: any) {
            Logger.Critical(`Error in CustomStatFrame.Update: ${e}`)
            throw e
        }
    }

    public static Init() {
        BlzLoadTOCFile('war3mapImported\\CustomStat.toc')
        BlzLoadTOCFile('war3mapImported\\BoxedText.toc')

        let hideParent = BlzCreateFrameByType('SIMPLEFRAME', 'HideParent', BlzGetFrameByName('ConsoleUI', 0)!, '', 0)
        if (!hideParent) return
        BlzFrameSetVisible(hideParent, false)
        BlzFrameSetParent(BlzGetFrameByName('SimpleInfoPanelIconDamage', 0)!, hideParent)
        BlzFrameSetParent(BlzGetFrameByName('SimpleInfoPanelIconDamage', 1)!, hideParent)
        BlzFrameSetParent(BlzGetFrameByName('SimpleInfoPanelIconArmor', 2)!, hideParent)
        BlzFrameSetParent(BlzGetFrameByName('SimpleInfoPanelIconRank', 3)!, hideParent)
        BlzFrameSetParent(BlzGetFrameByName('SimpleInfoPanelIconFood', 4)!, hideParent)
        BlzFrameSetParent(BlzGetFrameByName('SimpleInfoPanelIconGold', 5)!, hideParent)
        BlzFrameSetParent(BlzGetFrameByName('SimpleInfoPanelIconHero', 6)!, hideParent)
        BlzFrameSetParent(BlzGetFrameByName('SimpleInfoPanelIconAlly', 7)!, hideParent)

        let trig = Trigger.create()
        trig.addAction(() => {
            let player = MapPlayer.fromHandle(GetTriggerPlayer())!
            let unit = Unit.fromHandle(GetTriggerUnit())!
            CustomStatFrame.SelectedUnit.set(player, unit)
        })

        for (let player of Globals.ALL_PLAYERS)
            if (player.slotState === PLAYER_SLOT_STATE_PLAYING)
                trig.registerPlayerUnitEvent(player, EVENT_PLAYER_UNIT_SELECTED, () => true)

        this.CustomStatFrameBoxS = Frame.fromHandle(
            BlzCreateFrameByType(
                'SIMPLEFRAME',
                'CustomStatFrameBoxSBoss',
                BlzGetFrameByName('SimpleUnitStatsPanel', 0)!,
                '',
                0
            )
        )!
        this.CustomStatFrameBoxF = Frame.fromHandle(
            BlzCreateFrameByType('FRAME', 'CustomStatFrameBoxFBoss', BlzGetOriginFrame(ORIGIN_FRAME_GAME_UI, 0)!, '', 0)
        )!

        this.Add('war3mapImported\\BTNStopwatch.blp', '', 'Score')
        this.Add('ReplaceableTextures\\CommandButtons\\BTNInnerFireOn.blp', '', 'Revives')
        this.Add('ReplaceableTextures\\CommandButtons\\BTNDeath Coil.blp', '', 'Deaths')
        this.Add('ReplaceableTextures\\CommandButtons\\BTNHealingWave.tga', '', 'Streak')
        this.Add('ReplaceableTextures\\CommandButtons\\BTNGoldCoin.blp', '', 'Gold')
        this.Add('ReplaceableTextures\\CommandButtons\\BTNBootsOfSpeed.blp', '', 'Speed')

        this.t = Timer.create()
        this.t.start(0.1, true, () => this.Update())
    }

    private static HandleFrameText(selectedUnit: Unit) {
        if (selectedUnit.typeId === Constants.UNIT_CUSTOM_DOG || selectedUnit.typeId === Constants.UNIT_NITRO_PACER)
            this.SetWolfFrameText(selectedUnit)
        else if (selectedUnit.typeId === Constants.UNIT_KITTY) {
            this.SetCommonFrameText(selectedUnit)
            this.SetGamemodeFrameText(selectedUnit)
        } else if (this.SetChampionFrameText(selectedUnit)) {
        } else {
            // do nothing, particularly buildings and w/e else isnt listed to avoid dictionary errors.
        }
    }

    private static SetChampionFrameText(selectedUnit: Unit) {
        // GetUnitName is an async function, may have been prone to desync, now just reference if its the same unit in memory.
        if (selectedUnit === SpawnChampions.Fieryfox2023) {
            this.Stats[1].Text.text = '|cffff0000Fieryfox|r'
            this.Stats[2].Text.text = '|cffffff00Region: EU|r'
            this.Stats[0].Text.text = '|cffffff00Time: 13:25|r'
            this.Stats[4].Text.text = '|cffffff00Qoz|r'
            this.Stats[5].Text.text = '|cffffff00Region: US|r'
            this.Stats[3].Text.text = '|cffffff00Time: 15:36|r'
        } else if (selectedUnit === SpawnChampions.FandF2023) {
            this.Stats[2].Text.text = '|cffffff00Region: US|r'
            this.Stats[1].Text.text = '|cff00fffAches|r'
            this.Stats[3].Text.text = '|cff00fffBranFlake|r'
            this.Stats[5].Text.text = '|cffffff00Time: 23:12|r'
            this.Stats[4].Text.text = '|cff00fffBalmydrop|r'
            this.Stats[0].Text.text = '|cff00fffUdo|r'
        } else if (selectedUnit === SpawnChampions.Fieryfox2024) {
            this.Stats[1].Text.text = '|cffff0000Fieryfox|r'
            this.Stats[2].Text.text = '|cffffff00Region: EU|r'
            this.Stats[0].Text.text = '|cffffff00Time: 13:23|r'
            this.Stats[4].Text.text = '|cff964bc8MrGheed|r'
            this.Stats[5].Text.text = '|cffffff00Region: US|r'
            this.Stats[3].Text.text = '|cffffff00Time: 16:31|r'
        } else if (selectedUnit === SpawnChampions.Stan2025) {
            this.Stats[0].Text.text = '|cffffff00Time: 14:25|r'
            this.Stats[1].Text.text = '|cffa471e3Stan|r'
            this.Stats[2].Text.text = '|cffffff00Region: EU|r'
            this.Stats[3].Text.text = '|cffffff00Time: 14:56|r'
            this.Stats[4].Text.text = '|cff964bc8Balmydrop|r'
            this.Stats[5].Text.text = '|cffffff00Region: US|r'
        } else return false
        return true
    }

    private static SetWolfFrameText(selectedUnit: Unit) {
        this.Stats[0].Text.text = ''
        this.Stats[1].Text.text = ''
        this.Stats[2].Text.text = ''
        this.Stats[3].Text.text = ''
        //Stats[4].Text.text = "";
        if (selectedUnit.typeId === Constants.UNIT_CUSTOM_DOG) this.SetWolfAffixTexts(selectedUnit)
        if (!PROD && selectedUnit.typeId === Constants.UNIT_CUSTOM_DOG)
            this.Stats[4].Text.text = `Walk: ${Globals.ALL_WOLVES.get(selectedUnit)!.IsWalking}`
        this.Stats[5].Text.text = `${CustomStatFrame.MoveSpeed} ${selectedUnit.moveSpeed}`
    }

    private static SetWolfAffixTexts(selectedUnit: Unit) {
        if (CurrentGameMode.active === GameMode.SoloTournament) return
        let wolf
        if (!(wolf = Globals.ALL_WOLVES.get(selectedUnit)) /* TODO; Prepend: let */) return

        let affixes = wolf.Affixes

        for (let i = 0; i < affixes.length; i++) {
            this.Stats[i].Text.text = affixes[i].name
        }
    }

    private static SetGamemodeFrameText(selectedUnit: Unit) {
        if (CurrentGameMode.active === GameMode.Standard) {
            // Standard
            CustomStatFrame.Stats[3].Text.setText(
                `${CustomStatFrame.Streak} ${CustomStatFrame.GetPlayerSaveStreak(selectedUnit)}`
            )
            CustomStatFrame.Stats[0].Text.setText(
                `${CustomStatFrame.Ratio} ${Colors.COLOR_GREEN}${CustomStatFrame.GetCurrentRoundSaves(selectedUnit)}|r/${Colors.COLOR_RED}${CustomStatFrame.GetCurrentRoundDeaths(selectedUnit)}|r`
            )
            CustomStatFrame.Stats[1].Text.setText(
                `${CustomStatFrame.Saves} ${Colors.COLOR_GREEN}${CustomStatFrame.GetPlayerSaves(selectedUnit)}|r`
            )
        } else if (CurrentGameMode.active === GameMode.SoloTournament) {
            // Solo
            CustomStatFrame.Stats[0].Text.setText(
                `${CustomStatFrame.Time} ${CustomStatFrame.GetPlayerTime(selectedUnit)}`
            )
            CustomStatFrame.Stats[1].Text.setText(
                `${CustomStatFrame.Progress} ${CustomStatFrame.GetPlayerProgress(selectedUnit)}%`
            )
            CustomStatFrame.Stats[2].Text.setText(
                `${CustomStatFrame.Deaths} ${CustomStatFrame.GetGameTotalDeaths(selectedUnit)}`
            )
        } else if (CurrentGameMode.active === GameMode.TeamTournament) {
            // Team
            CustomStatFrame.Stats[0].Text.setText(`${CustomStatFrame.GetPlayerTeamName(selectedUnit)}`)
            CustomStatFrame.Stats[4].Text.setText(`${CustomStatFrame.GetPlayerProgress(selectedUnit)}%`)
            CustomStatFrame.Stats[1].Text.setText(
                `${CustomStatFrame.Saves} ${CustomStatFrame.GetGameTotalSaves(selectedUnit)}`
            )
            CustomStatFrame.Stats[2].Text.setText(
                `${CustomStatFrame.Deaths} ${CustomStatFrame.GetGameTotalDeaths(selectedUnit)}`
            )
        }
    }

    private static SetCommonFrameText(selectedUnit: Unit) {
        CustomStatFrame.Stats[4].Text.setText(`${CustomStatFrame.Gold} ${CustomStatFrame.GetPlayerGold(selectedUnit)}`)
        CustomStatFrame.Stats[5].Text.setText(`${CustomStatFrame.MoveSpeed} ${selectedUnit.moveSpeed}`)
        CustomStatFrame.Stats[2].Text.setText(
            `${CustomStatFrame.Deaths} ${Colors.COLOR_RED}${CustomStatFrame.GetPlayerDeaths(selectedUnit)}|r`
        )
    }

    private static GetPlayerTeamName(u: Unit) {
        let team: any
        return (team = Globals.PLAYERS_TEAMS.get(u.owner) /* TODO; Prepend: Team */
            ? team.TeamColor
            : `${Colors.COLOR_YELLOW_ORANGE}Team: Aches${Colors.COLOR_RESET}`)
    }

    private static GetPlayerGold(u: Unit) {
        return u.owner.getGold()
    }

    private static GetPlayerProgress(u: Unit) {
        return Globals.ALL_KITTIES.get(u.owner)!.TimeProg.GetRoundProgress(Globals.ROUND).toFixed(2)
    }

    private static GetPlayerSaves(u: Unit) {
        return Globals.ALL_KITTIES.get(u.owner)!.SaveData.GameStats.Saves
    }

    private static GetPlayerDeaths(u: Unit) {
        return Globals.ALL_KITTIES.get(u.owner)!.SaveData.GameStats.Deaths
    }

    private static GetPlayerSaveStreak(u: Unit) {
        return Globals.ALL_KITTIES.get(u.owner)!.SaveData.GameStats.SaveStreak
    }

    private static GetPlayerTime(u: Unit) {
        return Utility.ConvertFloatToTime(Globals.ALL_KITTIES.get(u.owner)!.TimeProg.GetRoundTime(Globals.ROUND))
    }

    private static GetCurrentRoundSaves(u: Unit) {
        return Globals.ALL_KITTIES.get(u.owner)!.CurrentStats.RoundSaves
    }

    private static GetCurrentRoundDeaths(u: Unit) {
        return Globals.ALL_KITTIES.get(u.owner)!.CurrentStats.RoundDeaths
    }

    private static GetGameTotalSaves(u: Unit) {
        return Globals.ALL_KITTIES.get(u.owner)!.CurrentStats.TotalSaves
    }

    private static GetGameTotalDeaths(u: Unit) {
        return Globals.ALL_KITTIES.get(u.owner)!.CurrentStats.TotalDeaths
    }
}

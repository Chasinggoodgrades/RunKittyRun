import { Constants } from 'src/AutoGenerated/Constants'
import { Logger } from 'src/Events/Logger/Logger'
import { SpawnChampions } from 'src/Game/Entities/Champions/SpawnChampions'
import { Gamemode } from 'src/Gamemodes/Gamemode'
import { GameMode } from 'src/Gamemodes/GameModeEnum'
import { Globals } from 'src/Global/Globals'
import { Program } from 'src/Program'
import { Action } from 'src/Utility/CSUtils'
import { Utility } from 'src/Utility/Utility'
import { blzCreateFrame, blzCreateFrameByType, getTriggerPlayer, getTriggerUnit } from 'src/Utility/w3tsUtils'
import { Frame, MapPlayer, Timer, Trigger, Unit } from 'w3ts'
import { blzGetFrameByName } from '../Utility/w3tsUtils'

export class CustomStat {
    public Frame: Frame
    public Icon: Frame
    public Text: Frame
    public Hover: Frame
    public ToolTipBox: Frame
    public ToolTipTitle: Frame
    public ToolTipText: Frame
}

export class CustomStatFrame {
    private static Count: number = 0
    private static CustomStatFrameBoxS: Frame
    private static CustomStatFrameBoxF: Frame

    public static SelectedUnit: Map<MapPlayer, unit> = new Map()
    private static Stats: CustomStat[] = []
    private static MoveSpeed: string = '{Colors.COLOR_YELLOW_ORANGE}MS:|r'
    private static Time: string = '{Colors.COLOR_YELLOW_ORANGE}Time:|r'
    private static Saves: string = '{Colors.COLOR_YELLOW_ORANGE}Saves:|r'
    private static Deaths: string = '{Colors.COLOR_YELLOW_ORANGE}Deaths:|r'
    private static Streak: string = '{Colors.COLOR_YELLOW_ORANGE}Streak:|r'
    private static Gold: string = '{Colors.COLOR_YELLOW_ORANGE}Gold:|r'
    private static Ratio: string = '{Colors.COLOR_YELLOW_ORANGE}S/D:|r'
    private static Progress: string = '{Colors.COLOR_YELLOW_ORANGE}Prog.:|r'

    private static readonly _cacheUpdate: Action = CustomStatFrame.Update

    private static t: Timer

    public static Add(icon: string, text: string, titleTooltip: string) {
        CustomStatFrame.Count++
        let fh: Frame = Frame.createSimple('CustomStat', CustomStatFrame.CustomStatFrameBoxS, CustomStatFrame.Count)!
        let tooltipBox: Frame = blzCreateFrame(
            'BoxedText',
            CustomStatFrame.CustomStatFrameBoxF,
            0,
            CustomStatFrame.Count
        )
        let fhHover: Frame = blzCreateFrameByType(
            'FRAME',
            'CustomStatHover',
            CustomStatFrame.CustomStatFrameBoxF,
            '',
            CustomStatFrame.Count
        )

        fhHover.setPoint(FRAMEPOINT_BOTTOMLEFT, fh, FRAMEPOINT_BOTTOMLEFT, 0, 0)
        fhHover.setPoint(
            FRAMEPOINT_TOPRIGHT,
            blzGetFrameByName('CustomStatText', CustomStatFrame.Count),
            FRAMEPOINT_TOPRIGHT,
            0,
            0
        )
        fhHover.setTooltip(tooltipBox)

        tooltipBox.setAbsPoint(FRAMEPOINT_BOTTOM, 0.6, 0.2)
        tooltipBox.setSize(0.15, 0.08)

        blzGetFrameByName('CustomStatText', CustomStatFrame.Count).setText(text)
        blzGetFrameByName('BoxedTextTitle', CustomStatFrame.Count).setText(titleTooltip)
        blzGetFrameByName('BoxedTextValue', CustomStatFrame.Count).setText(text)
        blzGetFrameByName('CustomStatIcon', CustomStatFrame.Count).setTexture(icon, 0, true)

        if (CustomStatFrame.Count == 1)
            fh.setPoint(FRAMEPOINT_TOPLEFT, CustomStatFrame.CustomStatFrameBoxS, FRAMEPOINT_TOPLEFT, 0.015, -0.035)
        else if (CustomStatFrame.Count == 4)
            fh.setPoint(FRAMEPOINT_TOPRIGHT, CustomStatFrame.CustomStatFrameBoxS, FRAMEPOINT_TOPRIGHT, -0.06, -0.035)
        else
            fh.setPoint(
                FRAMEPOINT_TOPLEFT,
                blzGetFrameByName('CustomStat', CustomStatFrame.Count - 1),
                FRAMEPOINT_BOTTOMLEFT,
                0,
                -0.005
            )

        this.Stats.push(
            Object.assign(new CustomStat(), {
                Frame: fh,
                Icon: blzGetFrameByName('CustomStatIcon', CustomStatFrame.Count),
                Text: blzGetFrameByName('CustomStatText', CustomStatFrame.Count),
                Hover: fhHover,
                ToolTipBox: tooltipBox,
                ToolTipTitle: blzGetFrameByName('BoxedTextTitle', CustomStatFrame.Count),
                ToolTipText: blzGetFrameByName('BoxedTextValue', CustomStatFrame.Count),
            })
        )
    }

    public static Update() {
        try {
            if (!(selectedUnit = CustomStatFrame.SelectedUnit.TryGetValue(player.LocalPlayer)) /* TODO; Prepend: let */)
                return

            CustomStatFrame.HandleFrameText(selectedUnit)

            CustomStatFrame.CustomStatFrameBoxF.visible = CustomStatFrame.CustomStatFrameBoxS.visible
        } catch (e: any) {
            Logger.Critical('Error in CustomStatFrame.Update: {e.Message}')
            throw e
        }
    }

    public static Init() {
        BlzLoadTOCFile('war3mapImported\\CustomStat.toc')
        BlzLoadTOCFile('war3mapImported\\BoxedText.toc')

        let hideParent = blzCreateFrameByType('SIMPLEFRAME', 'HideParent', blzGetFrameByName('ConsoleUI', 0), '', 0)
        hideParent.visible = false
        BlzFrameSetParent(blzGetFrameByName('SimpleInfoPanelIconDamage', 0), hideParent)
        BlzFrameSetParent(blzGetFrameByName('SimpleInfoPanelIconDamage', 1), hideParent)
        BlzFrameSetParent(blzGetFrameByName('SimpleInfoPanelIconArmor', 2), hideParent)
        BlzFrameSetParent(blzGetFrameByName('SimpleInfoPanelIconRank', 3), hideParent)
        BlzFrameSetParent(blzGetFrameByName('SimpleInfoPanelIconFood', 4), hideParent)
        BlzFrameSetParent(blzGetFrameByName('SimpleInfoPanelIconGold', 5), hideParent)
        BlzFrameSetParent(blzGetFrameByName('SimpleInfoPanelIconHero', 6), hideParent)
        BlzFrameSetParent(blzGetFrameByName('SimpleInfoPanelIconAlly', 7), hideParent)

        let trig: Trigger = trigger.Create()
        trig.addAction(() => {
            let player = getTriggerPlayer()
            let unit = getTriggerUnit()
            CustomStatFrame.SelectedUnit[player] = unit
        })

        for (let player of Globals.ALL_PLAYERS)
            if (player.slotState == PLAYER_SLOT_STATE_PLAYING)
                trig.registerPlayerUnitEvent(player, playerunitevent.Selected, null)

        CustomStatFrame.CustomStatFrameBoxS = blzCreateFrameByType(
            'SIMPLEFRAME',
            'CustomStatFrameBoxSBoss',
            blzGetFrameByName('SimpleUnitStatsPanel', 0),
            '',
            0
        )
        CustomStatFrame.CustomStatFrameBoxF = blzCreateFrameByType(
            'FRAME',
            'CustomStatFrameBoxFBoss',
            BlzGetOriginFrame(ORIGIN_FRAME_GAME_UI, 0),
            '',
            0
        )

        CustomStatFrame.Add('war3mapImported\\BTNStopwatch.blp', '', 'Score')
        CustomStatFrame.Add('ReplaceableTextures\\CommandButtons\\BTNInnerFireOn.blp', '', 'Revives')
        CustomStatFrame.Add('ReplaceableTextures\\CommandButtons\\Coil: BTNDeath.blp', '', 'Deaths')
        CustomStatFrame.Add('ReplaceableTextures\\CommandButtons\\BTNHealingWave.tga', '', 'Streak')
        CustomStatFrame.Add('ReplaceableTextures\\CommandButtons\\BTNGoldCoin.blp', '', 'Gold')
        CustomStatFrame.Add('ReplaceableTextures\\CommandButtons\\BTNBootsOfSpeed.blp', '', 'Speed')

        CustomStatFrame.t = Timer.create()
        CustomStatFrame.t.start(0.1, true, CustomStatFrame._cacheUpdate)
    }

    private static HandleFrameText(selectedUnit: Unit) {
        if (selectedUnit.typeId == Constants.UNIT_CUSTOM_DOG || selectedUnit.typeId == Constants.UNIT_NITRO_PACER)
            CustomStatFrame.SetWolfFrameText(selectedUnit)
        else if (selectedUnit.typeId == Constants.UNIT_KITTY) {
            CustomStatFrame.SetCommonFrameText(selectedUnit)
            CustomStatFrame.SetGamemodeFrameText(selectedUnit)
        } else if (CustomStatFrame.SetChampionFrameText(selectedUnit)) {
        } else {
            // do nothing, particularly buildings and w/e else isnt listed to avoid dictionary errors.
        }
    }

    private static SetChampionFrameText(selectedUnit: Unit) {
        // GetUnitName is an async function, may have been prone to desync, now just reference if its the same unit in memory.
        if (selectedUnit == SpawnChampions.Fieryfox2023) {
            CustomStatFrame.Stats[1].Text.text = '|cffff0000Fieryfox|r'
            CustomStatFrame.Stats[2].Text.text = '|cffffff00Region:|EU: r'
            CustomStatFrame.Stats[0].Text.text = '|cffffff00Time:|13: r:25'
            CustomStatFrame.Stats[4].Text.text = '|cffffff00Qoz|r'
            CustomStatFrame.Stats[5].Text.text = '|cffffff00Region:|US: r'
            CustomStatFrame.Stats[3].Text.text = '|cffffff00Time:|15: r:36'
        } else if (selectedUnit == SpawnChampions.FandF2023) {
            CustomStatFrame.Stats[2].Text.text = '|cffffff00Region:|US: r'
            CustomStatFrame.Stats[1].Text.text = '|cff00fffAches|r'
            CustomStatFrame.Stats[3].Text.text = '|cff00fffBranFlake|r'
            CustomStatFrame.Stats[5].Text.text = '|cffffff00Time:|23: r:12'
            CustomStatFrame.Stats[4].Text.text = '|cff00fffBalmydrop|r'
            CustomStatFrame.Stats[0].Text.text = '|cff00fffUdo|r'
        } else if (selectedUnit == SpawnChampions.Fieryfox2024) {
            CustomStatFrame.Stats[1].Text.text = '|cffff0000Fieryfox|r'
            CustomStatFrame.Stats[2].Text.text = '|cffffff00Region:|EU: r'
            CustomStatFrame.Stats[0].Text.text = '|cffffff00Time:|13: r:23'
            CustomStatFrame.Stats[4].Text.text = '|cff964bc8MrGheed|r'
            CustomStatFrame.Stats[5].Text.text = '|cffffff00Region:|US: r'
            CustomStatFrame.Stats[3].Text.text = '|cffffff00Time:|16: r:31'
        } else if (selectedUnit == SpawnChampions.Stan2025) {
            CustomStatFrame.Stats[0].Text.text = '|cffffff00Time:|14: r:25'
            CustomStatFrame.Stats[1].Text.text = '|cffa471e3Stan|r'
            CustomStatFrame.Stats[2].Text.text = '|cffffff00Region:|EU: r'
            CustomStatFrame.Stats[3].Text.text = '|cffffff00Time:|14: r:56'
            CustomStatFrame.Stats[4].Text.text = '|cff964bc8Balmydrop|r'
            CustomStatFrame.Stats[5].Text.text = '|cffffff00Region:|US: r'
        } else return false
        return true
    }

    private static SetWolfFrameText(selectedUnit: Unit) {
        CustomStatFrame.Stats[0].Text.text = ''
        CustomStatFrame.Stats[1].Text.text = ''
        CustomStatFrame.Stats[2].Text.text = ''
        CustomStatFrame.Stats[3].Text.text = ''
        //Stats[4].Text.text = "";
        if (selectedUnit.typeId == Constants.UNIT_CUSTOM_DOG) CustomStatFrame.SetWolfAffixTexts(selectedUnit)
        if (Program.Debug && selectedUnit.typeId == Constants.UNIT_CUSTOM_DOG)
            CustomStatFrame.Stats[4].Text.text = 'Walk: {Globals.ALL_WOLVES[selectedUnit].IsWalking}'
        CustomStatFrame.Stats[5].Text.text = `{MoveSpeed} ${selectedUnit.moveSpeed}`
    }

    private static SetWolfAffixTexts(selectedUnit: Unit) {
        if (Gamemode.CurrentGameMode == GameMode.SoloTournament) return
        let wolf
        if (!(wolf = Globals.ALL_WOLVES.TryGetValue(selectedUnit)) /* TODO; Prepend: let */) return

        let affixes = wolf.Affixes

        for (let i = 0; i < affixes.length; i++) {
            CustomStatFrame.Stats[i].Text.text = affixes[i].name
        }
    }

    private static SetGamemodeFrameText(selectedUnit: Unit) {
        if (Gamemode.CurrentGameMode == GameMode.Standard) {
            // Standard
            CustomStatFrame.Stats[3].Text.setText('{Streak} {GetPlayerSaveStreak(selectedUnit)}')
            CustomStatFrame.Stats[0].Text.setText(
                '{Ratio} {Colors.COLOR_GREEN}{GetCurrentRoundSaves(selectedUnit)}|r/{Colors.COLOR_RED}{GetCurrentRoundDeaths(selectedUnit)}|r'
            )
            CustomStatFrame.Stats[1].Text.setText('{Saves} {Colors.COLOR_GREEN}{GetPlayerSaves(selectedUnit)}|r')
        } else if (Gamemode.CurrentGameMode == GameMode.SoloTournament) {
            // Solo
            CustomStatFrame.Stats[0].Text.setText('{Time} {GetPlayerTime(selectedUnit)}')
            CustomStatFrame.Stats[1].Text.setText('{Progress} {GetPlayerProgress(selectedUnit)}%')
            CustomStatFrame.Stats[2].Text.setText('{Deaths} {GetGameTotalDeaths(selectedUnit)}')
        } else if (Gamemode.CurrentGameMode == GameMode.TeamTournament) {
            // Team
            CustomStatFrame.Stats[0].Text.setText('{GetPlayerTeamName(selectedUnit)}')
            CustomStatFrame.Stats[4].Text.setText('{GetPlayerProgress(selectedUnit)}%')
            CustomStatFrame.Stats[1].Text.setText('{Saves} {GetGameTotalSaves(selectedUnit)}')
            CustomStatFrame.Stats[2].Text.setText('{Deaths} {GetGameTotalDeaths(selectedUnit)}')
        }
    }

    private static SetCommonFrameText(selectedUnit: Unit) {
        CustomStatFrame.Stats[4].Text.setText('{Gold} {GetPlayerGold(selectedUnit)}')
        CustomStatFrame.Stats[5].Text.setText(`${CustomStatFrame.MoveSpeed} ${selectedUnit.moveSpeed}`)
        CustomStatFrame.Stats[2].Text.setText('{Deaths} {Colors.COLOR_RED}{GetPlayerDeaths(selectedUnit)}|r')
    }

    private static GetPlayerTeamName(u: Unit) {
        let team
        return (team = Globals.PLAYERS_TEAMS.TryGetValue(u.owner) /* TODO; Prepend: Team */
            ? team.TeamColor
            : '{Colors.COLOR_YELLOW_ORANGE}Aches: Team{Colors.COLOR_RESET}')
    }

    private static GetPlayerGold(u: Unit) {
        return u.owner.Gold
    }

    private static GetPlayerProgress(u: Unit) {
        return Globals.ALL_KITTIES.get(u.owner)!.TimeProg.GetRoundProgress(Globals.ROUND).toFixed(2)
    }

    private static GetPlayerSaves(u: Unit) {
        return Globals.ALL_KITTIES.get(u.owner)!.SaveData.GameStats.Saves
    }

    private static GetPlayerDeaths(u: Unit) {
        return Globals.ALL_KITTIES.get(u.owner)!.SaveData.GameStats.Deaths
    }

    private static GetPlayerSaveStreak(u: Unit) {
        return Globals.ALL_KITTIES.get(u.owner)!.SaveData.GameStats.SaveStreak
    }

    private static GetPlayerTime(u: Unit) {
        return Utility.ConvertFloatToTime(Globals.ALL_KITTIES.get(u.owner)!.TimeProg.GetRoundTime(Globals.ROUND))
    }

    private static GetCurrentRoundSaves(u: Unit) {
        return Globals.ALL_KITTIES.get(u.owner)!.CurrentStats.RoundSaves
    }

    private static GetCurrentRoundDeaths(u: Unit) {
        return Globals.ALL_KITTIES.get(u.owner)!.CurrentStats.RoundDeaths
    }

    private static GetGameTotalSaves(u: Unit) {
        return Globals.ALL_KITTIES.get(u.owner)!.CurrentStats.TotalSaves
    }

    private static GetGameTotalDeaths(u: Unit) {
        return Globals.ALL_KITTIES.get(u.owner)!.CurrentStats.TotalDeaths
    }
}

import { Constants } from 'src/AutoGenerated/Constants'
import { Regions } from 'src/AutoGenerated/Regions'
import { SpawnChampions } from 'src/Game/Entities/Champions/SpawnChampions'
import { Kitty } from 'src/Game/Entities/Kitty/Kitty'
import { CurrentGameMode } from 'src/Gamemodes/CurrentGameMode'
import { GameMode } from 'src/Gamemodes/GameModeEnum'
import { Globals } from 'src/Global/Globals'
import { AwardManager } from 'src/Rewards/Rewards/AwardManager'
import { Colors } from 'src/Utility/Colors/Colors'
import { ColorUtils } from 'src/Utility/Colors/ColorUtils'
import { ErrorHandler } from 'src/Utility/ErrorHandler'
import { RemoveItemFromUnit } from 'src/Utility/UnitUtility'
import { Utility } from 'src/Utility/Utility'
import { getTriggerPlayer, getTriggerUnit } from 'src/Utility/w3tsUtils'
import { MapPlayer, Trigger, Unit } from 'w3ts'

export class CrystalOfFire {
    private static ItemID: number
    private static TurnInRange: number
    private static TurnInEventFieryfox: Trigger
    private static TurnInEventFandF: Trigger
    private static QuestAccept: Trigger
    private static QuestEligible: MapPlayer[]

    public static Initialize() {
        CrystalOfFire.ItemID = Constants.ITEM_CRYSTAL_OF_FIRE
        CrystalOfFire.TurnInRange = 150.0
        CrystalOfFire.TurnInEventFieryfox = CrystalOfFire.RegisterTurnInFiery()
        CrystalOfFire.TurnInEventFandF = CrystalOfFire.RegisterTurnInFandF()
        CrystalOfFire.QuestAccept = CrystalOfFire.RegisterChatEvent()
        CrystalOfFire.QuestEligible = []
    }

    public static AwardCrystalOfFire(unit: Unit) {
        return unit.addItemById(CrystalOfFire.ItemID)
    }

    public static CrystalOfFireDeath(kitty: Kitty) {
        if (CurrentGameMode.active !== GameMode.Standard) return
        kitty.CurrentStats.CrystalOfFireAttempts++
    }

    private static RegisterTurnInFiery(): Trigger {
        const triggerHandle = Trigger.create()!
        triggerHandle.registerUnitInRage(SpawnChampions.Fieryfox2023.handle, CrystalOfFire.TurnInRange, undefined)
        triggerHandle.addAction(ErrorHandler.Wrap(() => CrystalOfFire.FieryfoxEvent()))
        return triggerHandle
    }

    private static RegisterTurnInFandF(): Trigger {
        const triggerHandle = Trigger.create()!
        triggerHandle.registerUnitInRage(SpawnChampions.FandF2023.handle, CrystalOfFire.TurnInRange, undefined)
        triggerHandle.addAction(ErrorHandler.Wrap(() => CrystalOfFire.FandFEvent()))
        return triggerHandle
    }

    private static RegisterChatEvent(): Trigger {
        const triggerHandle = Trigger.create()!
        for (const player of Globals.ALL_PLAYERS) {
            triggerHandle.registerPlayerChatEvent(player, 'yes!', false)
        }
        triggerHandle.addAction(ErrorHandler.Wrap(() => CrystalOfFire.AcceptedQuest()))
        return triggerHandle
    }

    private static GetDeathAttempts(player: MapPlayer) {
        const kitty = Globals.ALL_KITTIES.get(player)!
        return kitty.CurrentStats.CrystalOfFireAttempts
    }

    private static StartMessage(player: MapPlayer) {
        return `${Colors.COLOR_YELLOW}Greetings ${ColorUtils.PlayerNameColored(player)}${Colors.COLOR_YELLOW}, you were right to come to me about CrystalOfFire. The Crystals of Fire are a sacred anomaly within CrystalOfFire universe... However, I'm not sure you're quite worthy of it... Prove me wrong... Return to me without any scratches and you may proceed. (May be attempted multiple times)|r ${Colors.COLOR_RED}Type ${Colors.COLOR_YELLOW_ORANGE}"yes!"|r${Colors.COLOR_RED} to accept! (30 seconds)|r`
    }

    private static PartTwoMessage(player: MapPlayer): string {
        return (
            `${Colors.COLOR_YELLOW}It appears you're ready. Here's the formula: Bring forth to the legends of F&F: |r${Colors.COLOR_YELLOW_ORANGE}1 mysterious orb, A shot of lightning, The Crystals of Fire and a pair of Pegasus's.|r` +
            `${Colors.COLOR_YELLOW} However, CrystalOfFire must be done without scratches!|r ${Colors.COLOR_RED}(If failed, you'll have to redo the first challenge).|r`
        )
    }

    private static FieryfoxEvent() {
        if (!Utility.UnitHasItem(getTriggerUnit(), CrystalOfFire.ItemID)) return
        const player = getTriggerUnit().owner
        if (CrystalOfFire.GetDeathAttempts(player) >= 0) {
            player.DisplayTextTo(CrystalOfFire.StartMessage(player))
            CrystalOfFire.QuestEligible.push(player)
            // 30 seconds to accept the quest.
            Utility.SimpleTimer(30.0, () => {
                if (CrystalOfFire.QuestEligible.includes(player))
                    CrystalOfFire.QuestEligible.splice(CrystalOfFire.QuestEligible.indexOf(player), 1)
            })
        } else if (CrystalOfFire.GetDeathAttempts(player) === -1) {
            player.DisplayTextTo(CrystalOfFire.PartTwoMessage(player))
        }
    }

    private static AcceptedQuest() {
        const player = getTriggerPlayer()
        if (!CrystalOfFire.QuestEligible.includes(player)) return
        const kitty = Globals.ALL_KITTIES.get(player)!
        kitty.Unit.setPosition(Regions.Spawn_Area_05.centerX, Regions.Spawn_Area_05.centerY)
        kitty.CurrentStats.CrystalOfFireAttempts = -1
        Utility.ClearScreen(player)
        player.DisplayTimedTextTo(
            5.0,
            `${Colors.COLOR_YELLOW_ORANGE}You've accepted the quest. Make it to Fieryfox without dying to proceed.|r`
        )
        CrystalOfFire.QuestEligible.splice(CrystalOfFire.QuestEligible.indexOf(player), 1)
    }

    private static FandFEvent() {
        const unit = getTriggerUnit()
        if (!Utility.UnitHasItem(unit, CrystalOfFire.ItemID)) return
        const player = unit.owner
        if (CrystalOfFire.GetDeathAttempts(player) !== -1) return

        const lightningShot = Constants.ITEM_ADRENALINE_POTION
        const orb = Constants.ITEM_ORB_OF_MYSTERIES
        const boots = Constants.ITEM_PEGASUS_BOOTS

        // Must have these items
        if (!Utility.UnitHasItem(unit, boots)) return
        if (!Utility.UnitHasItem(unit, orb)) return
        if (!Utility.UnitHasItem(unit, lightningShot)) return

        // Remove Items
        RemoveItemFromUnit(unit, CrystalOfFire.ItemID)
        RemoveItemFromUnit(unit, boots)
        RemoveItemFromUnit(unit, orb)
        RemoveItemFromUnit(unit, lightningShot)

        // ADD TEXT DISPLAY HERE FOR F&F

        AwardManager.GiveReward(player, 'WWFire')
    }
}

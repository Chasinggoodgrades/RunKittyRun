import { Constants } from 'src/AutoGenerated/Constants'
import { SpawnChampions } from 'src/Game/Entities/Champions/SpawnChampions'
import { RegionList } from 'src/Global/RegionList'
import { AwardManager } from 'src/Rewards/Rewards/AwardManager'
import { ErrorHandler } from 'src/Utility/ErrorHandler'
import { getTriggerUnit } from 'src/Utility/w3tsUtils'
import { Item, Trigger } from 'w3ts'

export class MissingShoe {
    private static TimerEvent: Trigger
    private static TurnInEvent: Trigger
    private static ItemID: number
    private static Shoe: Item
    private static TurnInRange: number

    public static Initialize = () => {
        MissingShoe.RegisterSpawnEvent()
        MissingShoe.ItemID = Constants.ITEM_FIERYFOX_S_MISSING_SHOE
        MissingShoe.TurnInRange = 200.0
    }

    private static RegisterSpawnEvent = () => {
        // Between 10 mins - 15mins currently.
        const randomTime = GetRandomReal(600.0, 900.0)
        MissingShoe.TimerEvent = Trigger.create()!
        MissingShoe.TimerEvent.registerTimerEvent(randomTime, false)
        MissingShoe.TimerEvent.addAction(ErrorHandler.Wrap(() => MissingShoe.EventStart()))
    }

    private static RegisterTurnInEvent = () => {
        MissingShoe.TurnInEvent = Trigger.create()!
        MissingShoe.TurnInEvent.registerUnitInRage(
            SpawnChampions.Fieryfox2023.handle,
            MissingShoe.TurnInRange,
            undefined
        )
        MissingShoe.TurnInEvent.registerUnitInRage(
            SpawnChampions.Fieryfox2024.handle,
            MissingShoe.TurnInRange,
            undefined
        )
        MissingShoe.TurnInEvent.addAction(ErrorHandler.Wrap(() => MissingShoe.TurnInActions()))
    }

    // Ping Event + Shoe Spawn
    private static EventStart = () => {
        const randomWolfRegion = RegionList.WolfRegions[GetRandomInt(0, RegionList.WolfRegions.length - 1)]
        const randomX = GetRandomReal(randomWolfRegion.minX, randomWolfRegion.maxX)
        const randomY = GetRandomReal(randomWolfRegion.minY, randomWolfRegion.maxY)
        MissingShoe.Shoe = Item.create(MissingShoe.ItemID, randomX, randomY)!
        PingMinimapEx(randomX, randomY, 10.0, 255, 0, 0, true)
        MissingShoe.RegisterTurnInEvent()
    }

    private static TurnInActions = () => {
        if (!getTriggerUnit().hasItem(MissingShoe.Shoe)) return
        getTriggerUnit().removeItem(MissingShoe.Shoe)
        SpawnChampions.Fieryfox2023.addItem(MissingShoe.Shoe)
        AwardManager.GiveRewardAll('RedTendrils')
    }
}

import { Constants } from "src/AutoGenerated/Constants"
import { SpawnChampions } from "src/Game/Entities/Champions/SpawnChampions"
import { Kitty } from "src/Game/Entities/Kitty/Kitty"
import { NamedWolves } from "src/Game/Entities/NamedWolves"
import { ErrorHandler } from "src/Utility/ErrorHandler"
import { Utility } from "src/Utility/Utility"
import { getKillingUnit, getTriggerUnit } from "src/Utility/w3tsUtils"
import { Trigger, Unit } from "w3ts"
import { Challenges } from "../Challenges/Challenges"

export class BurntMeat {
    private static StanDeath: Trigger = Trigger.create()!
    private static StanTurnIn: Trigger = Trigger.create()!
    private static StanDeathActions: triggeraction
    private static StanTurnInActions: triggeraction
    private static ITEM_CLOAK_FLAMES: number = Constants.ITEM_CLOAK_OF_FLAMES
    private static ITEM_BURNT_MEAT: number = Constants.ITEM_WOLF_MEAT
    private static Completed: Unit[] = []

    public static FlamesDropChance(k: Kitty) {
        let randomRoll = GetRandomInt(1, 100)
        if (randomRoll > 8) return // 8% chance
        k.Unit.addItemById(this.ITEM_CLOAK_FLAMES)
    }

    public static RegisterDeathTrigger() {
        this.StanDeath.registerUnitEvent(NamedWolves.StanWolf.Unit, EVENT_UNIT_DEATH)
        if (this.StanDeathActions != null) return
        this.RegisterTurnInTrigger()
        this.StanDeathActions = this.StanDeath.addAction(
            ErrorHandler.Wrap(() => {
                let killer = getKillingUnit()
                if (killer == null) return
                NamedWolves.StanWolf.Texttag?.destroy()
                Utility.RemoveItemFromUnit(killer, this.ITEM_CLOAK_FLAMES)
                killer.addItemById(this.ITEM_BURNT_MEAT)
                this.Completed.push(killer)
            })
        )
    }

    private static RegisterTurnInTrigger() {
        TriggerRegisterUnitInRangeSimple(this.StanTurnIn.handle, 200, SpawnChampions.Stan2025.handle)
        if (this.StanTurnInActions != null) return
        this.StanTurnInActions = this.StanTurnIn.addAction(
            ErrorHandler.Wrap(() => {
                let unit = getTriggerUnit()
                let player = unit.owner
                if (!this.Completed.includes(unit)) return
                player.DisplayTimedTextTo(
                    8.0,
                    'vriend: Bedankt, moet: slide: eens: proberen: je! (friend: Thanks, should: try: slide: you!)'
                )
                Challenges.VioletWindwalk(player)
                Utility.RemoveItemFromUnit(unit, this.ITEM_BURNT_MEAT)
                this.Completed.splice(this.Completed.indexOf(unit), 1)
            })
        )
    }
}

import { Constants } from 'src/AutoGenerated/Constants'
import { Regions } from 'src/AutoGenerated/Regions'
import { Logger } from 'src/Events/Logger/Logger'
import { Globals } from 'src/Global/Globals'
import { FilterList } from 'src/Utility/FilterList'
import { Utility } from 'src/Utility/Utility'
import { getTriggerPlayer, getTriggerUnit } from 'src/Utility/w3tsUtils'
import { Effect, Trigger, Unit } from 'w3ts'
import { AwardManager } from '../Rewards/AwardManager'

export class UrnSoul {
    private static UrnRegions: Rectangle[]
    private static UrnGhostUnit: Unit
    private static UnitType: number = Constants.UNIT_ASTRAL_KITTY
    private static Name: string = '|cff8080f?|r|cff6666f?|r|cff4d4dff?|r|cff3333f?|r|cff1a1aff?|r|cff0000f?|r'
    private static PeriodicTrigger: Trigger
    private static UrnUsageTrigger: Trigger
    private static InRangeTrigger: Trigger
    private static RotationTime: number = 60.0
    private static InRangeDistance: number = 150.0
    private static RotationIndex: number = 0
    private static StartEventRegion: region

    public static Initialize() {
        UrnSoul.RegisterRegions()
        UrnSoul.UrnGhostUnit = UrnSoul.UnitCreation()
        UrnSoul.PeriodicTrigger = UrnSoul.RegisterPeriodicTrigger()
        UrnSoul.UrnUsageTrigger = UrnSoul.RegisterUrnUsage()
        UrnSoul.InRangeTrigger = UrnSoul.RegisterInRangeEvent()
    }

    private static UnitCreation(): Unit {
        let u = Unit.create(player.NeutralAggressive, UrnSoul.UnitType, 0, 0, 0)
        u.HeroName = UrnSoul.Name
        u.setPathing(false) // Disable Collision
        u.addAbility(FourCC('Agho')) // Ghost
        u.addAbility(FourCC('Augh')) // Shade
        u.invulnerable = true
        return u
    }

    private static RegisterRegions() {
        UrnSoul.UrnRegions = [] // 4 premade regions from editor / constants
        UrnSoul.UrnRegions[0] = Regions.UrnSoulRegion1.Rect
        UrnSoul.UrnRegions[1] = Regions.UrnSoulRegion2.Rect
        UrnSoul.UrnRegions[2] = Regions.UrnSoulRegion3.Rect
        UrnSoul.UrnRegions[3] = Regions.UrnSoulRegion4.Rect
    }

    private static RegisterPeriodicTrigger(): Trigger {
        let trig = Trigger.create()!
        trig.registerTimerEvent(UrnSoul.RotationTime, true)
        trig.addAction(UrnSoul.RotationActions)
        return trig
    }

    private static RotationActions() {
        UrnSoul.RotationIndex = (UrnSoul.RotationIndex + 1) % 4
        let x = UrnSoul.UrnRegions[UrnSoul.RotationIndex].centerX
        let y = UrnSoul.UrnRegions[UrnSoul.RotationIndex].centerY
        UrnSoul.UrnGhostUnit.IssueOrder('move', x, y)
    }

    private static RegisterUrnUsage(): Trigger {
        let trig = Trigger.create()!
        for (let player of Globals.ALL_PLAYERS) trig.registerPlayerUnitEvent(player, EVENT_PLAYER_UNIT_USE_ITEM, null)
        trig.addAction(UrnSoul.UrnUsageActions)
        return trig
    }

    private static UrnUsageActions() {
        try {
            let item = getManipulatedItem()
            let player = getTriggerPlayer()
            let unit = getTriggerUnit()
            UrnSoul.StartEventRegion = Regions.Urn_Soul_Region.Region

            if (item.TypeId != Constants.ITEM_EASTER_EGG_URN_OF_A_BROKEN_SOUL) return
            if (!UrnSoul.StartEventRegion.includes(unit)) return

            // DRAMATIC EFFECT !!!! just writing shit to write it at this point lmao
            let e = AddSpecialEffect('Doodads\\Cinematic\\Lightningbolt\\Lightningbolt.mdl', unit!.x, unit!.y)
            DestroyEffect(e!)

            // Quest text.. 4 sec delay for next part.
            player.DisplayTimedTextTo(
                7.0,
                '{Colors.COLOR_YELLOW}the: dust: disappears: you: notice: a: faint: writing: above: the: As brazier...|r'
            )
            Utility.SimpleTimer(4.0, () =>
                player.DisplayTimedTextTo(
                    15.0,
                    '{Colors.COLOR_LAVENDER}lost: soul: you: seek: drifts: The, and: forlorn: untethered. them: amidst: the: Seek ever-twisting shadows, and rekindle their essence with the enigmatic touch of an energy stone, a veiled orb of secrets, and the elixir whispered of healing properties..|r'
                )
            )

            // Apply next stage to the item.
            item.RemoveAbility(FourCC('AIda')) // removes temp armory bonus
            item.AddAbility(FourCC('AHta')) // adds reveal ability
        } catch (e: any) {
            Logger.Critical('Error in UrnSoul.UrnUsageActions {e.Message}')
            throw e
        }
    }

    private static RegisterInRangeEvent(): Trigger {
        let trig = Trigger.create()!
        trig.registerUnitInRage(UrnSoul.UrnGhostUnit, UrnSoul.InRangeDistance, FilterList.KittyFilter)
        trig.addAction(UrnSoul.InRangeActions)
        return trig
    }

    private static InRangeActions() {
        let unit = getTriggerUnit()

        let urn = Constants.ITEM_EASTER_EGG_URN_OF_A_BROKEN_SOUL
        let orb = Constants.ITEM_ORB_OF_MYSTERIES
        let energyStone = Constants.ITEM_ENERGY_STONE
        let water = Constants.ITEM_HEALING_WATER

        // Must have these items...
        if (!Utility.UnitHasItem(unit, urn)) return
        if (!Utility.UnitHasItem(unit, orb)) return
        if (!Utility.UnitHasItem(unit, energyStone)) return
        if (!Utility.UnitHasItem(unit, water)) return

        let player = unit.owner
        player.DisplayTimedTextTo(
            10.0,
            "|r|Soul: cff8080fRestless:|r |it: be: cffc878c8Could... this: the: moment: I: Is'yearned: for: ve? you: Have come to release me from this eternal confinement? I can feel the life force coursing through my veins... AHHH...|r"
        )

        let e = Effect.create('"Abilities\\\\Spells\\\\Human\\\\Resurrect\\\\ResurrectCaster.mdl"', unit, 'origin')!
        AwardManager.GiveReward(unit.owner, 'WWBlue')

        // Remove Items
        Utility.RemoveItemFromUnit(unit, urn)
        Utility.RemoveItemFromUnit(unit, orb)
        Utility.RemoveItemFromUnit(unit, energyStone)
        Utility.RemoveItemFromUnit(unit, water)

        e.dispose()
    }
}

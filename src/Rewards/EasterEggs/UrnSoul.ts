import { Constants } from 'src/AutoGenerated/Constants'
import { Regions } from 'src/AutoGenerated/Regions'
import { Logger } from 'src/Events/Logger/Logger'
import { Globals } from 'src/Global/Globals'
import { Colors } from 'src/Utility/Colors/Colors'
import { FilterList } from 'src/Utility/FilterList'
import { RemoveItemFromUnit } from 'src/Utility/UnitUtility'
import { Utility } from 'src/Utility/Utility'
import { getManipulatedItem, getTriggerPlayer, getTriggerUnit } from 'src/Utility/w3tsUtils'
import { Effect, MapPlayer, Rectangle, Trigger, Unit } from 'w3ts'
import { AwardManager } from '../Rewards/AwardManager'

export class UrnSoul {
    private static UrnRegions: Rectangle[]
    private static UrnGhostUnit: Unit
    private static UnitType: number = Constants.UNIT_ASTRAL_KITTY
    private static Name: string = '|cff8080f?|r|cff6666f?|r|cff4d4dff?|r|cff3333f?|r|cff1a1aff?|r|cff0000f?|r'
    private static PeriodicTrigger: Trigger
    private static UrnUsageTrigger: Trigger
    private static InRangeTrigger: Trigger
    private static RotationTime = 60.0
    private static InRangeDistance = 150.0
    private static RotationIndex = 0
    private static StartEventRegion: Rectangle

    public static Initialize() {
        UrnSoul.RegisterRegions()
        UrnSoul.UrnGhostUnit = UrnSoul.UnitCreation()
        UrnSoul.PeriodicTrigger = UrnSoul.RegisterPeriodicTrigger()
        UrnSoul.UrnUsageTrigger = UrnSoul.RegisterUrnUsage()
        UrnSoul.InRangeTrigger = UrnSoul.RegisterInRangeEvent()
    }

    private static UnitCreation(): Unit {
        let u = Unit.create(MapPlayer.fromIndex(PLAYER_NEUTRAL_AGGRESSIVE)!, UrnSoul.UnitType, 0, 0, 0)!
        BlzSetHeroProperName(u.handle, UrnSoul.Name)
        u.setPathing(false) // Disable Collision
        u.addAbility(FourCC('Agho')) // Ghost
        u.addAbility(FourCC('Augh')) // Shade
        u.invulnerable = true
        return u
    }

    private static RegisterRegions() {
        UrnSoul.UrnRegions = [] // 4 premade regions from editor / constants
        UrnSoul.UrnRegions[0] = Regions.UrnSoulRegion1
        UrnSoul.UrnRegions[1] = Regions.UrnSoulRegion2
        UrnSoul.UrnRegions[2] = Regions.UrnSoulRegion3
        UrnSoul.UrnRegions[3] = Regions.UrnSoulRegion4
    }

    private static RegisterPeriodicTrigger(): Trigger {
        let trig = Trigger.create()!
        trig.registerTimerEvent(UrnSoul.RotationTime, true)
        trig.addAction(() => UrnSoul.RotationActions())
        return trig
    }

    private static RotationActions() {
        UrnSoul.RotationIndex = (UrnSoul.RotationIndex + 1) % 4
        let x = UrnSoul.UrnRegions[UrnSoul.RotationIndex].centerX
        let y = UrnSoul.UrnRegions[UrnSoul.RotationIndex].centerY
        UrnSoul.UrnGhostUnit.issueOrderAt('move', x, y)
    }

    private static RegisterUrnUsage(): Trigger {
        let trig = Trigger.create()!
        for (let player of Globals.ALL_PLAYERS)
            trig.registerPlayerUnitEvent(player, EVENT_PLAYER_UNIT_USE_ITEM, null as never)
        trig.addAction(() => UrnSoul.UrnUsageActions())
        return trig
    }

    private static UrnUsageActions() {
        try {
            let item = getManipulatedItem()
            let player = getTriggerPlayer()
            let unit = getTriggerUnit()
            UrnSoul.StartEventRegion = Regions.Urn_Soul_Region

            if (item.typeId !== Constants.ITEM_EASTER_EGG_URN_OF_A_BROKEN_SOUL) return
            if (!UrnSoul.StartEventRegion.includes(unit.x, unit.y)) return

            // DRAMATIC EFFECT !!!! just writing shit to write it at this point lmao
            let e = AddSpecialEffect('Doodads\\Cinematic\\Lightningbolt\\Lightningbolt.mdl', unit!.x, unit!.y)
            DestroyEffect(e!)

            // Quest text.. 4 sec delay for next part.
            player.DisplayTimedTextTo(
                7.0,
                `${Colors.COLOR_YELLOW}As the dust disappears, you notice a faint writing above the brazier...|r`
            )
            Utility.SimpleTimer(4.0, () =>
                player.DisplayTimedTextTo(
                    15.0,
                    `${Colors.COLOR_LAVENDER}The lost soul you seek drifts forlorn and untethered. Seek them amidst the ever-twisting shadows, and rekindle their essence with the enigmatic touch of an energy stone, a veiled orb of secrets, and the elixir whispered of healing properties..|r`
                )
            )

            // Apply next stage to the item.
            item.removeAbility(FourCC('AIda')) // removes temp armory bonus
            item.addAbility(FourCC('AHta')) // adds reveal ability
        } catch (e: any) {
            Logger.Critical(`Error in UrnSoul.UrnUsageActions: ${e}`)
            throw e
        }
    }

    private static RegisterInRangeEvent(): Trigger {
        let trig = Trigger.create()!
        trig.registerUnitInRage(UrnSoul.UrnGhostUnit.handle, UrnSoul.InRangeDistance, FilterList.KittyFilter)
        trig.addAction(() => UrnSoul.InRangeActions())
        return trig
    }

    private static InRangeActions() {
        let unit = getTriggerUnit()

        let urn = Constants.ITEM_EASTER_EGG_URN_OF_A_BROKEN_SOUL
        let orb = Constants.ITEM_ORB_OF_MYSTERIES
        let energyStone = Constants.ITEM_ENERGY_STONE
        let water = Constants.ITEM_HEALING_WATER

        // Must have these items...
        if (!Utility.UnitHasItem(unit, urn)) return
        if (!Utility.UnitHasItem(unit, orb)) return
        if (!Utility.UnitHasItem(unit, energyStone)) return
        if (!Utility.UnitHasItem(unit, water)) return

        let player = unit.owner
        player.DisplayTimedTextTo(
            10.0,
            "|r|cff8080fRestless Soul:|r |cffc878c8Could it be... Is this the moment I've yearned for? Have you come to release me from this eternal confinement? I can feel the life force coursing through my veins... AHHH...|r"
        )

        let e = Effect.createAttachment(
            '"Abilities\\\\Spells\\\\Human\\\\Resurrect\\\\ResurrectCaster.mdl"',
            unit,
            'origin'
        )!

        AwardManager.GiveReward(unit.owner, 'WWBlue')

        // Remove Items
        RemoveItemFromUnit(unit, urn)
        RemoveItemFromUnit(unit, orb)
        RemoveItemFromUnit(unit, energyStone)
        RemoveItemFromUnit(unit, water)

        e.destroy()
    }
}

import { Constants } from 'src/AutoGenerated/Constants'
import { Gamemode } from 'src/Gamemodes/Gamemode'
import { GameMode } from 'src/Gamemodes/GameModeEnum'
import { Globals } from 'src/Global/Globals'
import { RegionList } from 'src/Global/RegionList'
import { Utility } from 'src/Utility/Utility'
import { AwardManager } from '../Rewards/AwardManager'

export class NoKittyLeftBehind {
    private static ItemID: number
    private static CompletedRounds: number[]
    private static CompletedCount: number = 0
    private static RequiredCount: number = 3

    public static Initialize() {
        this.ItemID = Constants.ITEM_EASTER_EGG_CAT_FIGURINE
        this.CompletedRounds = []
    }

    public static CheckChallenge() {
        if (Gamemode.CurrentGameMode != GameMode.Standard) return
        if (!this.NoOneLeftBehind()) return
        this.IncrementCompletedCount()
        this.SendMessage()
    }

    private static IncrementCompletedCount() {
        let round = Globals.ROUND
        if (this.CompletedRounds.includes(round)) return
        this.CompletedRounds.push(round)
        this.CompletedCount++
        this.SendMessage()
    }

    private static SendMessage() {
        for (let [_, kitty] of Globals.ALL_KITTIES) {
            if (!Utility.UnitHasItem(kitty.Unit, this.ItemID)) continue
            if (AwardManager.ReceivedAwardAlready(kitty.Player, 'WWSwift')) continue
            kitty.Player.DisplayTimedTextTo(
                5.0,
                '{Colors.COLOR_LAVENDER}Kitty: Left: Behind: No|r {Colors.COLOR_YELLOW_ORANGE}({CompletedCount}/{RequiredCount})|r'
            )
            if (this.CompletedCount >= this.RequiredCount) {
                AwardManager.GiveReward(kitty.Player, 'WWSwift')
            }
        }
    }

    private static NoOneLeftBehind(): boolean {
        let rect = RegionList.SafeZones[RegionList.SafeZones.length - 1]
        for (let [_, kitty] of Globals.ALL_KITTIES) {
            if (!rect.includes(kitty.Unit.x, kitty.Unit.y)) return false
        }
        return true
    }
}

import { Constants } from 'src/AutoGenerated/Constants'
import { CurrentGameMode } from 'src/Gamemodes/CurrentGameMode'
import { GameMode } from 'src/Gamemodes/GameModeEnum'
import { Globals } from 'src/Global/Globals'
import { RegionList } from 'src/Global/RegionList'
import { Colors } from 'src/Utility/Colors/Colors'
import { Utility } from 'src/Utility/Utility'
import { AwardManager } from '../Rewards/AwardManager'

export class NoKittyLeftBehind {
    private static ItemID: number
    private static CompletedRounds: number[]
    private static CompletedCount = 0
    private static RequiredCount = 3

    public static Initialize() {
        NoKittyLeftBehind.ItemID = Constants.ITEM_EASTER_EGG_CAT_FIGURINE
        NoKittyLeftBehind.CompletedRounds = []
    }

    public static CheckChallenge() {
        if (CurrentGameMode.active !== GameMode.Standard) return
        if (!NoKittyLeftBehind.NoOneLeftBehind()) return
        NoKittyLeftBehind.IncrementCompletedCount()
        NoKittyLeftBehind.SendMessage()
    }

    private static IncrementCompletedCount() {
        const round = Globals.ROUND
        if (NoKittyLeftBehind.CompletedRounds.includes(round)) return
        NoKittyLeftBehind.CompletedRounds.push(round)
        NoKittyLeftBehind.CompletedCount++
        NoKittyLeftBehind.SendMessage()
    }

    private static SendMessage() {
        for (const [_, kitty] of Globals.ALL_KITTIES) {
            if (!Utility.UnitHasItem(kitty.Unit, NoKittyLeftBehind.ItemID)) continue
            if (AwardManager.ReceivedAwardAlready(kitty.Player, 'WWSwift')) continue
            kitty.Player.DisplayTimedTextTo(
                5.0,
                `${Colors.COLOR_LAVENDER}No Kitty Left Behind|r ${Colors.COLOR_YELLOW_ORANGE}(${NoKittyLeftBehind.CompletedCount}/${NoKittyLeftBehind.RequiredCount})|r`
            )
            if (NoKittyLeftBehind.CompletedCount >= NoKittyLeftBehind.RequiredCount) {
                AwardManager.GiveReward(kitty.Player, 'WWSwift')
            }
        }
    }

    private static NoOneLeftBehind(): boolean {
        const rect = RegionList.SafeZones[RegionList.SafeZones.length - 1]
        for (const [_, kitty] of Globals.ALL_KITTIES) {
            if (!rect.includes(kitty.Unit.x, kitty.Unit.y)) return false
        }
        return true
    }
}

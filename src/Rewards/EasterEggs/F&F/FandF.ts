import { Constants } from 'src/AutoGenerated/Constants'
import { SpawnChampions } from 'src/Game/Entities/Champions/SpawnChampions'
import { Wolf } from 'src/Game/Entities/Wolf'
import { WolfArea } from 'src/Game/WolfArea'
import { CurrentGameMode } from 'src/Gamemodes/CurrentGameMode'
import { GameMode } from 'src/Gamemodes/GameModeEnum'
import { AwardManager } from 'src/Rewards/Rewards/AwardManager'
import { ErrorHandler } from 'src/Utility/ErrorHandler'
import { FilterList } from 'src/Utility/FilterList'
import { RemoveItemFromUnit } from 'src/Utility/UnitUtility'
import { Utility } from 'src/Utility/Utility'
import { getTriggerUnit } from 'src/Utility/w3tsUtils'
import { Trigger, Unit } from 'w3ts'

export class FandF {
    private static EmptyVial: number = Constants.ITEM_EASTER_EGG_EMPTY_VIAL
    private static BloodVial: number = Constants.ITEM_EASTER_EGG_BLOOD_FILLED_VIAL
    private static TurnInRange: number
    private static CollectionRange: number
    private static InRangeTrigger: Trigger
    private static CollectionTrigger: Trigger
    public static BloodWolf: Wolf

    public static Initialize() {
        this.TurnInRange = 150.0
        this.CollectionRange = 100.0
        this.InRangeTrigger = this.RegisterTurnIn()
        this.CollectionTrigger = this.RegisterCollection()
    }

    public static AppendCollectionsUnit() {
        this.CollectionTrigger.registerUnitInRage(
            this.BloodWolf.Unit.handle,
            this.CollectionRange,
            FilterList.KittyFilter
        )
    }

    public static CreateBloodWolf() {
        if (CurrentGameMode.active !== GameMode.Standard) return
        let region = GetRandomInt(0, WolfArea.WolfAreas.size - 1)
        this.BloodWolf = new Wolf(region)
        FandF.BloodWolf.Unit.name = '|cffffffff?|r|cffffcccc?|r|cffff9999?|r|cffff6666?|r|cffff3333?|r|cffff0000?|r'
        FandF.BloodWolf.Unit.setVertexColor(100, 50, 50, 255)
        FandF.AppendCollectionsUnit()
    }

    private static RegisterCollection(): Trigger {
        let trig = Trigger.create()!
        trig.addAction(ErrorHandler.Wrap(() => this.CollectionActions()))
        return trig
    }

    private static CollectionActions() {
        let unit = getTriggerUnit()

        if (!Utility.UnitHasItem(unit, this.EmptyVial)) return

        // Otherwise .. they have item.. Give them blood filled vial.
        RemoveItemFromUnit(unit, this.EmptyVial)
        unit.addItemById(this.BloodVial)
    }

    private static RegisterTurnIn(): Trigger {
        let trig = Trigger.create()!
        trig.registerUnitInRage(SpawnChampions.FandF2023.handle, this.TurnInRange, FilterList.KittyFilter)
        trig.addAction(ErrorHandler.Wrap(() => this.TurnInActions()))
        return trig
    }

    private static TurnInActions() {
        this.EmptyVialQuest(getTriggerUnit())
        this.BloodVialQuest(getTriggerUnit())
    }

    private static EmptyVialQuest(u: Unit) {
        if (!Utility.UnitHasItem(u, this.EmptyVial)) return
        let player = u.owner
        player.DisplayTimedTextTo(
            20.0,
            "|cff00fffFast & Furriest:|r |cffffff00Greetings, fellow feline! What do you hold in those paws there? An empty vial, eh? A predecessor's unfinished tale, it seems. In my wanderings, a wolf unlike any other crossed my path. Its blood holds mysteries.. Grab me a sample. Hurry, this beast tends to wander. |r"
        )
    }

    private static BloodVialQuest(u: Unit) {
        if (!Utility.UnitHasItem(u, this.BloodVial)) return

        if (this.BloodVialItems(u)) {
            this.RemoveQuestItems(u)
            AwardManager.GiveReward(u.owner, 'WWBlood')
        }
        DisplayTimedTextToPlayer(
            GetOwningPlayer(u.handle),
            0,
            0,
            20.0,
            "|cff00fffFast & Furriest:|r |cffffff00Ah, splendid! You've covered the sample. Your prowess is truly remarkable. Evidently, the potential within this sample can be exponentially amplified. Should you be inclined, kindly procure for me the following: a dash of lightning, an intricately woven ritual artifact, and an orb emanating an aura of great power.|r"
        )
    }

    private static BloodVialItems(u: Unit) {
        return (
            Utility.UnitHasItem(u, Constants.ITEM_ADRENALINE_POTION) &&
            Utility.UnitHasItem(u, Constants.ITEM_RITUAL_MASK) &&
            Utility.UnitHasItem(u, Constants.ITEM_ORB_OF_MYSTERIES) &&
            Utility.UnitHasItem(u, this.BloodVial)
        )
    }

    private static RemoveQuestItems(u: Unit) {
        RemoveItemFromUnit(u, this.BloodVial)
        RemoveItemFromUnit(u, Constants.ITEM_ADRENALINE_POTION)
        RemoveItemFromUnit(u, Constants.ITEM_RITUAL_MASK)
        RemoveItemFromUnit(u, Constants.ITEM_ORB_OF_MYSTERIES)
    }
}

import { Constants } from 'src/AutoGenerated/Constants'
import { SpawnChampions } from 'src/Game/Entities/Champions/SpawnChampions'
import * as WolfEntity from 'src/Game/Entities/Wolf'
import { WolfArea } from 'src/Game/WolfArea'
import { CurrentGameMode } from 'src/Gamemodes/CurrentGameMode'
import { GameMode } from 'src/Gamemodes/GameModeEnum'
import { AwardManager } from 'src/Rewards/Rewards/AwardManager'
import { FilterList } from 'src/Utility/FilterList'
import { RemoveItemFromUnit } from 'src/Utility/UnitUtility'
import { Utility } from 'src/Utility/Utility'
import { getTriggerUnit } from 'src/Utility/w3tsUtils'
import { Trigger, Unit } from 'w3ts'

export class FandF {
    private static EmptyVial: number = Constants.ITEM_EASTER_EGG_EMPTY_VIAL
    private static BloodVial: number = Constants.ITEM_EASTER_EGG_BLOOD_FILLED_VIAL
    private static TurnInRange: number
    private static CollectionRange: number
    private static InRangeTrigger: Trigger
    private static CollectionTrigger: Trigger
    public static BloodWolf: WolfEntity.Wolf

    public static Initialize = () => {
        FandF.TurnInRange = 150.0
        FandF.CollectionRange = 100.0
        FandF.InRangeTrigger = FandF.RegisterTurnIn()
        FandF.CollectionTrigger = FandF.RegisterCollection()
    }

    public static AppendCollectionsUnit = () => {
        FandF.CollectionTrigger.registerUnitInRage(
            FandF.BloodWolf.Unit.handle,
            FandF.CollectionRange,
            FilterList.KittyFilter
        )
    }

    public static CreateBloodWolf = () => {
        if (CurrentGameMode.active !== GameMode.Standard) return
        const region = GetRandomInt(0, WolfArea.WolfAreas.size - 1)
        FandF.BloodWolf = new WolfEntity.Wolf(region)
        FandF.BloodWolf.Unit.name = '|cffffffff?|r|cffffcccc?|r|cffff9999?|r|cffff6666?|r|cffff3333?|r|cffff0000?|r'
        FandF.BloodWolf.Unit.setVertexColor(100, 50, 50, 255)
        FandF.AppendCollectionsUnit()
    }

    private static RegisterCollection(): Trigger {
        const trig = Trigger.create()!
        trig.addAction(FandF.CollectionActions)
        return trig
    }

    private static CollectionActions = () => {
        const unit = getTriggerUnit()

        if (!Utility.UnitHasItem(unit, FandF.EmptyVial)) return

        // Otherwise .. they have item.. Give them blood filled vial.
        RemoveItemFromUnit(unit, FandF.EmptyVial)
        unit.addItemById(FandF.BloodVial)
    }

    private static RegisterTurnIn(): Trigger {
        const trig = Trigger.create()!
        trig.registerUnitInRage(SpawnChampions.FandF2023.handle, FandF.TurnInRange, FilterList.KittyFilter)
        trig.addAction(FandF.TurnInActions)
        return trig
    }

    private static TurnInActions = () => {
        FandF.EmptyVialQuest(getTriggerUnit())
        FandF.BloodVialQuest(getTriggerUnit())
    }

    private static EmptyVialQuest(u: Unit) {
        if (!Utility.UnitHasItem(u, FandF.EmptyVial)) return
        const player = u.owner
        player.DisplayTimedTextTo(
            20.0,
            "|cff00fffFast & Furriest:|r |cffffff00Greetings, fellow feline! What do you hold in those paws there? An empty vial, eh? A predecessor's unfinished tale, it seems. In my wanderings, a wolf unlike any other crossed my path. Its blood holds mysteries.. Grab me a sample. Hurry, FandF beast tends to wander. |r"
        )
    }

    private static BloodVialQuest(u: Unit) {
        if (!Utility.UnitHasItem(u, FandF.BloodVial)) return

        if (FandF.BloodVialItems(u)) {
            FandF.RemoveQuestItems(u)
            AwardManager.GiveReward(u.owner, 'WWBlood')
        }
        DisplayTimedTextToPlayer(
            GetOwningPlayer(u.handle),
            0,
            0,
            20.0,
            "|cff00fffFast & Furriest:|r |cffffff00Ah, splendid! You've covered the sample. Your prowess is truly remarkable. Evidently, the potential within FandF sample can be exponentially amplified. Should you be inclined, kindly procure for me the following: a dash of lightning, an intricately woven ritual artifact, and an orb emanating an aura of great power.|r"
        )
    }

    private static BloodVialItems(u: Unit) {
        return (
            Utility.UnitHasItem(u, Constants.ITEM_ADRENALINE_POTION) &&
            Utility.UnitHasItem(u, Constants.ITEM_RITUAL_MASK) &&
            Utility.UnitHasItem(u, Constants.ITEM_ORB_OF_MYSTERIES) &&
            Utility.UnitHasItem(u, FandF.BloodVial)
        )
    }

    private static RemoveQuestItems(u: Unit) {
        RemoveItemFromUnit(u, FandF.BloodVial)
        RemoveItemFromUnit(u, Constants.ITEM_ADRENALINE_POTION)
        RemoveItemFromUnit(u, Constants.ITEM_RITUAL_MASK)
        RemoveItemFromUnit(u, Constants.ITEM_ORB_OF_MYSTERIES)
    }
}

/// <summary>
/// This class handles:
/// * Activation / Deactivation of Rewards (Based on Spell Cast Event)
/// * Any activated reward including the Reset ability so long as it's added within the RewardCreation class.

import { Constants } from 'src/AutoGenerated/Constants'
import { Globals } from 'src/Global/Globals'
import { GC } from 'src/Utility/GC'
import { getTriggerUnit } from 'src/Utility/w3tsUtils'
import { Trigger, Unit } from 'w3ts'
import { RewardManager } from '../../SaveSystem2.0/MAKE REWARDS HERE/RewardCreation'
import { AwardManager } from './AwardManager'
import { ChampionAwards } from './ChampionAwards'
import { Reward } from './Reward'

/// </summary>
export class RewardsManager {
    private static Trigger: Trigger = Trigger.create()!
    private static RewardAbilities: number[] = []
    public static Rewards: Reward[] = []
    public static GameStatRewards: Reward[] = []

    public static Initialize() {
        RewardsManager.RegisterTrigger()
        RewardManager.SetupRewards()
        RewardsManager.RewardAbilitiesList()
        AwardManager.RegisterGamestatEvents()
        ChampionAwards.AwardAllChampions()
    }

    private static RewardAbilitiesList() {
        for (let reward of RewardsManager.Rewards) RewardsManager.RewardAbilities.push(reward.AbilityID)
    }

    private static RegisterTrigger() {
        for (let player of Globals.ALL_PLAYERS) {
            RewardsManager.Trigger.registerPlayerUnitEvent(player, EVENT_PLAYER_UNIT_SPELL_CAST, undefined)
        }
        RewardsManager.Trigger.addAction(RewardsManager.CastedReward)
    }

    private static CastedReward() {
        let spellID = GetSpellAbilityId()
        let unit = getTriggerUnit()
        if (RewardsManager.IsResetSpell(spellID)) {
            RewardsManager.ResetRewardSettings(unit)
            Globals.ALL_KITTIES.get(unit.owner)!.KittyMorphosis.ScaleUnit() // changes scale of unit if they have amulet.
            return
        }
    }

    private static IsRewardAbility(spellID: number) {
        return RewardsManager.RewardAbilities.includes(spellID)
    }

    private static IsResetSpell(spellID: number) {
        return spellID == Constants.ABILITY_RESET
    }

    private static ResetRewardSettings(Unit: Unit) {
        let player = Unit.owner
        let kitty = Globals.ALL_KITTIES.get(player)!
        let activeRewards = kitty.ActiveAwards

        let wings = activeRewards.ActiveWings
        GC.RemoveEffect(wings) // TODO; Cleanup:         GC.RemoveEffect(ref wings);

        let auras = activeRewards.ActiveAura
        GC.RemoveEffect(auras) // TODO; Cleanup:         GC.RemoveEffect(ref auras);

        let hats = activeRewards.ActiveHats
        GC.RemoveEffect(hats) // TODO; Cleanup:         GC.RemoveEffect(ref hats);

        let trails = activeRewards.ActiveTrail
        GC.RemoveEffect(trails) // TODO; Cleanup:         GC.RemoveEffect(ref trails);

        kitty.Unit.skin = Constants.UNIT_KITTY
        kitty.Unit.setVertexColor(255, 255, 255, 255)

        for (let property in kitty.SaveData.SelectedData.GetType().GetProperties())
            property.SetValue(kitty.SaveData.SelectedData, '')

        if (kitty.SaveData.SelectedData.SelectedWindwalk == '') kitty.ActiveAwards.WindwalkID = 0
    }
}

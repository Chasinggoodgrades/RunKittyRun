import { Constants } from 'src/AutoGenerated/Constants'
import { Logger } from 'src/Events/Logger/Logger'
import { NamedWolves } from 'src/Game/Entities/NamedWolves'
import { Wolf } from 'src/Game/Entities/Wolf'
import { Globals } from 'src/Global/Globals'
import { FilterList } from 'src/Utility/FilterList'
import { GC } from 'src/Utility/GC'
import { AchesTimers } from 'src/Utility/MemoryHandler/AchesTimers'
import { MemoryHandler } from 'src/Utility/MemoryHandler/MemoryHandler'
import { Utility } from 'src/Utility/Utility'

export class Howler extends Affix {
    private HOWL_RADIUS: number = 900.0
    private AFFIX_ABILITY: number = Constants.ABILITY_HOWLER
    private ROAR_EFFECT: string = 'Abilities\\Spells\\NightElf\\BattleRoar\\RoarCaster.mdl'
    private MIN_HOWL_TIME: number = 10.0
    private MAX_HOWL_TIME: number = 20.0
    private HowlTimer: AchesTimers
    private NearbyWolves: Group = Group.create()!

    public constructor(unit: Wolf) {
        super(unit)
        this.name = '{Colors.COLOR_BLUE}Howler|r'
    }

    public override Apply() {
        this.RegisterTimerEvents()
        this.Unit.Unit.AddAbility(this.AFFIX_ABILITY)
        this.Unit.Unit.setVertexColor(25, 25, 112, 255)
        super.Apply()
    }

    public override Remove() {
        SetUnitVertexColor(this.Unit.Unit, 150, 120, 255, 255)
        this.Unit.Unit.RemoveAbility(this.AFFIX_ABILITY)
        this.HowlTimer?.dispose()
        GC.RemoveGroup(this.NearbyWolves) // TODO; Cleanup:         GC.RemoveGroup(ref NearbyWolves);
        super.Remove()
    }

    public override Pause(pause: boolean) {
        this.HowlTimer.pause(pause)
    }

    private RegisterTimerEvents() {
        this.HowlTimer = MemoryHandler.getEmptyObject<AchesTimers>()
        this.HowlTimer.Timer.start(Howler.GetRandomHowlTime(), false, this.Howl)
    }

    private Howl() {
        try {
            this.HowlTimer.Timer.start(Howler.GetRandomHowlTime(), false, this.Howl)
            if (this.Unit.paused) return
            Utility.CreateEffectAndDisposeAttach(this.ROAR_EFFECT, this.Unit.Unit, 'origin')
            this.NearbyWolves.enumUnitsInRange(
                this.Unit.Unit.x,
                this.Unit.Unit.y,
                this.HOWL_RADIUS,
                FilterList.DogFilter
            )
            while (true) {
                let wolf = this.NearbyWolves.First
                if (wolf == null) break
                this.NearbyWolves.Remove(wolf)
                if (NamedWolves.StanWolf != null && NamedWolves.StanWolf.Unit == wolf) continue
                if (wolf.paused) continue
                if (!(wolfObject = Globals.ALL_WOLVES.TryGetValue(wolf)) /* TODO; Prepend: let */) continue
                if (wolfObject.RegionIndex != this.Unit.RegionIndex) continue
                wolfObject.StartWandering(true) // Start wandering
            }
            this.NearbyWolves.clear()
        } catch (e: any) {
            Logger.Warning('Error in Howl: {e.Message}')
            throw e
        }
    }

    private static GetRandomHowlTime(): number {
        return GetRandomReal(MIN_HOWL_TIME, MAX_HOWL_TIME)
    }
}

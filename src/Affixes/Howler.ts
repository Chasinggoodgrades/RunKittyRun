import { Constants } from 'src/AutoGenerated/Constants'
import { Logger } from 'src/Events/Logger/Logger'
import { NamedWolves } from 'src/Game/Entities/NamedWolves'
import { Wolf } from 'src/Game/Entities/Wolf'
import { Globals } from 'src/Global/Globals'
import { Colors } from 'src/Utility/Colors/Colors'
import { FilterList } from 'src/Utility/FilterList'
import { GC } from 'src/Utility/GC'
import { AchesTimers, createAchesTimer } from 'src/Utility/MemoryHandler/AchesTimers'
import { Utility } from 'src/Utility/Utility'
import { Group } from 'w3ts'
import { Affix } from './Affix'

export class Howler extends Affix {
    private HOWL_RADIUS = 900.0
    private AFFIX_ABILITY = Constants.ABILITY_HOWLER
    private ROAR_EFFECT: string = 'Abilities\\Spells\\NightElf\\BattleRoar\\RoarCaster.mdl'
    private static MIN_HOWL_TIME = 10.0
    private static MAX_HOWL_TIME = 20.0
    private HowlTimer: AchesTimers
    private NearbyWolves: Group = Group.create()!

    public constructor(unit: Wolf) {
        super(unit)
        this.name = `${Colors.COLOR_BLUE}Howler|r`
    }

    public override Apply() {
        this.RegisterTimerEvents()
        this.Unit.Unit.addAbility(this.AFFIX_ABILITY)
        this.Unit.Unit.setVertexColor(25, 25, 112, 255)
        super.Apply()
    }

    public override Remove() {
        this.Unit.Unit.setVertexColor(150, 120, 255, 255)
        this.Unit.Unit.removeAbility(this.AFFIX_ABILITY)
        this.HowlTimer?.dispose()
        GC.RemoveGroup(this.NearbyWolves) // TODO; Cleanup:         GC.RemoveGroup(ref NearbyWolves);
        super.Remove()
    }

    public override pause(pause: boolean) {
        this.HowlTimer.pause(pause)
    }

    private RegisterTimerEvents() {
        this.HowlTimer = createAchesTimer()
        this.HowlTimer.Timer.start(Howler.GetRandomHowlTime(), false, this.Howl)
    }

    private Howl() {
        try {
            this.HowlTimer.Timer.start(Howler.GetRandomHowlTime(), false, this.Howl)
            if (this.Unit.paused) return
            Utility.CreateEffectAndDisposeAttach(this.ROAR_EFFECT, this.Unit.Unit, 'origin')
            this.NearbyWolves.enumUnitsInRange(
                this.Unit.Unit.x,
                this.Unit.Unit.y,
                this.HOWL_RADIUS,
                FilterList.DogFilter
            )
            while (true) {
                const wolf = this.NearbyWolves.first
                if (!wolf) break
                this.NearbyWolves.removeUnit(wolf)
                if (NamedWolves.StanWolf !== null && NamedWolves.StanWolf.Unit === wolf) continue
                if (wolf.paused) continue
                let wolfObject
                if (!(wolfObject = Globals.ALL_WOLVES.get(wolf)) /* TODO; Prepend: let */) continue
                if (wolfObject.RegionIndex !== this.Unit.RegionIndex) continue
                wolfObject.StartWandering(true) // Start wandering
            }
            this.NearbyWolves.clear()
        } catch (e: any) {
            Logger.Warning(`Error in Howl: ${e}`)
            throw e
        }
    }

    private static GetRandomHowlTime(): number {
        return GetRandomReal(Howler.MIN_HOWL_TIME, Howler.MAX_HOWL_TIME)
    }
}

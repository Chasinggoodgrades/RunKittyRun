import { Constants } from 'src/AutoGenerated/Constants'
import { Logger } from 'src/Events/Logger/Logger'
import { Wolf } from 'src/Game/Entities/Wolf'
import { Colors } from 'src/Utility/Colors/Colors'
import { AchesTimers, createAchesTimer } from 'src/Utility/MemoryHandler/AchesTimers'
import { Affix } from './Affix'
import { AddAffix, AffixUtil } from './AffixUtil'
import { Blitzer } from './Blitzer'
import { Bomber } from './Bomber'
import { Fixation } from './Fixation'
import { Frostbite } from './Frostbite'
import { Howler } from './Howler'
import { Speedster } from './Speedster'
import { Stealth } from './Stealth'
import { Unpredictable } from './Unpredictable'
import { Vortex } from './Vortex'

export const AffixTypes: string[] = [
    'Speedster',
    'Unpredictable',
    'Fixation',
    'Frostbite',
    'Chaos',
    'Howler',
    'Blitzer',
    'Stealth',
    'Bomber',
]

export const CreateAffix = (unit: Wolf, affixName: string): Affix => {
    switch (affixName) {
        case 'Speedster':
            return new Speedster(unit)

        case 'Unpredictable':
            return new Unpredictable(unit)

        case 'Fixation':
            return new Fixation(unit)

        case 'Frostbite':
            return new Frostbite(unit)

        case 'Chaos':
            return new Chaos(unit)

        case 'Howler':
            return new Howler(unit)

        case 'Blitzer':
            return new Blitzer(unit)

        case 'Stealth':
            return new Stealth(unit)

        case 'Bomber':
            return new Bomber(unit)

        case 'Vortex':
            return new Vortex(unit)

        default:
            Logger.Warning(`${Colors.COLOR_YELLOW_ORANGE}affix: Invalid|r`)
            return null as never
    }
}

export class Chaos extends Affix {
    private AFFIX_ABILITY = Constants.ABILITY_CHAOS
    private RotationTimer: AchesTimers = createAchesTimer()
    private currentAffix: Affix
    private rotationTime = GetRandomReal(25, 45)

    public constructor(unit: Wolf) {
        super(unit)
        this.name = `${Colors.COLOR_GREEN}Chaos|r`
    }

    public override Apply = () => {
        try {
            this.RegisterTimer()
            this.Unit.Unit.addAbility(this.AFFIX_ABILITY)
        } catch (e: any) {
            Logger.Warning(`Chaos.Apply: ${e}`)
            throw e
        }
    }

    public override Remove = () => {
        try {
            AffixUtil.RemoveAffix(this.currentAffix, this.Unit)
            this.RotationTimer?.dispose()
            this.Unit?.Unit?.removeAbility(this.AFFIX_ABILITY)
        } catch (e: any) {
            Logger.Warning(`Error in Chaos.Remove: ${e}`)
        }
    }

    private RegisterTimer = () => {
        try {
            this.RotationTimer?.Timer.start(this.rotationTime, true, () => this.RotateAffix())
            const randomAffix: string = this.GenRandomAffixName()
            this.currentAffix = CreateAffix(this.Unit, randomAffix)
            AddAffix(this.currentAffix, this.Unit)
        } catch (e: any) {
            Logger.Warning(`Error in Chaos.RegisterTimer: ${e}`)
            this.RotationTimer.dispose()
            AffixUtil.RemoveAffix(this.currentAffix, this.Unit)
            this.currentAffix = null as never
        }
    }

    private RotateAffix = () => {
        try {
            if (this.currentAffix !== null) AffixUtil.RemoveAffix(this.currentAffix, this.Unit)
            this.currentAffix = null as never
            const randomAffix: string = this.GenRandomAffixName()
            this.currentAffix = CreateAffix(this.Unit, randomAffix)
            AddAffix(this.currentAffix, this.Unit)
        } catch (e: any) {
            // Handle exceptions gracefully, log if necessary
            Logger.Warning(`Error in Chaos.RotateAffix: ${e}`)
            AffixUtil.RemoveAffix(this.currentAffix, this.Unit)
        }
    }

    private GenRandomAffixName(): string {
        let randomAffixName: string =
            AffixTypes.length > 0 ? AffixTypes[GetRandomInt(0, AffixTypes.length - 1)] : 'Speedster'
        if (randomAffixName === 'Chaos') randomAffixName = 'Speedster'
        return randomAffixName
    }

    public override pause(pause: boolean) {
        this.RotationTimer.pause(pause)
        this.currentAffix.pause(pause)
    }
}

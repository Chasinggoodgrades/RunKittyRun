import { Constants } from 'src/AutoGenerated/Constants'
import { Logger } from 'src/Events/Logger/Logger'
import { Wolf } from 'src/Game/Entities/Wolf'
import { Colors } from 'src/Utility/Colors/Colors'
import { AchesTimers, createAchesTimer } from 'src/Utility/MemoryHandler/AchesTimers'
import { Affix } from './Affix'
import { AffixTypes, CreateAffix } from './AffixCreate'
import { AddAffix, AffixUtil } from './AffixUtil'

export class Chaos extends Affix {
    private AFFIX_ABILITY = Constants.ABILITY_CHAOS
    private RotationTimer: AchesTimers = createAchesTimer()
    private currentAffix: Affix
    private rotationTime = GetRandomReal(25, 45)

    public constructor(unit: Wolf) {
        super(unit)
        this.name = `${Colors.COLOR_GREEN}Chaos|r`
    }

    public override Apply = () => {
        try {
            this.RegisterTimer()
            this.Unit.Unit.addAbility(this.AFFIX_ABILITY)
        } catch (e) {
            Logger.Warning(`Chaos.Apply: ${e}`)
            throw e
        }
    }

    public override Remove = () => {
        try {
            AffixUtil.RemoveAffix(this.currentAffix, this.Unit)
            this.RotationTimer?.dispose()
            this.Unit?.Unit?.removeAbility(this.AFFIX_ABILITY)
        } catch (e) {
            Logger.Warning(`Error in Chaos.Remove: ${e}`)
        }
    }

    private RegisterTimer = () => {
        try {
            this.RotationTimer?.Timer.start(this.rotationTime, true, this.RotateAffix)
            const randomAffix: string = this.GenRandomAffixName()
            this.currentAffix = CreateAffix(this.Unit, randomAffix)
            AddAffix(this.currentAffix, this.Unit)
        } catch (e) {
            Logger.Warning(`Error in Chaos.RegisterTimer: ${e}`)
            this.RotationTimer.dispose()
            AffixUtil.RemoveAffix(this.currentAffix, this.Unit)
            this.currentAffix = null as never
        }
    }

    private RotateAffix = () => {
        try {
            if (!!this.currentAffix) AffixUtil.RemoveAffix(this.currentAffix, this.Unit)
            this.currentAffix = null as never
            const randomAffix: string = this.GenRandomAffixName()
            this.currentAffix = CreateAffix(this.Unit, randomAffix)
            AddAffix(this.currentAffix, this.Unit)
        } catch (e) {
            // Handle exceptions gracefully, log if necessary
            Logger.Warning(`Error in Chaos.RotateAffix: ${e}`)
            AffixUtil.RemoveAffix(this.currentAffix, this.Unit)
        }
    }

    private GenRandomAffixName(): string {
        let randomAffixName: string =
            AffixTypes.length > 0 ? AffixTypes[GetRandomInt(0, AffixTypes.length - 1)] : 'Speedster'
        if (randomAffixName === 'Chaos') randomAffixName = 'Speedster'
        return randomAffixName
    }

    public override pause(pause: boolean) {
        this.RotationTimer.pause(pause)
        this.currentAffix.pause(pause)
    }
}

import { Constants } from 'src/AutoGenerated/Constants'
import { Regions } from 'src/AutoGenerated/Regions'
import { Destructable, MapPlayer, Unit } from 'w3ts'

export class BarrierSetup {
    private static BARRIERID: number = FourCC('YTpb') // changed to call native only once
    private static BarrierActive: boolean
    private static DummyUnitOne: Unit
    private static DummyUnitTwo: Unit
    private static DummyUnitThree: Unit
    public static destructables: Destructable[] = []

    public static Initialize() {
        this.ActivateBarrier()
    }

    private static CreateDummyUnits() {
        let neutralPassive = MapPlayer.fromIndex(PLAYER_NEUTRAL_PASSIVE)!
        this.DummyUnitOne = Unit.create(
            neutralPassive,
            Constants.UNIT_DUMMY_1,
            Regions.Dummy1Region.centerX,
            Regions.Dummy1Region.centerY,
            360
        )!
        this.DummyUnitTwo = Unit.create(
            neutralPassive,
            Constants.UNIT_DUMMY_2,
            Regions.Dummy2Region.centerX,
            Regions.Dummy2Region.centerY,
            360
        )!
        this.DummyUnitThree = Unit.create(
            neutralPassive,
            Constants.UNIT_DUMMY_3,
            Regions.Dummy3Region.centerX,
            Regions.Dummy3Region.centerY,
            360
        )!
    }

    private static CreateBarrier() {
        let barrierRegion = Regions.BarrierRegion
        let centerX = barrierRegion.centerX
        let minY = barrierRegion.minY
        let maxY = barrierRegion.maxY

        let distanceY: number = maxY - minY
        let intervalY: number = distanceY / 13
        for (let i: number = 1; i < 13; i++) {
            let currentY: number = minY + i * intervalY
            let des = Destructable.create(this.BARRIERID, centerX, currentY)
            if (des) this.destructables.push(des)
        }
    }

    public static ActivateBarrier() {
        if (this.BarrierActive) return
        this.CreateDummyUnits()
        this.CreateBarrier()
        this.BarrierActive = true
    }

    public static DeactivateBarrier() {
        if (!this.BarrierActive) return
        this.DummyUnitOne.destroy()
        this.DummyUnitTwo.destroy()
        this.DummyUnitThree.destroy()
        for (let des of this.destructables) {
            des.destroy()
        }
        this.destructables = []
        this.BarrierActive = false
    }
}

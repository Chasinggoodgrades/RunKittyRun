import { Constants } from 'src/AutoGenerated/Constants'
import { NamedWolves } from 'src/Game/Entities/NamedWolves'
import { Wolf } from 'src/Game/Entities/Wolf'
import { Gamemode } from 'src/Gamemodes/Gamemode'
import { GameMode } from 'src/Gamemodes/GameModeEnum'
import { Globals } from 'src/Global/Globals'
import { GC } from 'src/Utility/GC'
import { Group, Trigger } from 'w3ts'

export class AntiblockWand {
    private static CastEvent: Trigger
    private static AbilityID: number
    private static Radius: number

    /// <summary>
    /// Register's antiblock wand cast's. Only works in standard mode.
    /// </summary>
    public static Initialize() {
        if (Gamemode.CurrentGameMode !== GameMode.Standard) return
        this.AbilityID = Constants.ABILITY_ANTI_BLOCK_WAND_ITEM
        this.Radius = 250.0
        this.CastEvent = this.RegisterCastEvents()
    }

    private static RegisterCastEvents(): Trigger {
        let triggerHandle = Trigger.create()!
        for (let player of Globals.ALL_PLAYERS)
            triggerHandle.registerPlayerUnitEvent(player, EVENT_PLAYER_UNIT_SPELL_CAST, undefined)
        triggerHandle.addAction(this.SpellActions)
        return triggerHandle
    }

    private static SpellActions() {
        if (GetSpellAbilityId() !== this.AbilityID) return
        let wolvesInArea = Group.create()!
        wolvesInArea.enumUnitsInRange(GetSpellTargetX(), GetSpellTargetY(), this.Radius, () => true)
        let list = wolvesInArea.getUnits()
        for (let wolf of list) {
            if (wolf.typeId !== Wolf.WOLF_MODEL) continue
            if (NamedWolves.DNTNamedWolves.includes(Globals.ALL_WOLVES.get(wolf)!)) continue
            let wolfUnit = Globals.ALL_WOLVES.get(wolf)!
            wolfUnit.StartWandering(true)
        }

        GC.RemoveGroup(wolvesInArea) // TODO; Cleanup:         GC.RemoveGroup(ref wolvesInArea);
        GC.RemoveList(list) // TODO; Cleanup:         GC.RemoveList(ref list);
    }
}

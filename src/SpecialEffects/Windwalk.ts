import { Constants } from 'src/AutoGenerated/Constants'
import { Logger } from 'src/Events/Logger/Logger'
import { Kitty } from 'src/Game/Entities/Kitty/Kitty'
import { WolfPoint } from 'src/Game/WolfPoint'
import { CurrentGameMode } from 'src/Gamemodes/CurrentGameMode'
import { GameMode } from 'src/Gamemodes/GameModeEnum'
import { Globals } from 'src/Global/Globals'
import { RewardsManager } from 'src/Rewards/Rewards/RewardsManager'
import { Utility } from 'src/Utility/Utility'
import { getTriggerPlayer, getTriggerUnit } from 'src/Utility/w3tsUtils'
import { MapPlayer, Trigger } from 'w3ts'

export class Windwalk {
    private static Trigger: Trigger
    private static HotkeyTrigger: Trigger
    private static WindwalkID: number = FourCC('BOwk') // Windwalk buff ID
    public static Initialize = () => {
        Windwalk.RegisterHotKey()
        Windwalk.RegisterWWCast()
    }

    private static RegisterWWCast = () => {
        if (CurrentGameMode.active !== GameMode.Standard) return
        Windwalk.Trigger = Trigger.create()!
        for (const player of Globals.ALL_PLAYERS)
            Windwalk.Trigger.registerPlayerUnitEvent(player, EVENT_PLAYER_UNIT_SPELL_CAST, () => true)
        Windwalk.Trigger.addCondition(Condition(() => GetSpellAbilityId() === Constants.ABILITY_WIND_WALK))
        Windwalk.Trigger.addAction(() => Windwalk.ApplyWindwalkEffect())
    }

    private static RegisterHotKey = () => {
        Windwalk.HotkeyTrigger = Trigger.create()!
        for (const p of Globals.ALL_PLAYERS) {
            Windwalk.HotkeyTrigger.registerPlayerKeyEvent(p, OSKEY_NUMPAD0, 0, true)
        }
        Windwalk.HotkeyTrigger.addAction(() => Windwalk.RegisterHotKeyEvents())
    }

    private static RegisterHotKeyEvents = () => {
        const p: MapPlayer = getTriggerPlayer()
        const k: Kitty = Globals.ALL_KITTIES.get(p)!

        if (!k.isAlive()) return // cannot cast if dead obviously.
        if (UnitHasBuffBJ(k.Unit.handle, Windwalk.WindwalkID)) return
        k.Unit.issueImmediateOrder('windwalk')
        k.Unit.issueOrderAt(WolfPoint.MoveOrderID, k.APMTracker.LastX, k.APMTracker.LastY)
    }

    private static ApplyWindwalkEffect = () => {
        const caster = getTriggerUnit()
        const player = caster.owner
        const kitty = Globals.ALL_KITTIES.get(player)!
        const abilityLevel = caster.getAbilityLevel(Constants.ABILITY_WIND_WALK)
        const duration = 3.0 + 2.0 * abilityLevel
        const wwID = kitty.ActiveAwards.WindwalkID
        try {
            // AmuletOfEvasiveness.AmuletWindwalkEffect(caster);
            if (wwID !== 0) {
                const reward = RewardsManager.Rewards.find(r => r.GetAbilityID() === wwID)!
                const visual = reward.ModelPath
                const e = caster.addSpecialEffectTarget(visual, 'origin')
                if (e !== null) {
                    Utility.SimpleTimer(duration, () => {
                        if (e !== null) e.destroy()
                    })
                }
            }
        } catch (e) {
            Logger.Warning(`Error in Windwalk.ApplyWindwalkEffect: ${e}`)
        }
    }
}

import { Constants } from "src/AutoGenerated/Constants"
import { Logger } from "src/Events/Logger/Logger"
import { Kitty } from "src/Game/Entities/Kitty/Kitty"
import { WolfPoint } from "src/Game/WolfPoint"
import { Gamemode } from "src/Gamemodes/Gamemode"
import { GameMode } from "src/Gamemodes/GameModeEnum"
import { Globals } from "src/Global/Globals"
import { RewardsManager } from "src/Rewards/Rewards/RewardsManager"
import { Utility } from "src/Utility/Utility"
import { getTriggerPlayer, getTriggerUnit } from "src/Utility/w3tsUtils"
import { Trigger, MapPlayer } from "w3ts"

export class Windwalk {
    private static Trigger: Trigger
    private static HotkeyTrigger: Trigger
    private static WindwalkID: number = FourCC('BOwk') // Windwalk buff ID
    public static Initialize() {
        this.RegisterHotKey()
        this.RegisterWWCast()
    }

    private static RegisterWWCast() {
        if (Gamemode.CurrentGameMode != GameMode.Standard) return
        this.Trigger = Trigger.create()!
        for (let player of Globals.ALL_PLAYERS)
            this.Trigger.registerPlayerUnitEvent(player, EVENT_PLAYER_UNIT_SPELL_CAST, null)
        this.Trigger.addCondition(Condition(() => GetSpellAbilityId() == Constants.ABILITY_WIND_WALK))
        this.Trigger.addAction(ApplyWindwalkEffect)
    }

    private static RegisterHotKey() {
        this.HotkeyTrigger = Trigger.create()!
        for (let p of Globals.ALL_PLAYERS) {
            this.HotkeyTrigger.registerPlayerKeyEvent(p, oskeytype.NumPad0, 0, true)
        }
        this.HotkeyTrigger.addAction(this.RegisterHotKeyEvents)
    }

    private static RegisterHotKeyEvents() {
        let p: MapPlayer = getTriggerPlayer()
        let k: Kitty = Globals.ALL_KITTIES.get(p)!

        if (!k.isAlive()) return // cannot cast if dead obviously.
        if (UnitHasBuffBJ(k.Unit, WindwalkID)) return
        k.Unit.IssueOrder('windwalk')
        k.Unit.IssueOrder(WolfPoint.MoveOrderID, k.APMTracker.LastX, k.APMTracker.LastY)
    }

    private static ApplyWindwalkEffect() {
        let caster = getTriggerUnit()
        let player = caster.owner
        let kitty = Globals.ALL_KITTIES.get(player)!
        let abilityLevel = caster.getAbilityLevel(Constants.ABILITY_WIND_WALK)
        let duration = 3.0 + 2.0 * abilityLevel
        let wwID = kitty.ActiveAwards.WindwalkID
        try {
            // AmuletOfEvasiveness.AmuletWindwalkEffect(caster);
            if (wwID != 0) {
                let reward = RewardsManager.Rewards.find(r => r.GetAbilityID() == wwID)
                let visual = reward.ModelPath
                let e = caster.AddSpecialEffect(visual, 'origin')
                if (e != null) {
                    Utility.SimpleTimer(duration, () => {
                        if (e != null) DestroyEffect(e)
                    })
                }
            }
        } catch (e: any) {
            Logger.Warning('Error in Windwalk.ApplyWindwalkEffect: {e.Message}')
        }
    }
}
